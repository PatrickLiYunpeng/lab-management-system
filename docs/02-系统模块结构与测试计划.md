# 系统模块结构与测试计划
# System Module Structure & Testing Plan

## 1. 系统模块概览 System Module Overview

```
lab-management-system/
├── backend/                    # 后端服务
│   ├── app/
│   │   ├── api/v1/endpoints/   # API端点 (17个模块)
│   │   ├── models/             # 数据模型 (13个文件, 30+模型/枚举)
│   │   ├── schemas/            # Pydantic验证 (15个模式文件)
│   │   ├── services/           # 业务逻辑层 (6个服务)
│   │   └── core/               # 核心配置 (6个文件)
│   ├── alembic/                # 数据库迁移 (7个版本)
│   └── tests/                  # 单元测试 (11个测试文件)
│
├── frontend/                   # 前端应用
│   └── src/
│       ├── pages/              # 页面组件 (23个页面)
│       ├── components/         # 可复用组件 (17个组件目录)
│       ├── services/           # API客户端 (19个服务)
│       ├── stores/             # 状态管理 (authStore)
│       ├── hooks/              # 自定义Hooks (2个)
│       ├── types/              # TypeScript类型定义
│       ├── utils/              # 工具函数
│       └── layouts/            # 布局组件
│
└── docs/                       # 项目文档
```

---

## 2. 后端模块详情 Backend Module Details

### 2.1 API端点模块 API Endpoint Modules

| 模块 | 文件 | 端点前缀 | 功能描述 |
|------|------|----------|----------|
| 认证 | `auth.py` | `/api/v1/auth` | 登录、注册、令牌管理、密码修改 |
| 用户 | `users.py` | `/api/v1/users` | 用户CRUD、角色管理、密码重置 |
| 站点 | `sites.py` | `/api/v1/sites` | 站点信息管理 |
| 实验室 | `laboratories.py` | `/api/v1/laboratories` | 实验室管理 |
| 人员 | `personnel.py` | `/api/v1/personnel` | 人员信息、技能、借调、甘特图 |
| 设备 | `equipment.py` | `/api/v1/equipment` | 设备管理、调度、容量检查 |
| 技能 | `skills.py` | `/api/v1/skills` | 技能定义、人员技能分配 |
| 工单 | `work_orders.py` | `/api/v1/work-orders` | 工单全生命周期、任务管理 |
| 物料 | `materials.py` | `/api/v1/materials` | 物料追踪、状态管理、历史记录 |
| 客户 | `clients.py` | `/api/v1/clients` | 客户信息、SLA、测试来源类别 |
| 仪表板 | `dashboard.py` | `/api/v1/dashboard` | 统计数据、KPI、历史分析 |
| 交接 | `handovers.py` | `/api/v1/handovers` | 班次交接、任务移交 |
| 方法 | `methods.py` | `/api/v1/methods` | 分析/测试方法、技能要求 |
| 班次 | `shifts.py` | `/api/v1/shifts` | 班次定义、人员排班 |
| 审计 | `audit_logs.py` | `/api/v1/audit-logs` | 操作审计查询 |
| 权限 | `permissions.py` | `/api/v1/permissions` | RBAC权限管理、权限矩阵 |
| 报表 | `reports.py` | `/api/v1/reports` | 数据导出、PDF报表 |

### 2.2 数据模型 Data Models

| 模型 | 文件 | 主要字段 | 关联关系 |
|------|------|----------|----------|
| User | `user.py` | id, username, email, role, password, is_superuser | → Laboratory, Site |
| Site | `site.py` | id, name, code, address, timezone, contact | ← Laboratory, Equipment |
| Laboratory | `laboratory.py` | id, name, code, lab_type, site_id, max_capacity | → Site, ← Equipment, Personnel |
| Personnel | `personnel.py` | id, employee_id, user_id, status, job_title | → User, Laboratory, Site |
| StaffBorrowRequest | `personnel.py` | id, personnel_id, from/to_laboratory_id, dates | → Personnel, Laboratory |
| Equipment | `equipment.py` | id, name, code, type, category, status, capacity | → Laboratory, Site |
| EquipmentSchedule | `equipment.py` | id, equipment_id, task_id, start/end_time | → Equipment, Task |
| Skill | `skill.py` | id, name, code, category, requires_certification | ← PersonnelSkill |
| PersonnelSkill | `skill.py` | id, personnel_id, skill_id, proficiency_level | → Personnel, Skill |
| WorkOrder | `work_order.py` | id, order_number, title, status, priority | → Laboratory, Client |
| WorkOrderTask | `work_order.py` | id, task_number, status, method_id | → WorkOrder, Equipment, Method |
| Material | `material.py` | id, material_code, name, status, quantity | → Laboratory, Client, WorkOrder |
| Client | `material.py` | id, name, code, default_sla_days, priority | ← WorkOrder, Material, ClientSLA |
| ClientSLA | `material.py` | id, client_id, service_type, commitment_hours | → Client, Laboratory |
| TestingSourceCategory | `material.py` | id, name, code, priority_weight | - |
| AuditLog | `audit_log.py` | id, action, entity_type, entity_id, user_id | → User |
| RolePermission | `permission.py` | id, role, permission_code, is_allowed | - |
| Handover | `handover.py` | id, task_id, from/to_technician_id, status | → Task, Personnel |
| Method | `method.py` | id, name, code, method_type, standard_cycle_hours | → Laboratory, Equipment |
| Shift | `shift.py` | id, name, code, start/end_time, laboratory_id | → Laboratory |
| PersonnelShift | `shift.py` | id, personnel_id, shift_id, effective_date | → Personnel, Shift |

---

## 3. 前端模块详情 Frontend Module Details

### 3.1 页面组件 Page Components (23个)

| 类别 | 页面 | 文件 | Ant Design组件使用 |
|------|------|------|-------------------|
| **认证** | 登录 | `LoginPage.tsx` | Form, Input, Button, Checkbox, message |
| **仪表板** | 综合仪表板 | `DashboardPage.tsx` | Card, Statistic, Progress, Select, DatePicker, Table, Spin |
| | 设备仪表板 | `EquipmentDashboard.tsx` | Card, Tabs, Progress, Segmented, Tooltip |
| | 人员仪表板 | `PersonnelDashboard.tsx` | Card, Tabs, Progress, Tooltip |
| **基础数据** | 站点管理 | `SitesPage.tsx` | Table, Modal, Form, Button, Input, Space |
| | 实验室管理 | `LaboratoriesPage.tsx` | Table, Modal, Form, Select, Tag |
| | 人员管理 | `PersonnelPage.tsx` | Table, Modal, Form, Select, Tag, Tabs |
| | 设备管理 | `EquipmentPage.tsx` | Table, Modal, Form, Select, DatePicker, Tag |
| | 技能矩阵 | `SkillsMatrix.tsx` | Table, Tag, Progress, Select |
| | 技能配置 | `SkillsConfig.tsx` | Table, Modal, Form, Select, Switch |
| | 班次管理 | `ShiftsPage.tsx` | Table, Modal, Form, TimePicker, Tabs |
| | 人员借调 | `Transfers.tsx` | Table, Modal, Form, DatePicker, Tag |
| **业务流程** | 工单管理 | `WorkOrdersPage.tsx` | Table, Modal, Form, Select, Progress, Tag, Dropdown, Tabs |
| | 工单查询 | `WorkOrderQueryPage.tsx` | Table, Select, DatePicker, Tag, Card, Descriptions |
| | 物料管理 | `MaterialsPage.tsx` | Table, Modal, Form, Select, Tag, DatePicker |
| | 任务交接 | `HandoversPage.tsx` | Table, Timeline, Modal, Tag |
| | 分析方法 | `MethodsPage.tsx` | Table, Modal, Form, Select, InputNumber |
| **客户管理** | 客户列表 | `ClientsPage.tsx` | Table, Modal, Form, Input |
| | 客户SLA | `ClientSLAsPage.tsx` | Table, Modal, Form, InputNumber, Select |
| | 测试来源 | `TestingSourceCategoriesPage.tsx` | Table, Modal, Form, ColorPicker |
| **系统管理** | 用户管理 | `UserManagementPage.tsx` | Table, Modal, Form, Select, Tag, Popconfirm |
| | 审计日志 | `AuditLogsPage.tsx` | Table, DatePicker, Select, Tag, Descriptions |
| | 系统设置 | `SettingsPage.tsx` | Tabs, Descriptions, Form, Switch, Table |

### 3.2 模态框组件 Modal Components (17个)

| 组件 | 文件路径 | 复杂度 | 特殊功能 |
|------|----------|--------|----------|
| EquipmentModal | `components/equipment/` | 高 | 4分区表单, 级联选择, 维护/校准日期 |
| EquipmentScheduler | `components/equipment/` | 高 | 设备调度日历视图 |
| TaskModal | `components/work-orders/` | 高 | 异步验证, 容量检查, 方法选择 |
| WorkOrderModal | `components/work-orders/` | 高 | 多步骤表单, 客户SLA关联 |
| SubTaskManager | `components/work-orders/` | 中 | 子任务拖拽排序 |
| TechnicianMatcher | `components/work-orders/` | 中 | 技能匹配算法展示 |
| PersonnelModal | `components/personnel/` | 中 | 用户关联, 实验室分配 |
| MaterialModal | `components/materials/` | 中 | 状态流转, 客户关联 |
| UserModal | `components/users/` | 中 | 角色分配, 实验室权限 |
| PasswordResetModal | `components/users/` | 低 | 密码强度验证 |
| TransferModal | `components/transfers/` | 中 | 日期范围, 审批流程 |
| ApprovalModal | `components/transfers/` | 低 | 借调审批 |
| ShiftModal | `components/shifts/` | 中 | 时间选择器 |
| PersonnelShiftModal | `components/shifts/` | 中 | 人员排班 |
| SiteModal | `components/sites/` | 低 | 基础CRUD |
| LaboratoryModal | `components/laboratories/` | 中 | 站点级联选择 |
| ClientModal | `components/clients/` | 低 | 基础CRUD |
| MethodModal | `components/methods/` | 中 | 技能要求配置 |
| SkillModal | `components/skills/` | 低 | 基础CRUD |
| PersonnelSkillModal | `components/skills/` | 中 | 熟练度等级, 认证管理 |
| HandoverModal | `components/handovers/` | 中 | 状态流转, 备注管理 |
| HandoverPanel | `components/handovers/` | 中 | 交接详情展示 |
| PermissionMatrix | `components/settings/` | 高 | 权限矩阵编辑 |

### 3.3 公共组件 Common Components

| 组件 | 文件路径 | 功能 |
|------|----------|------|
| ProtectedRoute | `components/` | 路由保护, 认证检查 |
| PermissionGuard | `components/` | 权限守卫, 角色检查 |
| StatusTag | `components/common/` | 状态标签渲染 |
| SkillBadge | `components/common/` | 技能徽章显示 |

### 3.4 服务层 Services (19个)

| 服务 | 文件 | 功能 |
|------|------|------|
| api | `api.ts` | Axios实例, 拦截器, 认证处理 |
| auditLogService | `auditLogService.ts` | 审计日志查询 |
| clientService | `clientService.ts` | 客户CRUD |
| clientSlaService | `clientSlaService.ts` | 客户SLA管理 |
| dashboardService | `dashboardService.ts` | 仪表板数据, 甘特图 |
| equipmentService | `equipmentService.ts` | 设备管理, 调度, 容量 |
| handoverService | `handoverService.ts` | 任务交接 |
| laboratoryService | `laboratoryService.ts` | 实验室管理 |
| materialService | `materialService.ts` | 物料管理 |
| methodService | `methodService.ts` | 分析方法 |
| permissionService | `permissionService.ts` | 权限管理 |
| personnelService | `personnelService.ts` | 人员管理, 借调 |
| reportService | `reportService.ts` | 报表导出 |
| shiftService | `shiftService.ts` | 班次管理 |
| siteService | `siteService.ts` | 站点管理 |
| skillService | `skillService.ts` | 技能管理 |
| transferService | `transferService.ts` | 借调请求 |
| userService | `userService.ts` | 用户管理 |
| workOrderService | `workOrderService.ts` | 工单和任务管理 |

---

## 4. 测试计划 Testing Plan

### 4.1 后端单元测试 Backend Unit Tests

**测试文件结构:**
```
backend/tests/
├── conftest.py              # 测试配置和fixtures
├── test_auth.py             # 认证测试
├── test_clients_reports.py  # 客户和报表测试
├── test_dashboard.py        # 仪表板测试
├── test_equipment.py        # 设备测试
├── test_handovers_methods_shifts.py  # 交接/方法/班次测试
├── test_laboratories.py     # 实验室测试
├── test_materials.py        # 物料测试
├── test_personnel.py        # 人员测试
├── test_sites.py            # 站点测试
├── test_skills.py           # 技能测试
└── test_work_orders.py      # 工单测试

总计: 11 个测试文件
```

**测试覆盖范围:**

| 模块 | 测试类 | 测试内容 |
|------|--------|----------|
| Auth | TestAuthLogin | 登录成功/失败, 凭据验证 |
| | TestAuthToken | OAuth2令牌获取 |
| | TestAuthRegister | 用户注册, 重复检查 |
| | TestAuthMe | 当前用户信息 |
| | TestAuthUpdateMe | 用户信息更新 |
| | TestPasswordChange | 密码修改 |
| Sites | TestSitesCRUD | 创建/读取/更新/删除 |
| | TestSitesFiltering | 过滤和分页 |
| Labs | TestLaboratoriesCRUD | 创建/读取/更新/删除 |
| | TestLabFiltering | 类型过滤 |
| Personnel | TestPersonnelCRUD | 创建/读取/更新/删除 |
| | TestPersonnelSkills | 技能分配 |
| | TestBorrowRequests | 借调流程 |
| Equipment | TestEquipmentCRUD | 创建/读取/更新/删除 |
| | TestEquipmentSchedule | 调度管理 |
| | TestMaintenance | 维护记录 |
| WorkOrders | TestWorkOrderCRUD | 创建/读取/更新/删除 |
| | TestTaskManagement | 任务创建和状态 |
| | TestStatusTransitions | 状态流转 |
| Materials | TestMaterialCRUD | 创建/读取/更新/删除 |
| | TestMaterialStatus | 状态变更 |
| | TestMaterialHistory | 历史追踪 |
| Dashboard | TestSummary | 汇总统计 |
| | TestEquipmentUtil | 设备利用率 |
| | TestSLAPerformance | SLA达成率 |

**运行测试:**
```bash
cd backend
python -m pytest                    # 运行所有测试
python -m pytest -v                 # 详细输出
python -m pytest tests/test_auth.py # 运行特定文件
python -m pytest --cov=app          # 覆盖率报告
```

### 4.2 前端E2E测试 Frontend E2E Tests

**测试配置:** Playwright

**测试用例规划:**

| 测试场景 | 测试步骤 | 预期结果 |
|----------|----------|----------|
| **登录流程** | | |
| 成功登录 | 输入有效凭据 → 点击登录 | 跳转到仪表板 |
| 失败登录 | 输入无效凭据 → 点击登录 | 显示错误消息 |
| 角色重定向 | Viewer角色登录 | 跳转到工单查询页 |
| **页面导航** | | |
| 菜单导航 | 点击侧边栏菜单项 | 正确加载页面 |
| 权限控制 | Viewer访问仪表板 | 显示403或重定向 |
| **数据操作** | | |
| 创建站点 | 填写表单 → 提交 | 列表显示新站点 |
| 编辑设备 | 修改信息 → 保存 | 显示更新成功 |
| 删除记录 | 确认删除 | 记录从列表移除 |
| **表格功能** | | |
| 排序 | 点击列头 | 数据正确排序 |
| 筛选 | 设置筛选条件 | 显示匹配记录 |
| 分页 | 点击页码 | 加载对应页数据 |

**运行E2E测试:**
```bash
cd frontend
npm run test:e2e            # 运行所有E2E测试
npm run test:e2e:ui         # 打开UI模式
npm run test:e2e:report     # 查看报告
```

### 4.3 性能测试 Performance Tests

**测试工具:** Locust (后端), Lighthouse (前端)

**后端性能指标:**

| 端点 | 目标响应时间 | 并发目标 |
|------|-------------|----------|
| GET /api/v1/dashboard/summary | < 200ms | 100 users |
| GET /api/v1/work-orders | < 300ms | 50 users |
| POST /api/v1/auth/login | < 150ms | 200 users |
| GET /api/v1/equipment | < 200ms | 100 users |

**前端性能指标:**

| 指标 | 目标值 |
|------|--------|
| First Contentful Paint (FCP) | < 1.5s |
| Largest Contentful Paint (LCP) | < 2.5s |
| Time to Interactive (TTI) | < 3.0s |
| Total Blocking Time (TBT) | < 200ms |
| Cumulative Layout Shift (CLS) | < 0.1 |

### 4.4 安全测试 Security Tests

**测试清单:**

| 测试项 | 方法 | 状态 |
|--------|------|------|
| SQL注入 | SQLAlchemy参数化查询 | ✅ 已防护 |
| XSS攻击 | React自动转义 | ✅ 已防护 |
| CSRF攻击 | JWT Token验证 | ✅ 已防护 |
| 认证绕过 | JWT签名验证 | ✅ 已防护 |
| 密码安全 | bcrypt哈希 | ✅ 已实现 |
| 依赖漏洞 | pip audit / npm audit | ⏳ 定期扫描 |
| 敏感数据泄露 | 日志脱敏 | ✅ 已实现 |
| 速率限制 | slowapi | ✅ 已实现 |

---

## 5. 测试执行时间表 Test Execution Schedule

| 阶段 | 测试类型 | 执行频率 | 负责人 |
|------|----------|----------|--------|
| 开发 | 单元测试 | 每次提交 | 开发者 |
| 开发 | Lint检查 | 每次提交 | 开发者 |
| 集成 | API测试 | 每日构建 | CI/CD |
| 发布前 | E2E测试 | 发布前 | QA |
| 发布前 | 性能测试 | 发布前 | DevOps |
| 发布前 | 安全扫描 | 发布前 | DevOps |

---

## 6. 测试环境 Test Environments

| 环境 | 数据库 | URL | 用途 |
|------|--------|-----|------|
| 开发 | SQLite | localhost:5173/8000 | 本地开发 |
| 测试 | SQLite (内存) | - | 单元测试 |
| 预发布 | MySQL | staging.example.com | 集成测试 |
| 生产 | MySQL | production.example.com | 生产部署 |

---

## 7. 测试数据 Test Data

### 种子数据 Seed Data

**执行脚本:** `backend/scripts/seed_data.py`

**数据内容:**

| 实体 | 数量 | 说明 |
|------|------|------|
| Sites | 3 | 深圳、上海、北京 |
| Laboratories | 6 | 每站点2个(FA+可靠性) |
| Users | 15 | 各角色测试账号 |
| Personnel | 20 | 关联用户 |
| Equipment | 30 | 各类型设备 |
| Skills | 25 | 技能定义 |
| Clients | 10 | 测试客户 |
| WorkOrders | 50 | 各状态工单 |
| Materials | 100 | 物料记录 |

**重置数据库:**
```bash
cd backend
rm lab_management.db
alembic upgrade head
python scripts/seed_data.py
```

---

## 8. 文档更新记录 Document History

| 日期 | 版本 | 更新内容 |
|------|------|----------|
| 2026-02-01 | v1.0 | 初始版本 |
| 2026-02-04 | v1.1 | 根据实际代码更新模块数量、API端点、数据模型、组件列表 |
