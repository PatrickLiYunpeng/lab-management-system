import{a6 as l,r as a,a7 as $,P as e,V as z,W as o,a8 as d,O as F,a9 as D,Q as L,aa as H,S as Q,a4 as ae,ab as se}from"./index-DVAH8G0d.js";import{s as E}from"./siteService-Bv2y8QeO.js";import{M as J}from"./index-D5-92eMw.js";import{S as R,F as U}from"./Table-BH_IQYSB.js";import{S as Y}from"./index-C-m9zxKZ.js";import{S as G}from"./StatusTag-CYqPBP0F.js";import{R as W}from"./EditOutlined-BO1KRQYy.js";import{P as X}from"./index-BDasguwL.js";import{R as Z}from"./DeleteOutlined-DADLfnzs.js";import{l as V}from"./laboratoryService-B77Lyyfa.js";import{T as le}from"./index-fw1Ls6Om.js";import{R as ne}from"./ExperimentOutlined-DmOxbO1D.js";import"./CheckOutlined-CP9fMx1j.js";const ie=[{label:"UTC",value:"UTC"},{label:"Asia/Shanghai (中国)",value:"Asia/Shanghai"},{label:"Asia/Taipei (台湾)",value:"Asia/Taipei"},{label:"Asia/Tokyo (日本)",value:"Asia/Tokyo"},{label:"Asia/Singapore (新加坡)",value:"Asia/Singapore"},{label:"America/New_York (美东)",value:"America/New_York"},{label:"America/Los_Angeles (美西)",value:"America/Los_Angeles"},{label:"Europe/London (伦敦)",value:"Europe/London"},{label:"Europe/Berlin (柏林)",value:"Europe/Berlin"}];function re({visible:m,site:n,onSuccess:g,onCancel:S}){const[p]=l.useForm(),[r,w]=a.useState(!1),{message:u}=$.useApp();a.useEffect(()=>{m&&(n?p.setFieldsValue(n):(p.resetFields(),p.setFieldsValue({is_active:!0,timezone:"Asia/Shanghai"})))},[m,n,p]);const c=async()=>{try{const y=await p.validateFields();w(!0),n?(await E.updateSite(n.id,y),u.success("更新成功")):(await E.createSite(y),u.success("创建成功")),g()}catch{u.error(n?"更新失败":"创建失败")}finally{w(!1)}};return e.jsx(J,{title:n?"编辑站点":"新增站点",open:m,onOk:c,onCancel:S,confirmLoading:r,width:700,okText:"确定",cancelText:"取消",destroyOnHidden:!0,children:e.jsxs(l,{form:p,layout:"vertical",children:[e.jsxs(z,{gutter:16,children:[e.jsx(o,{span:12,children:e.jsx(l.Item,{name:"name",label:"站点名称",rules:[{required:!0,message:"请输入站点名称"}],children:e.jsx(d,{placeholder:"请输入站点名称"})})}),e.jsx(o,{span:12,children:e.jsx(l.Item,{name:"code",label:"站点代码",rules:[{required:!0,message:"请输入站点代码"}],children:e.jsx(d,{placeholder:"请输入站点代码"})})})]}),e.jsx(l.Item,{name:"address",label:"地址",children:e.jsx(d,{placeholder:"请输入地址"})}),e.jsxs(z,{gutter:16,children:[e.jsx(o,{span:8,children:e.jsx(l.Item,{name:"city",label:"城市",children:e.jsx(d,{placeholder:"请输入城市"})})}),e.jsx(o,{span:8,children:e.jsx(l.Item,{name:"country",label:"国家",children:e.jsx(d,{placeholder:"请输入国家"})})}),e.jsx(o,{span:8,children:e.jsx(l.Item,{name:"timezone",label:"时区",rules:[{required:!0,message:"请选择时区"}],children:e.jsx(R,{options:ie,placeholder:"请选择时区"})})})]}),e.jsxs(z,{gutter:16,children:[e.jsx(o,{span:8,children:e.jsx(l.Item,{name:"contact_name",label:"联系人姓名",children:e.jsx(d,{placeholder:"请输入联系人姓名"})})}),e.jsx(o,{span:8,children:e.jsx(l.Item,{name:"contact_email",label:"联系人邮箱",rules:[{pattern:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,message:"请输入有效的邮箱地址"}],children:e.jsx(d,{placeholder:"请输入联系人邮箱"})})}),e.jsx(o,{span:8,children:e.jsx(l.Item,{name:"contact_phone",label:"联系电话",children:e.jsx(d,{placeholder:"请输入联系电话"})})})]}),e.jsx(l.Item,{name:"is_active",label:"状态",valuePropName:"checked",children:e.jsx(Y,{checkedChildren:"启用",unCheckedChildren:"停用"})})]})})}function ce(){const[m,n]=a.useState([]),[g,S]=a.useState(!1),[p,r]=a.useState(!1),[w,u]=a.useState(null),[c,y]=a.useState({current:1,pageSize:10,total:0}),[x,C]=a.useState(""),[j,M]=a.useState(""),{message:h}=$.useApp(),_=a.useRef(!1),f=a.useCallback(async(s=1,b=10,O="")=>{S(!0);try{const v=await E.getSites({page:s,page_size:b,search:O||void 0});n(v.items),y({current:v.page,pageSize:v.page_size,total:v.total}),_.current=!1}catch(v){F(v)||_.current||(_.current=!0,h.error("获取站点列表失败"))}finally{S(!1)}},[h]);a.useEffect(()=>{f()},[f]),a.useEffect(()=>{const s=setTimeout(()=>{j!==x&&(C(j),f(1,c.pageSize,j))},300);return()=>clearTimeout(s)},[j,x,c.pageSize,f]);const q=s=>{f(s.current,s.pageSize,x)},I=()=>{u(null),r(!0)},k=s=>{u(s),r(!0)},A=async s=>{try{await E.deleteSite(s),h.success("删除成功"),f(c.current,c.pageSize,x)}catch(b){F(b)||h.error("删除失败")}},P=()=>{r(!1),u(null),f(c.current,c.pageSize,x)},B=()=>{r(!1),u(null)},N=[{title:"站点名称",dataIndex:"name",key:"name",width:180},{title:"站点代码",dataIndex:"code",key:"code",width:120},{title:"城市",dataIndex:"city",key:"city",width:120,render:s=>s||"-"},{title:"联系人",dataIndex:"contact_name",key:"contact_name",width:120,render:s=>s||"-"},{title:"时区",dataIndex:"timezone",key:"timezone",width:150},{title:"状态",dataIndex:"is_active",key:"is_active",width:80,render:s=>e.jsx(G,{isActive:s})},{title:"操作",key:"action",width:150,render:(s,b)=>e.jsxs(Q,{children:[e.jsx(L,{type:"link",size:"small",icon:e.jsx(W,{}),onClick:()=>k(b),children:"编辑"}),e.jsx(X,{title:"确认删除",description:`确定要删除站点 "${b.name}" 吗？`,onConfirm:()=>A(b.id),okText:"确定",cancelText:"取消",okButtonProps:{danger:!0},children:e.jsx(L,{type:"link",size:"small",danger:!0,icon:e.jsx(Z,{}),children:"删除"})})]})}];return e.jsxs("div",{"data-testid":"sites-page",children:[e.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between"},children:[e.jsx(d,{placeholder:"搜索站点名称或代码",prefix:e.jsx(D,{}),value:j,onChange:s=>M(s.target.value),style:{width:300},allowClear:!0,"data-testid":"sites-search-input"}),e.jsx(L,{type:"primary",icon:e.jsx(H,{}),onClick:I,"data-testid":"sites-add-button",children:"新增站点"})]}),e.jsx(U,{columns:N,dataSource:m,rowKey:"id",loading:g,pagination:{...c,showSizeChanger:!0,showQuickJumper:!0,showTotal:s=>`共 ${s} 条`},onChange:q,"data-testid":"sites-table"}),e.jsx(re,{visible:p,site:w,onSuccess:P,onCancel:B})]})}const{TextArea:oe}=d;function de({visible:m,laboratory:n,sites:g,onSuccess:S,onCancel:p}){const[r]=l.useForm(),[w,u]=a.useState(!1),{message:c}=$.useApp();a.useEffect(()=>{m&&(n?r.setFieldsValue(n):(r.resetFields(),r.setFieldsValue({is_active:!0})))},[m,n,r]);const y=async()=>{try{const x=await r.validateFields();u(!0),n?(await V.updateLaboratory(n.id,x),c.success("更新成功")):(await V.createLaboratory(x),c.success("创建成功")),S()}catch{c.error(n?"更新失败":"创建失败")}finally{u(!1)}};return e.jsx(J,{title:n?"编辑实验室":"新增实验室",open:m,onOk:y,onCancel:p,confirmLoading:w,width:700,okText:"确定",cancelText:"取消",destroyOnHidden:!0,children:e.jsxs(l,{form:r,layout:"vertical",children:[e.jsxs(z,{gutter:16,children:[e.jsx(o,{span:12,children:e.jsx(l.Item,{name:"name",label:"实验室名称",rules:[{required:!0,message:"请输入实验室名称"}],children:e.jsx(d,{placeholder:"请输入实验室名称"})})}),e.jsx(o,{span:12,children:e.jsx(l.Item,{name:"code",label:"实验室代码",rules:[{required:!0,message:"请输入实验室代码"}],children:e.jsx(d,{placeholder:"请输入实验室代码"})})})]}),e.jsxs(z,{gutter:16,children:[e.jsx(o,{span:12,children:e.jsx(l.Item,{name:"lab_type",label:"实验室类型",rules:[{required:!0,message:"请选择实验室类型"}],children:e.jsx(R,{placeholder:"请选择实验室类型",options:[{label:"FA (失效分析)",value:"fa"},{label:"可靠性测试",value:"reliability"}]})})}),e.jsx(o,{span:12,children:e.jsx(l.Item,{name:"site_id",label:"所属站点",rules:[{required:!0,message:"请选择所属站点"}],children:e.jsx(R,{placeholder:"请选择所属站点",options:g.map(x=>({label:x.name,value:x.id})),showSearch:!0,optionFilterProp:"label"})})})]}),e.jsx(l.Item,{name:"description",label:"描述",children:e.jsx(oe,{rows:3,placeholder:"请输入实验室描述"})}),e.jsxs(z,{gutter:16,children:[e.jsx(o,{span:8,children:e.jsx(l.Item,{name:"max_capacity",label:"最大容量",children:e.jsx(le,{min:1,placeholder:"请输入",style:{width:"100%"}})})}),e.jsx(o,{span:8,children:e.jsx(l.Item,{name:"manager_name",label:"负责人姓名",children:e.jsx(d,{placeholder:"请输入负责人姓名"})})}),e.jsx(o,{span:8,children:e.jsx(l.Item,{name:"manager_email",label:"负责人邮箱",rules:[{pattern:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,message:"请输入有效的邮箱地址"}],children:e.jsx(d,{placeholder:"请输入负责人邮箱"})})})]}),e.jsx(l.Item,{name:"is_active",label:"状态",valuePropName:"checked",children:e.jsx(Y,{checkedChildren:"启用",unCheckedChildren:"停用"})})]})})}const ue={fa:"FA (失效分析)",reliability:"可靠性测试"};function he(){const[m,n]=a.useState([]),[g,S]=a.useState([]),[p,r]=a.useState(!1),[w,u]=a.useState(!1),[c,y]=a.useState(!1),[x,C]=a.useState(null),[j,M]=a.useState({current:1,pageSize:10,total:0}),[h,_]=a.useState({search:""}),[f,q]=a.useState(""),{message:I}=$.useApp(),k=a.useRef(null),A=a.useCallback(async(t=1,i=10,K)=>{u(!0);try{const T=await V.getLaboratories({page:t,page_size:i,search:h.search||void 0,site_id:h.site_id,lab_type:h.lab_type,signal:K});n(T.items),M({current:T.page,pageSize:T.page_size,total:T.total})}catch(T){F(T)||I.error("获取实验室列表失败")}finally{u(!1)}},[h,I]),P=a.useCallback(async()=>{r(!0);try{const t=await E.getAllSites();S(t)}catch(t){F(t)||console.error("Failed to fetch sites")}finally{r(!1)}},[]);a.useEffect(()=>{P()},[P]),a.useEffect(()=>{k.current&&k.current.abort();const t=new AbortController;return k.current=t,A(j.current,j.pageSize,t.signal),()=>{t.abort()}},[h]),a.useEffect(()=>{const t=setTimeout(()=>{f!==h.search&&_(i=>({...i,search:f}))},300);return()=>clearTimeout(t)},[f,h.search]);const B=t=>{k.current&&k.current.abort();const i=new AbortController;k.current=i,A(t.current,t.pageSize,i.signal)},N=()=>{C(null),y(!0)},s=t=>{C(t),y(!0)},b=async t=>{try{await V.deleteLaboratory(t),I.success("删除成功"),A(j.current,j.pageSize)}catch(i){F(i)||I.error("删除失败")}},O=()=>{y(!1),C(null),A(j.current,j.pageSize)},v=()=>{y(!1),C(null)},ee=t=>g.find(K=>K.id===t)?.name||"-",te=[{title:"实验室名称",dataIndex:"name",key:"name",width:180},{title:"代码",dataIndex:"code",key:"code",width:100},{title:"类型",dataIndex:"lab_type",key:"lab_type",width:130,render:t=>ue[t]||t},{title:"所属站点",dataIndex:"site_id",key:"site_id",width:150,render:(t,i)=>i.site?.name||ee(t)},{title:"容量",dataIndex:"max_capacity",key:"max_capacity",width:80,render:t=>t||"-"},{title:"负责人",dataIndex:"manager_name",key:"manager_name",width:100,render:t=>t||"-"},{title:"状态",dataIndex:"is_active",key:"is_active",width:80,render:t=>e.jsx(G,{isActive:t})},{title:"操作",key:"action",width:150,render:(t,i)=>e.jsxs(Q,{children:[e.jsx(L,{type:"link",size:"small",icon:e.jsx(W,{}),onClick:()=>s(i),children:"编辑"}),e.jsx(X,{title:"确认删除",description:`确定要删除实验室 "${i.name}" 吗？`,onConfirm:()=>b(i.id),okText:"确定",cancelText:"取消",okButtonProps:{danger:!0},children:e.jsx(L,{type:"link",size:"small",danger:!0,icon:e.jsx(Z,{}),children:"删除"})})]})}];return e.jsxs("div",{children:[e.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between"},children:[e.jsxs(Q,{children:[e.jsx(d,{placeholder:"搜索实验室名称或代码",prefix:e.jsx(D,{}),value:f,onChange:t=>q(t.target.value),style:{width:250},allowClear:!0}),e.jsx(R,{placeholder:"所属站点",value:h.site_id,onChange:t=>_(i=>({...i,site_id:t})),style:{width:180},allowClear:!0,loading:p,options:g.map(t=>({label:t.name,value:t.id}))}),e.jsx(R,{placeholder:"实验室类型",value:h.lab_type,onChange:t=>_(i=>({...i,lab_type:t})),style:{width:150},allowClear:!0,options:[{label:"FA (失效分析)",value:"fa"},{label:"可靠性测试",value:"reliability"}]})]}),e.jsx(L,{type:"primary",icon:e.jsx(H,{}),onClick:N,children:"新增实验室"})]}),e.jsx(U,{columns:te,dataSource:m,rowKey:"id",loading:w,pagination:{...j,showSizeChanger:!0,showQuickJumper:!0,showTotal:t=>`共 ${t} 条`},onChange:B}),e.jsx(de,{visible:c,laboratory:x,sites:g,sitesLoading:p,onSuccess:O,onCancel:v})]})}function Ce(){const[m,n]=a.useState("sites"),g=[{key:"sites",label:e.jsxs("span",{children:[e.jsx(se,{}),"站点管理"]}),children:e.jsx(ce,{})},{key:"laboratories",label:e.jsxs("span",{children:[e.jsx(ne,{}),"实验室管理"]}),children:e.jsx(he,{})}];return e.jsx(ae,{activeKey:m,onChange:n,items:g,size:"large",style:{marginTop:-16}})}export{Ce as default};
