import{a6 as i,r as s,a7 as Q,P as e,V as I,W as d,a8 as E,O as A,X as ae,a4 as se,S as V,a9 as le,Q as T,aa as re,a0 as B,A as ie}from"./index-DVAH8G0d.js";import{m as F}from"./methodService-CwVcuzKD.js";import{l as W}from"./laboratoryService-B77Lyyfa.js";import{e as ne}from"./equipmentService-ABHB664f.js";import{M as oe}from"./index-D5-92eMw.js";import{S as x,F as ce}from"./Table-BH_IQYSB.js";import{S as N}from"./index-C-m9zxKZ.js";import{T as P}from"./index-fw1Ls6Om.js";import{R as de}from"./ReloadOutlined-Ci7PDsnU.js";import{R as ue}from"./EditOutlined-BO1KRQYy.js";import{P as he}from"./index-BDasguwL.js";import{R as me}from"./DeleteOutlined-DADLfnzs.js";import"./CheckOutlined-CP9fMx1j.js";const{TextArea:D}=E,pe=[{label:"分析方法 (FA)",value:"analysis"},{label:"可靠性测试方法",value:"reliability"}],ye=[{label:"电学分析",value:"electrical"},{label:"物理分析",value:"physical"},{label:"化学分析",value:"chemical"},{label:"光学分析",value:"optical"},{label:"热分析",value:"thermal"},{label:"机械测试",value:"mechanical"},{label:"环境测试",value:"environmental"},{label:"寿命测试",value:"lifetime"},{label:"其他",value:"other"}];function xe({visible:f,method:n,defaultMethodType:p,onSuccess:k,onCancel:L}){const[o]=i.useForm(),[g,m]=s.useState(!1),[_,R]=s.useState([]),[v,w]=s.useState([]),[r,u]=s.useState(null),[q,C]=s.useState(!0),{message:h}=Q.useApp();s.useEffect(()=>{(async()=>{try{const c=await W.getLaboratories({page:1,page_size:100});R(c.items)}catch{h.error("加载实验室列表失败")}})()},[h]),s.useEffect(()=>{(async()=>{if(r)try{const c=await ne.getEquipment({laboratory_id:r,page:1,page_size:100});w(c.items)}catch{h.error("加载设备列表失败")}else w([])})()},[r,h]),s.useEffect(()=>{f&&(n?(o.setFieldsValue({...n,category:n.category||void 0}),u(n.laboratory_id||null),C(n.requires_equipment)):(o.resetFields(),o.setFieldsValue({requires_equipment:!0,is_active:!0,method_type:p}),u(null),C(!0)))},[f,n,o,p]);const b=async()=>{try{const l=await o.validateFields();m(!0);const c={...l,category:l.category||null,laboratory_id:l.laboratory_id||null,default_equipment_id:l.default_equipment_id||null};n?(await F.updateMethod(n.id,c),h.success("方法更新成功")):(await F.createMethod(c),h.success("方法创建成功")),k()}catch{h.error(n?"更新失败":"创建失败")}finally{m(!1)}},M=l=>{u(l||null),o.setFieldValue("default_equipment_id",void 0)},j=l=>{C(l),o.setFieldValue("requires_equipment",l),l||o.setFieldValue("default_equipment_id",void 0)},y=()=>n?"编辑分析/测试方法":p==="analysis"?"新增分析方法":p==="reliability"?"新增可靠性测试方法":"新增分析/测试方法";return e.jsx(oe,{title:y(),open:f,onOk:b,onCancel:L,confirmLoading:g,width:800,okText:"确定",cancelText:"取消",destroyOnHidden:!0,children:e.jsxs(i,{form:o,layout:"vertical",children:[e.jsxs(I,{gutter:16,children:[e.jsx(d,{span:12,children:e.jsx(i.Item,{name:"name",label:"方法名称",rules:[{required:!0,message:"请输入方法名称"}],children:e.jsx(E,{placeholder:"请输入方法名称"})})}),e.jsx(d,{span:6,children:e.jsx(i.Item,{name:"code",label:"方法代码",rules:[{required:!0,message:"请输入方法代码"}],children:e.jsx(E,{placeholder:"如: XRF-001",disabled:!!n})})}),e.jsx(d,{span:6,children:e.jsx(i.Item,{name:"method_type",label:"方法类型",rules:[{required:!0,message:"请选择方法类型"}],children:e.jsx(x,{options:pe,placeholder:"请选择",disabled:!!n||!!p})})})]}),e.jsxs(I,{gutter:16,children:[e.jsx(d,{span:8,children:e.jsx(i.Item,{name:"category",label:"方法类别",children:e.jsx(x,{options:ye,placeholder:"请选择类别",allowClear:!0})})}),e.jsx(d,{span:8,children:e.jsx(i.Item,{name:"laboratory_id",label:"所属实验室",children:e.jsx(x,{placeholder:"请选择实验室",allowClear:!0,onChange:M,options:_.map(l=>({label:`${l.name} (${l.code})`,value:l.id}))})})}),e.jsx(d,{span:8,children:e.jsx(i.Item,{name:"is_active",label:"状态",valuePropName:"checked",children:e.jsx(N,{checkedChildren:"启用",unCheckedChildren:"停用"})})})]}),e.jsx(i.Item,{name:"description",label:"方法描述",children:e.jsx(D,{rows:2,placeholder:"请输入方法描述"})}),e.jsx(i.Item,{name:"procedure_summary",label:"操作流程摘要",children:e.jsx(D,{rows:3,placeholder:"请简要描述操作流程"})}),e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"周期时间设置"})}),e.jsxs(I,{gutter:16,children:[e.jsx(d,{span:8,children:e.jsx(i.Item,{name:"standard_cycle_hours",label:"预计周期(小时)",children:e.jsx(P,{min:.1,max:1e3,step:.5,placeholder:"标准时间",style:{width:"100%"}})})}),e.jsx(d,{span:8,children:e.jsx(i.Item,{name:"min_cycle_hours",label:"最短周期(小时)",children:e.jsx(P,{min:.1,max:1e3,step:.5,placeholder:"最短时间",style:{width:"100%"}})})}),e.jsx(d,{span:8,children:e.jsx(i.Item,{name:"max_cycle_hours",label:"最长周期(小时)",children:e.jsx(P,{min:.1,max:1e3,step:.5,placeholder:"最长时间",style:{width:"100%"}})})})]}),e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"设备要求"})}),e.jsxs(I,{gutter:16,children:[e.jsx(d,{span:8,children:e.jsx(i.Item,{name:"requires_equipment",label:"需要设备",valuePropName:"checked",children:e.jsx(N,{checkedChildren:"是",unCheckedChildren:"否",checked:q,onChange:j})})}),q&&e.jsx(d,{span:16,children:e.jsx(i.Item,{name:"default_equipment_id",label:"默认设备",children:e.jsx(x,{placeholder:r?"请选择默认设备":"请先选择实验室",allowClear:!0,disabled:!r,options:v.map(l=>({label:`${l.name} (${l.code})`,value:l.id}))})})})]})]})})}const be={analysis:"分析方法",reliability:"可靠性测试"},je={analysis:"blue",reliability:"purple"},K={electrical:"电学分析",physical:"物理分析",chemical:"化学分析",optical:"光学分析",thermal:"热分析",mechanical:"机械测试",environmental:"环境测试",lifetime:"寿命测试",other:"其他"};function Le(){const[f,n]=s.useState([]),[p,k]=s.useState(!1),[L,o]=s.useState(0),[g,m]=s.useState(1),[_,R]=s.useState(20),[v,w]=s.useState(""),[r,u]=s.useState({}),[q,C]=s.useState([]),[h,b]=s.useState(!1),[M,j]=s.useState(null),[y,l]=s.useState("analysis"),{message:c}=Q.useApp(),z=s.useRef(null);s.useEffect(()=>{(async()=>{try{const a=await W.getLaboratories({page:1,page_size:100});C(a.items)}catch(a){A(a)}})()},[]);const S=s.useCallback(async t=>{k(!0);try{const a=await F.getMethods({page:g,page_size:_,search:r.search||void 0,method_type:y,category:r.category||void 0,laboratory_id:r.laboratory_id||void 0,is_active:r.is_active,signal:t});n(a.items),o(a.total)}catch(a){A(a)||c.error("获取方法列表失败")}finally{k(!1)}},[g,_,r,y,c]);s.useEffect(()=>{z.current&&z.current.abort();const t=new AbortController;return z.current=t,S(t.signal),()=>{t.abort()}},[S]),s.useEffect(()=>{const t=setTimeout(()=>{u(a=>({...a,search:v||void 0})),m(1)},300);return()=>clearTimeout(t)},[v]);const X=t=>{m(t.current||1),R(t.pageSize||20)},H=()=>{j(null),b(!0)},J=t=>{j(t),b(!0)},G=async t=>{try{await F.deleteMethod(t),c.success("方法已删除"),S()}catch(a){A(a)||c.error("删除失败")}},U=()=>{b(!1),j(null),S()},Y=()=>{b(!1),j(null)},O=(t,a)=>{u($=>({...$,[t]:a})),m(1)},Z=t=>{l(t),m(1),w(""),u({})},ee=t=>{u(t===void 0||t===""?a=>({...a,is_active:void 0}):a=>({...a,is_active:t==="true"})),m(1)},te=[{title:"方法代码",dataIndex:"code",key:"code",width:120,render:t=>e.jsx("span",{style:{fontWeight:600},children:t})},{title:"方法名称",dataIndex:"name",key:"name"},{title:"类型",dataIndex:"method_type",key:"method_type",width:120,render:t=>{const a=t;return e.jsx(B,{color:je[a]||"default",children:be[a]||a})}},{title:"类别",dataIndex:"category",key:"category",width:100,render:t=>t?K[t]||t:"-"},{title:"所属实验室",key:"laboratory",width:150,render:(t,a)=>a.laboratory?.name||"-"},{title:"预计周期",dataIndex:"standard_cycle_hours",key:"standard_cycle_hours",width:100,render:t=>t?`${t}h`:"-"},{title:"技能要求",key:"skills",width:100,render:(t,a)=>e.jsx(ie,{title:a.skill_requirements.length>0?a.skill_requirements.map($=>$.skill?.name).join(", "):"无技能要求",children:e.jsxs(B,{children:[a.skill_requirements.length," 项技能"]})})},{title:"状态",dataIndex:"is_active",key:"is_active",width:80,render:t=>e.jsx(B,{color:t?"success":"default",children:t?"启用":"停用"})},{title:"操作",key:"action",width:150,render:(t,a)=>e.jsxs(V,{children:[e.jsx(T,{type:"link",size:"small",icon:e.jsx(ue,{}),onClick:()=>J(a),children:"编辑"}),e.jsx(he,{title:"确认删除",description:`确定要删除方法 "${a.name}" 吗？`,onConfirm:()=>G(a.id),okText:"确定",cancelText:"取消",okButtonProps:{danger:!0},children:e.jsx(T,{type:"link",size:"small",danger:!0,icon:e.jsx(me,{}),children:"删除"})})]})}];return e.jsxs(ae,{children:[e.jsx(se,{activeKey:y,onChange:Z,items:[{key:"analysis",label:"分析方法管理"},{key:"reliability",label:"可靠性测试方法管理"}]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[e.jsxs(V,{wrap:!0,children:[e.jsx(E,{placeholder:"搜索方法名称/代码",prefix:e.jsx(le,{}),value:v,onChange:t=>w(t.target.value),style:{width:200},allowClear:!0}),e.jsx(x,{placeholder:"方法类别",style:{width:120},allowClear:!0,value:r.category,onChange:t=>O("category",t),options:Object.entries(K).map(([t,a])=>({label:a,value:t}))}),e.jsx(x,{placeholder:"所属实验室",style:{width:160},allowClear:!0,value:r.laboratory_id,onChange:t=>O("laboratory_id",t),options:q.map(t=>({label:t.name,value:t.id}))}),e.jsx(x,{placeholder:"状态",style:{width:100},allowClear:!0,value:r.is_active===void 0?void 0:r.is_active?"true":"false",onChange:ee,options:[{label:"启用",value:"true"},{label:"停用",value:"false"}]})]}),e.jsxs(V,{children:[e.jsx(T,{icon:e.jsx(de,{}),onClick:()=>S(),children:"刷新"}),e.jsx(T,{type:"primary",icon:e.jsx(re,{}),onClick:H,children:y==="analysis"?"新增分析方法":"新增测试方法"})]})]}),e.jsx(ce,{columns:te,dataSource:f,rowKey:"id",loading:p,size:"middle",pagination:{current:g,pageSize:_,total:L,showSizeChanger:!0,showQuickJumper:!0,showTotal:t=>`共 ${t} 条`},onChange:X}),e.jsx(xe,{visible:h,method:M,defaultMethodType:y,onSuccess:U,onCancel:Y})]})}export{Le as default};
