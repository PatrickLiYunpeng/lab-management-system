import{r as l,I as G,f as H,M as x,a6 as m,a7 as V,P as e,a8 as E,as as ce,O,S as D,a9 as de,Q as F,aa as ue,a0 as B,A as $}from"./index-DVAH8G0d.js";import{s as me}from"./siteService-Bv2y8QeO.js";import{l as pe}from"./laboratoryService-B77Lyyfa.js";import{U as p}from"./index-ksZeLwj1.js";import{M as K}from"./index-D5-92eMw.js";import{S as M,F as fe}from"./Table-BH_IQYSB.js";import{S as he}from"./index-C-m9zxKZ.js";import{R as ge}from"./EditOutlined-BO1KRQYy.js";import{R as ye}from"./CheckCircleOutlined-CzFoyiHm.js";import{P as we}from"./index-BDasguwL.js";import{R as xe}from"./DeleteOutlined-DADLfnzs.js";import"./CheckOutlined-CP9fMx1j.js";var _e={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M608 112c-167.9 0-304 136.1-304 304 0 70.3 23.9 135 63.9 186.5l-41.1 41.1-62.3-62.3a8.15 8.15 0 00-11.4 0l-39.8 39.8a8.15 8.15 0 000 11.4l62.3 62.3-44.9 44.9-62.3-62.3a8.15 8.15 0 00-11.4 0l-39.8 39.8a8.15 8.15 0 000 11.4l62.3 62.3-65.3 65.3a8.03 8.03 0 000 11.3l42.3 42.3c3.1 3.1 8.2 3.1 11.3 0l253.6-253.6A304.06 304.06 0 00608 720c167.9 0 304-136.1 304-304S775.9 112 608 112zm161.2 465.2C726.2 620.3 668.9 644 608 644c-60.9 0-118.2-23.7-161.2-66.8-43.1-43-66.8-100.3-66.8-161.2 0-60.9 23.7-118.2 66.8-161.2 43-43.1 100.3-66.8 161.2-66.8 60.9 0 118.2 23.7 161.2 66.8 43.1 43 66.8 100.3 66.8 161.2 0 60.9-23.7 118.2-66.8 161.2z"}}]},name:"key",theme:"outlined"},ve=function(t,f){return l.createElement(G,H({},t,{ref:f,icon:_e}))},be=l.forwardRef(ve),Se={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372 0-89 31.3-170.8 83.5-234.8l523.3 523.3C682.8 852.7 601 884 512 884zm288.5-137.2L277.2 223.5C341.2 171.3 423 140 512 140c205.4 0 372 166.6 372 372 0 89-31.3 170.8-83.5 234.8z"}}]},name:"stop",theme:"outlined"},je=function(t,f){return l.createElement(G,H({},t,{ref:f,icon:Se}))},Ie=l.forwardRef(je);const R={async getUsers(r){return(await x.get("/users",{params:r})).data},async getUser(r){return(await x.get(`/users/${r}`)).data},async createUser(r){return(await x.post("/users",r)).data},async updateUser(r,t){return(await x.put(`/users/${r}`,t)).data},async deleteUser(r){await x.delete(`/users/${r}`)},async resetPassword(r,t){await x.post(`/users/${r}/reset-password`,{new_password:t})},async activateUser(r){await x.post(`/users/${r}/activate`)},async deactivateUser(r){await x.post(`/users/${r}/deactivate`)},async getRoles(){return(await x.get("/users/roles/list")).data}},Ce=[{value:p.ADMIN,label:"管理员"},{value:p.MANAGER,label:"经理"},{value:p.ENGINEER,label:"工程师"},{value:p.TECHNICIAN,label:"技术员"},{value:p.VIEWER,label:"访客"}];function Ee({visible:r,user:t,onSuccess:f,onCancel:k}){const[d]=m.useForm(),[_,v]=l.useState(!1),[w,U]=l.useState([]),[b,n]=l.useState([]),[S,c]=l.useState(),{message:j}=V.useApp(),u=!!t,A=async()=>{try{const a=await me.getSites({page_size:100});U(a.items)}catch{j.error("获取站点列表失败")}},I=async a=>{try{const o=await pe.getLaboratories({site_id:a,page_size:100});n(o.items)}catch{j.error("获取实验室列表失败")}};l.useEffect(()=>{r&&(A(),t?(d.setFieldsValue({username:t.username,email:t.email,full_name:t.full_name||"",role:t.role,primary_site_id:t.primary_site_id,primary_laboratory_id:t.primary_laboratory_id,is_active:t.is_active}),c(t.primary_site_id),t.primary_site_id&&I(t.primary_site_id)):(d.resetFields(),d.setFieldValue("role",p.VIEWER),d.setFieldValue("is_active",!0),c(void 0),n([])))},[r,t]);const P=a=>{c(a),d.setFieldValue("primary_laboratory_id",void 0),a?I(a):n([])},h=async()=>{try{const a=await d.validateFields();if(v(!0),u){const o={username:a.username,email:a.email,full_name:a.full_name||void 0,role:a.role,primary_site_id:a.primary_site_id||void 0,primary_laboratory_id:a.primary_laboratory_id||void 0,is_active:a.is_active};await R.updateUser(t.id,o),j.success("用户更新成功")}else{if(!a.password||a.password.length<8){j.error("密码至少8个字符"),v(!1);return}const o={username:a.username,email:a.email,password:a.password,full_name:a.full_name||void 0,role:a.role,primary_site_id:a.primary_site_id||void 0,primary_laboratory_id:a.primary_laboratory_id||void 0};await R.createUser(o),j.success("用户创建成功")}f()}catch(a){if(a&&typeof a=="object"&&"errorFields"in a)return;const o=a instanceof Error?a.message:"操作失败";j.error(o)}finally{v(!1)}};return e.jsx(K,{title:u?"编辑用户":"新增用户",open:r,onOk:h,onCancel:k,confirmLoading:_,okText:u?"保存":"创建",cancelText:"取消",width:600,destroyOnHidden:!0,children:e.jsxs(m,{form:d,layout:"vertical",children:[e.jsx(m.Item,{name:"username",label:"用户名",rules:[{required:!0,message:"请输入用户名"},{min:3,message:"用户名至少3个字符"},{max:50,message:"用户名最多50个字符"}],children:e.jsx(E,{placeholder:"请输入用户名"})}),e.jsx(m.Item,{name:"email",label:"邮箱",rules:[{required:!0,message:"请输入邮箱"},{type:"email",message:"请输入有效的邮箱地址"}],children:e.jsx(E,{placeholder:"请输入邮箱"})}),!u&&e.jsx(m.Item,{name:"password",label:"密码",rules:[{required:!0,message:"请输入密码"},{min:8,message:"密码至少8个字符"}],children:e.jsx(E.Password,{placeholder:"请输入密码（至少8个字符）"})}),e.jsx(m.Item,{name:"full_name",label:"姓名",children:e.jsx(E,{placeholder:"请输入姓名"})}),e.jsx(m.Item,{name:"role",label:"角色",rules:[{required:!0,message:"请选择角色"}],children:e.jsx(M,{placeholder:"请选择角色",options:Ce})}),e.jsx(m.Item,{name:"primary_site_id",label:"所属站点",children:e.jsx(M,{placeholder:"请选择站点",allowClear:!0,onChange:P,options:w.map(a=>({value:a.id,label:a.name}))})}),e.jsx(m.Item,{name:"primary_laboratory_id",label:"所属实验室",children:e.jsx(M,{placeholder:S?"请选择实验室":"请先选择站点",allowClear:!0,disabled:!S,options:b.map(a=>({value:a.id,label:a.name}))})}),u&&e.jsx(m.Item,{name:"is_active",label:"账户状态",valuePropName:"checked",children:e.jsx(he,{checkedChildren:"启用",unCheckedChildren:"停用"})})]})})}function Re({visible:r,user:t,onSuccess:f,onCancel:k}){const[d]=m.useForm(),[_,v]=l.useState(!1),{message:w}=V.useApp(),U=async()=>{if(t)try{const n=await d.validateFields();if(n.new_password!==n.confirm_password){w.error("两次输入的密码不一致");return}v(!0),await R.resetPassword(t.id,n.new_password),w.success("密码重置成功"),d.resetFields(),f()}catch(n){if(n&&typeof n=="object"&&"errorFields"in n)return;const S=n instanceof Error?n.message:"密码重置失败";w.error(S)}finally{v(!1)}},b=()=>{d.resetFields(),k()};return e.jsx(K,{title:`重置密码 - ${t?.username||""}`,open:r,onOk:U,onCancel:b,confirmLoading:_,okText:"确认重置",cancelText:"取消",width:400,destroyOnHidden:!0,children:e.jsxs(m,{form:d,layout:"vertical",children:[e.jsx(m.Item,{name:"new_password",label:"新密码",rules:[{required:!0,message:"请输入新密码"},{min:8,message:"密码至少8个字符"}],children:e.jsx(E.Password,{placeholder:"请输入新密码"})}),e.jsx(m.Item,{name:"confirm_password",label:"确认密码",rules:[{required:!0,message:"请确认新密码"}],children:e.jsx(E.Password,{placeholder:"请再次输入新密码"})})]})})}const ke={admin:{label:"管理员",color:"red"},manager:{label:"经理",color:"orange"},engineer:{label:"工程师",color:"blue"},technician:{label:"技术员",color:"green"},viewer:{label:"访客",color:"default"}},ze=[{value:"",label:"全部角色"},{value:p.ADMIN,label:"管理员"},{value:p.MANAGER,label:"经理"},{value:p.ENGINEER,label:"工程师"},{value:p.TECHNICIAN,label:"技术员"},{value:p.VIEWER,label:"访客"}],Ue=[{value:"",label:"全部状态"},{value:"true",label:"启用"},{value:"false",label:"禁用"}];function Be(){const[r,t]=l.useState([]),[f,k]=l.useState(!1),[d,_]=l.useState(!1),[v,w]=l.useState(!1),[U,b]=l.useState(null),[n,S]=l.useState(null),[c,j]=l.useState({current:1,pageSize:10,total:0}),[u,A]=l.useState(""),[I,P]=l.useState(""),[h,a]=l.useState(""),[o,W]=l.useState(""),{message:C}=V.useApp(),N=l.useRef(!1),{user:Q}=ce(),g=l.useCallback(async(s=1,i=10,y="",L="",q="")=>{k(!0);try{const z={page:s,page_size:i};y&&(z.search=y),L&&(z.role=L),q!==""&&(z.is_active=q==="true");const T=await R.getUsers(z);t(T.items),j({current:T.page,pageSize:T.page_size,total:T.total}),N.current=!1}catch(z){O(z)||N.current||(N.current=!0,C.error("获取用户列表失败"))}finally{k(!1)}},[C]);l.useEffect(()=>{g()},[g]),l.useEffect(()=>{const s=setTimeout(()=>{I!==u&&(A(I),g(1,c.pageSize,I,h,o))},300);return()=>clearTimeout(s)},[I,u,c.pageSize,h,o,g]);const J=s=>{g(s.current||1,s.pageSize||10,u,h,o)},X=s=>{const i=s||"";a(i),g(1,c.pageSize,u,i,o)},Y=s=>{const i=s||"";W(i),g(1,c.pageSize,u,h,i)},Z=()=>{b(null),_(!0)},ee=s=>{b(s),_(!0)},ae=s=>{S(s),w(!0)},se=async s=>{try{s.is_active?(await R.deactivateUser(s.id),C.success("用户已禁用")):(await R.activateUser(s.id),C.success("用户已启用")),g(c.current,c.pageSize,u,h,o)}catch(i){O(i)||C.error("操作失败")}},te=async s=>{try{await R.deleteUser(s),C.success("删除成功"),g(c.current,c.pageSize,u,h,o)}catch(i){O(i)||C.error("删除失败")}},re=()=>{_(!1),b(null),g(c.current,c.pageSize,u,h,o)},le=()=>{_(!1),b(null)},ie=()=>{w(!1),S(null)},oe=()=>{w(!1),S(null)},ne=[{title:"用户名",dataIndex:"username",key:"username",width:120},{title:"姓名",dataIndex:"full_name",key:"full_name",width:120,render:s=>s||"-"},{title:"邮箱",dataIndex:"email",key:"email",width:200},{title:"角色",dataIndex:"role",key:"role",width:100,render:s=>{const i=s,y=ke[i]||{label:i,color:"default"};return e.jsx(B,{color:y.color,children:y.label})}},{title:"状态",dataIndex:"is_active",key:"is_active",width:80,render:s=>e.jsx(B,{color:s?"success":"red",children:s?"启用":"禁用"})},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:160,render:s=>new Date(s).toLocaleString("zh-CN")},{title:"操作",key:"action",width:220,render:(s,i)=>{const y=Q?.id===i.id;return e.jsxs(D,{size:4,children:[e.jsx($,{title:"编辑",children:e.jsx(F,{type:"link",size:"small",icon:e.jsx(ge,{}),onClick:()=>ee(i)})}),e.jsx($,{title:"重置密码",children:e.jsx(F,{type:"link",size:"small",icon:e.jsx(be,{}),onClick:()=>ae(i)})}),e.jsx($,{title:i.is_active?"禁用":"启用",children:e.jsx(F,{type:"link",size:"small",icon:i.is_active?e.jsx(Ie,{}):e.jsx(ye,{}),onClick:()=>se(i),disabled:y,style:{color:i.is_active?"#faad14":"#52c41a"}})}),e.jsx(we,{title:"确认删除",description:`确定要删除用户 "${i.username}" 吗？`,onConfirm:()=>te(i.id),okText:"确定",cancelText:"取消",okButtonProps:{danger:!0},disabled:y,children:e.jsx($,{title:y?"不能删除自己":"删除",children:e.jsx(F,{type:"link",size:"small",danger:!0,icon:e.jsx(xe,{}),disabled:y})})})]})}}];return e.jsxs("div",{children:[e.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between",flexWrap:"wrap",gap:16},children:[e.jsxs(D,{wrap:!0,children:[e.jsx(E,{placeholder:"搜索用户名、姓名或邮箱",prefix:e.jsx(de,{}),value:I,onChange:s=>P(s.target.value),style:{width:250},allowClear:!0}),e.jsx(M,{value:h||void 0,onChange:X,options:ze,style:{width:120},placeholder:"全部角色",allowClear:!0}),e.jsx(M,{value:o||void 0,onChange:Y,options:Ue,style:{width:120},placeholder:"全部状态",allowClear:!0})]}),e.jsx(F,{type:"primary",icon:e.jsx(ue,{}),onClick:Z,children:"新增用户"})]}),e.jsx(fe,{columns:ne,dataSource:r,rowKey:"id",loading:f,pagination:{...c,showSizeChanger:!0,showQuickJumper:!0,showTotal:s=>`共 ${s} 条`},onChange:J}),e.jsx(Ee,{visible:d,user:U,onSuccess:re,onCancel:le}),e.jsx(Re,{visible:v,user:n,onSuccess:ie,onCancel:oe})]})}export{Be as default};
