import{r as s,I as je,f as _e,a6 as f,a7 as K,N as ae,P as e,V as B,W as I,a8 as H,O as Y,S as be,a9 as me,Q as A,aa as oe,a0 as N,M as T,A as ge,X as pe,U as Ce,Y as Ie,a4 as Le,a3 as Re,ac as Ve}from"./index-DVAH8G0d.js";import{p as ie}from"./personnelService-DtbQ-G5D.js";import{s as De}from"./siteService-Bv2y8QeO.js";import{l as xe}from"./laboratoryService-B77Lyyfa.js";import{M as le}from"./index-D5-92eMw.js";import{S as M,F as fe}from"./Table-BH_IQYSB.js";import{D as ne}from"./index-Bd8ohf4A.js";import{R as ce}from"./EditOutlined-BO1KRQYy.js";import{P as de}from"./index-BDasguwL.js";import{R as ue}from"./DeleteOutlined-DADLfnzs.js";import{S as he}from"./index-C-m9zxKZ.js";import{T as Ee}from"./index-fw1Ls6Om.js";import{S as qe}from"./StatusTag-CYqPBP0F.js";import{R as Se}from"./SafetyCertificateOutlined-DOhLpXI9.js";import"./CheckOutlined-CP9fMx1j.js";import"./ClockCircleOutlined-C4lKWGcp.js";var Ae={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M928 224H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496zM416 496H232c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h184c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8zm0 136H232c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h184c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8zm308.2-177.4L620.6 598.3l-52.8-73.1c-3-4.2-7.8-6.6-12.9-6.6H500c-6.5 0-10.3 7.4-6.5 12.7l114.1 158.2a15.9 15.9 0 0025.8 0l165-228.7c3.8-5.3 0-12.7-6.5-12.7H737c-5-.1-9.8 2.4-12.8 6.5z"}}]},name:"schedule",theme:"outlined"},Ye=function(t,i){return s.createElement(je,_e({},t,{ref:i,icon:Ae}))},He=s.forwardRef(Ye),Oe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-40 208H676V232h212v136zm0 224H676V432h212v160zM412 432h200v160H412V432zm200-64H412V232h200v136zm-476 64h212v160H136V432zm0-200h212v136H136V232zm0 424h212v136H136V656zm276 0h200v136H412V656zm476 136H676V656h212v136z"}}]},name:"table",theme:"outlined"},Be=function(t,i){return s.createElement(je,_e({},t,{ref:i,icon:Oe}))},We=s.forwardRef(Be),Ne={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M464 720a48 48 0 1096 0 48 48 0 10-96 0zm16-304v184c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V416c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8zm475.7 440l-416-720c-6.2-10.7-16.9-16-27.7-16s-21.6 5.3-27.7 16l-416 720C56 877.4 71.4 904 96 904h832c24.6 0 40-26.6 27.7-48zm-783.5-27.9L512 239.9l339.8 588.2H172.2z"}}]},name:"warning",theme:"outlined"},Ke=function(t,i){return s.createElement(je,_e({},t,{ref:i,icon:Ne}))},ye=s.forwardRef(Ke);const Qe=[{label:"可用",value:"available"},{label:"忙碌",value:"busy"},{label:"休假",value:"on_leave"},{label:"借调中",value:"borrowed"}],Je=[{label:"失效分析部",value:"失效分析部"},{label:"可靠性测试部",value:"可靠性测试部"},{label:"质量管理部",value:"质量管理部"},{label:"研发部",value:"研发部"}];function Ue({visible:a,personnel:t,sites:i,laboratories:b,users:d,onSuccess:k,onCancel:h}){const[j]=f.useForm(),[o,S]=s.useState(!1),[g,m]=s.useState(),{message:r}=K.useApp(),x=g?b.filter(u=>u.site_id===g):b,z=t?d:d.filter(u=>u.role!=="admin"&&u.role!=="viewer");s.useEffect(()=>{a&&(t?(m(t.primary_site_id),j.setFieldsValue({...t,hire_date:t.hire_date?ae(t.hire_date):void 0})):(j.resetFields(),m(void 0)))},[a,t,j]);const n=u=>{m(u);const L=j.getFieldValue("primary_laboratory_id");if(L){const $=b.find(V=>V.id===L);$&&$.site_id!==u&&j.setFieldValue("primary_laboratory_id",void 0)}},P=async()=>{try{const u=await j.validateFields();S(!0);const L={...u,hire_date:u.hire_date?u.hire_date.toISOString():void 0};t?(await ie.updatePersonnel(t.id,L),r.success("更新成功")):(await ie.createPersonnel(L),r.success("创建成功")),k()}catch(u){if(u&&typeof u=="object"&&"errorFields"in u)return;r.error(t?"更新失败":"创建失败")}finally{S(!1)}};return e.jsx(le,{title:t?"编辑人员":"新增人员",open:a,onOk:P,onCancel:h,confirmLoading:o,width:700,okText:"确定",cancelText:"取消",destroyOnHidden:!0,children:e.jsxs(f,{form:j,layout:"vertical",children:[e.jsxs(B,{gutter:16,children:[e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"employee_id",label:"员工编号",rules:[{required:!0,message:"请输入员工编号"}],children:e.jsx(H,{placeholder:"请输入员工编号"})})}),e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"user_id",label:"关联用户",rules:[{required:!0,message:"请选择关联用户"}],children:e.jsx(M,{placeholder:"请选择关联用户",disabled:!!t,showSearch:!0,optionFilterProp:"label",options:z.map(u=>({label:`${u.full_name||u.username} (${u.username})`,value:u.id}))})})})]}),e.jsxs(B,{gutter:16,children:[e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"primary_site_id",label:"主站点",rules:[{required:!0,message:"请选择主站点"}],children:e.jsx(M,{placeholder:"请选择主站点",onChange:n,showSearch:!0,optionFilterProp:"label",options:i.map(u=>({label:`${u.name} (${u.code})`,value:u.id}))})})}),e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"primary_laboratory_id",label:"主实验室",rules:[{required:!0,message:"请选择主实验室"}],children:e.jsx(M,{placeholder:"请先选择主站点",disabled:!g,showSearch:!0,optionFilterProp:"label",options:x.map(u=>({label:`${u.name} (${u.code})`,value:u.id}))})})})]}),t&&e.jsxs(B,{gutter:16,children:[e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"current_site_id",label:"当前站点",children:e.jsx(M,{placeholder:"请选择当前站点",allowClear:!0,showSearch:!0,optionFilterProp:"label",options:i.map(u=>({label:`${u.name} (${u.code})`,value:u.id}))})})}),e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"current_laboratory_id",label:"当前实验室",children:e.jsx(M,{placeholder:"请选择当前实验室",allowClear:!0,showSearch:!0,optionFilterProp:"label",options:b.map(u=>({label:`${u.name} (${u.code})`,value:u.id}))})})})]}),e.jsxs(B,{gutter:16,children:[e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"job_title",label:"职位",children:e.jsx(H,{placeholder:"请输入职位"})})}),e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"department",label:"部门",children:e.jsx(M,{placeholder:"请选择部门",allowClear:!0,options:Je})})})]}),e.jsxs(B,{gutter:16,children:[e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"hire_date",label:"入职日期",children:e.jsx(ne,{style:{width:"100%"},placeholder:"请选择入职日期"})})}),t&&e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"status",label:"状态",children:e.jsx(M,{placeholder:"请选择状态",options:Qe})})})]})]})})}const we={available:{text:"可用",color:"success"},busy:{text:"忙碌",color:"blue"},on_leave:{text:"休假",color:"warning"},borrowed:{text:"借调中",color:"purple"}};function Ge(){const[a,t]=s.useState([]),[i,b]=s.useState([]),[d,k]=s.useState([]),[h]=s.useState([]),[j,o]=s.useState(!1),[S,g]=s.useState(!1),[m,r]=s.useState(null),[x,z]=s.useState({current:1,pageSize:10,total:0}),[n,P]=s.useState({search:""}),[u,L]=s.useState(""),{message:$}=K.useApp(),V=s.useRef(null),C=s.useCallback(async(c=1,v=10,G)=>{o(!0);try{const te=await ie.getPersonnel({page:c,page_size:v,search:n.search||void 0,site_id:n.site_id,laboratory_id:n.laboratory_id,status:n.status,signal:G});t(te.items),z({current:te.page,pageSize:te.page_size,total:te.total})}catch(te){Y(te)||$.error("获取人员列表失败")}finally{o(!1)}},[n,$]),D=s.useCallback(async()=>{try{const c=await De.getAllSites();b(c)}catch(c){Y(c)||console.error("Failed to fetch sites")}},[]),E=s.useCallback(async()=>{try{const c=await xe.getLaboratories({page:1,page_size:100});k(c.items)}catch(c){Y(c)||console.error("Failed to fetch laboratories")}},[]);s.useEffect(()=>{D(),E()},[D,E]),s.useEffect(()=>{V.current&&V.current.abort();const c=new AbortController;return V.current=c,C(1,x.pageSize,c.signal),()=>{c.abort()}},[C,x.pageSize]),s.useEffect(()=>{const c=setTimeout(()=>{u!==n.search&&P(v=>({...v,search:u}))},300);return()=>clearTimeout(c)},[u,n.search]);const W=c=>{C(c.current,c.pageSize)},O=c=>{P(v=>({...v,site_id:c,laboratory_id:void 0}))},Q=c=>{P(v=>({...v,laboratory_id:c}))},X=c=>{P(v=>({...v,status:c}))},J=()=>{r(null),g(!0)},U=c=>{r(c),g(!0)},_=async c=>{try{await ie.deletePersonnel(c),$.success("删除成功"),C(x.current,x.pageSize)}catch(v){Y(v)||$.error("删除失败")}},l=()=>{g(!1),r(null),C(x.current,x.pageSize)},R=()=>{g(!1),r(null)},q=c=>{const v=i.find(G=>G.id===c);return v?`${v.name} (${v.code})`:"-"},ee=c=>{const v=d.find(G=>G.id===c);return v?`${v.name} (${v.code})`:"-"},y=n.site_id?d.filter(c=>c.site_id===n.site_id):d,w=[{title:"员工编号",dataIndex:"employee_id",key:"employee_id",width:120},{title:"姓名",key:"name",width:100,render:(c,v)=>v.user?.full_name||v.user?.username||"-"},{title:"职位",dataIndex:"job_title",key:"job_title",width:100,render:c=>c||"-"},{title:"部门",dataIndex:"department",key:"department",width:120,render:c=>c||"-"},{title:"主站点",dataIndex:"primary_site_id",key:"primary_site_id",width:150,render:(c,v)=>v.primary_site?`${v.primary_site.name} (${v.primary_site.code})`:q(c)},{title:"主实验室",dataIndex:"primary_laboratory_id",key:"primary_laboratory_id",width:180,render:(c,v)=>v.primary_laboratory?`${v.primary_laboratory.name}`:ee(c)},{title:"状态",dataIndex:"status",key:"status",width:90,render:c=>{const v=c,G=we[v]||{text:v,color:"default"};return e.jsx(N,{color:G.color,children:G.text})}},{title:"操作",key:"action",width:150,render:(c,v)=>e.jsxs(be,{children:[e.jsx(A,{type:"link",size:"small",icon:e.jsx(ce,{}),onClick:()=>U(v),children:"编辑"}),e.jsx(de,{title:"确认删除",description:`确定要删除员工 "${v.employee_id}" 吗？`,onConfirm:()=>_(v.id),okText:"确定",cancelText:"取消",okButtonProps:{danger:!0},children:e.jsx(A,{type:"link",size:"small",danger:!0,icon:e.jsx(ue,{}),children:"删除"})})]})}];return e.jsxs("div",{"data-testid":"personnel-page",children:[e.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between"},children:[e.jsxs(be,{wrap:!0,children:[e.jsx(H,{placeholder:"搜索员工编号或职位",prefix:e.jsx(me,{}),value:u,onChange:c=>L(c.target.value),style:{width:200},allowClear:!0,"data-testid":"personnel-search-input"}),e.jsx(M,{placeholder:"站点",value:n.site_id,onChange:O,style:{width:150},allowClear:!0,options:i.map(c=>({label:`${c.name} (${c.code})`,value:c.id}))}),e.jsx(M,{placeholder:"实验室",value:n.laboratory_id,onChange:Q,style:{width:180},allowClear:!0,options:y.map(c=>({label:`${c.name} (${c.code})`,value:c.id}))}),e.jsx(M,{placeholder:"状态",value:n.status,onChange:X,style:{width:120},allowClear:!0,options:Object.entries(we).map(([c,v])=>({label:v.text,value:c}))})]}),e.jsx(A,{type:"primary",icon:e.jsx(oe,{}),onClick:J,"data-testid":"personnel-add-button",children:"新增人员"})]}),e.jsx(fe,{columns:w,dataSource:a,rowKey:"id",loading:j,pagination:{...x,showSizeChanger:!0,showQuickJumper:!0,showTotal:c=>`共 ${c} 条`},onChange:W,scroll:{x:1200},"data-testid":"personnel-table"}),e.jsx(Ue,{visible:S,personnel:m,sites:i,laboratories:d,users:h,onSuccess:l,onCancel:R})]})}const Z={async getSkills(a){return(await T.get("/skills",{params:a})).data},async getSkillById(a){return(await T.get(`/skills/${a}`)).data},async createSkill(a){return(await T.post("/skills",a)).data},async updateSkill(a,t){return(await T.put(`/skills/${a}`,t)).data},async deleteSkill(a){await T.delete(`/skills/${a}`)},async getPersonnelBySkill(a,t){return(await T.get(`/skills/${a}/personnel`,{params:t})).data},async getPersonnelSkills(a){return(await T.get(`/skills/personnel/${a}`)).data},async assignSkillToPersonnel(a,t){return(await T.post(`/skills/personnel/${a}`,t)).data},async updatePersonnelSkill(a,t,i){return(await T.put(`/skills/personnel/${a}/skills/${t}`,i)).data},async removePersonnelSkill(a,t){await T.delete(`/skills/personnel/${a}/skills/${t}`)}},{TextArea:Xe}=H,Ze=[{label:"设备操作",value:"equipment_operation"},{label:"测试方法",value:"testing_method"},{label:"分析技术",value:"analysis_technique"},{label:"软件工具",value:"software_tool"},{label:"安全程序",value:"safety_procedure"},{label:"其他",value:"other"}],et=[{label:"通用",value:""},{label:"失效分析 (FA)",value:"fa"},{label:"可靠性测试",value:"reliability"}];function tt({visible:a,skill:t,onSuccess:i,onCancel:b}){const[d]=f.useForm(),[k,h]=s.useState(!1),[j,o]=s.useState(!1),{message:S}=K.useApp();s.useEffect(()=>{a&&(t?(d.setFieldsValue({name:t.name,code:t.code,category:t.category,lab_type:t.lab_type||"",description:t.description||"",requires_certification:t.requires_certification,certification_validity_days:t.certification_validity_days,is_active:t.is_active}),o(t.requires_certification)):(d.resetFields(),d.setFieldsValue({is_active:!0,requires_certification:!1,lab_type:""}),o(!1)))},[a,t,d]);const g=async()=>{try{const r=await d.validateFields();h(!0);const x={name:r.name,code:r.code,category:r.category,description:r.description,requires_certification:r.requires_certification,certification_validity_days:r.certification_validity_days,lab_type:r.lab_type||void 0};t?(await Z.updateSkill(t.id,x),S.success("技能更新成功")):(await Z.createSkill(x),S.success("技能创建成功")),i()}catch(r){if(r&&typeof r=="object"&&"errorFields"in r)return;S.error(t?"更新失败":"创建失败")}finally{h(!1)}},m=r=>{o(r)};return e.jsx(le,{title:t?"编辑技能":"新增技能",open:a,onOk:g,onCancel:b,confirmLoading:k,width:700,okText:"确定",cancelText:"取消",destroyOnHidden:!0,children:e.jsxs(f,{form:d,layout:"vertical",children:[e.jsxs(B,{gutter:16,children:[e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"name",label:"技能名称",rules:[{required:!0,message:"请输入技能名称"}],children:e.jsx(H,{placeholder:"请输入技能名称"})})}),e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"code",label:"技能代码",rules:[{required:!0,message:"请输入技能代码"}],children:e.jsx(H,{placeholder:"请输入技能代码",disabled:!!t})})})]}),e.jsxs(B,{gutter:16,children:[e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"category",label:"技能类别",rules:[{required:!0,message:"请选择技能类别"}],children:e.jsx(M,{options:Ze,placeholder:"请选择技能类别"})})}),e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"lab_type",label:"适用实验室",children:e.jsx(M,{options:et,placeholder:"请选择适用实验室",allowClear:!0})})})]}),e.jsx(f.Item,{name:"description",label:"描述",children:e.jsx(Xe,{rows:3,placeholder:"请输入技能描述"})}),e.jsxs(B,{gutter:16,children:[e.jsx(I,{span:8,children:e.jsx(f.Item,{name:"requires_certification",label:"需要认证",valuePropName:"checked",children:e.jsx(he,{onChange:m})})}),j&&e.jsx(I,{span:8,children:e.jsx(f.Item,{name:"certification_validity_days",label:"认证有效期(天)",children:e.jsx(Ee,{min:1,max:3650,placeholder:"认证有效天数",style:{width:"100%"}})})}),e.jsx(I,{span:8,children:e.jsx(f.Item,{name:"is_active",label:"状态",valuePropName:"checked",children:e.jsx(he,{})})})]})]})})}const st=[{label:"全部类别",value:""},{label:"设备操作",value:"equipment_operation"},{label:"测试方法",value:"testing_method"},{label:"分析技术",value:"analysis_technique"},{label:"软件工具",value:"software_tool"},{label:"安全程序",value:"safety_procedure"},{label:"其他",value:"other"}],at=[{label:"全部实验室",value:""},{label:"失效分析 (FA)",value:"fa"},{label:"可靠性测试",value:"reliability"}],rt={equipment_operation:"设备操作",testing_method:"测试方法",analysis_technique:"分析技术",software_tool:"软件工具",safety_procedure:"安全程序",other:"其他"},it={fa:"FA",reliability:"可靠性"},nt={equipment_operation:"processing",testing_method:"success",analysis_technique:"processing",software_tool:"warning",safety_procedure:"error",other:"default"};function lt(){const[a,t]=s.useState([]),[i,b]=s.useState(!1),[d,k]=s.useState(!1),[h,j]=s.useState(null),[o,S]=s.useState({current:1,pageSize:10,total:0}),[g,m]=s.useState(""),[r,x]=s.useState(""),[z,n]=s.useState(""),[P,u]=s.useState(""),L=s.useRef(!1),$=s.useRef(!0),{message:V}=K.useApp(),C=s.useCallback(async(l=1,R=10,q="",ee="",y="")=>{b(!0);try{const w=await Z.getSkills({page:l,page_size:R,search:q||void 0,category:ee||void 0,lab_type:y||void 0});$.current&&(t(w.items),S({current:w.page,pageSize:w.page_size,total:w.total}),L.current=!1)}catch(w){Y(w)||$.current&&!L.current&&(L.current=!0,V.error("获取技能列表失败"))}finally{$.current&&b(!1)}},[V]);s.useEffect(()=>($.current=!0,C(),()=>{$.current=!1}),[C]),s.useEffect(()=>{const l=setTimeout(()=>{r!==g&&(m(r),C(1,o.pageSize,r,z,P))},300);return()=>clearTimeout(l)},[r,g,o.pageSize,z,P,C]);const D=l=>{C(l.current||1,l.pageSize||10,g,z,P)},E=l=>{n(l),C(1,o.pageSize,g,l,P)},W=l=>{u(l),C(1,o.pageSize,g,z,l)},O=()=>{j(null),k(!0)},Q=l=>{j(l),k(!0)},X=async l=>{try{await Z.deleteSkill(l),V.success("删除成功"),C(o.current,o.pageSize,g,z,P)}catch(R){Y(R)||V.error("删除失败")}},J=()=>{k(!1),j(null),C(o.current,o.pageSize,g,z,P)},U=()=>{k(!1),j(null)},_=[{title:"技能代码",dataIndex:"code",key:"code",width:120},{title:"技能名称",dataIndex:"name",key:"name",width:200},{title:"类别",dataIndex:"category",key:"category",width:120,render:l=>e.jsx(N,{color:nt[l]||"default",children:rt[l]||l})},{title:"适用实验室",dataIndex:"lab_type",key:"lab_type",width:100,render:l=>l?it[l]||l:"通用"},{title:"需要认证",dataIndex:"requires_certification",key:"requires_certification",width:100,render:l=>e.jsx(N,{color:l?"warning":"default",children:l?"是":"否"})},{title:"认证有效期",dataIndex:"certification_validity_days",key:"certification_validity_days",width:120,render:l=>l?`${l}天`:"-"},{title:"状态",dataIndex:"is_active",key:"is_active",width:80,render:l=>e.jsx(qe,{isActive:l})},{title:"操作",key:"action",width:150,render:(l,R)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(A,{type:"link",size:"small",icon:e.jsx(ce,{}),onClick:()=>Q(R),children:"编辑"}),e.jsx(de,{title:"确认删除",description:`确定要删除技能 "${R.name}" 吗？`,onConfirm:()=>X(R.id),okText:"确定",cancelText:"取消",children:e.jsx(A,{type:"link",size:"small",danger:!0,icon:e.jsx(ue,{}),children:"删除"})})]})}];return e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[e.jsx(H,{placeholder:"搜索技能名称或代码",prefix:e.jsx(me,{style:{color:"#999"}}),value:r,onChange:l=>x(l.target.value),style:{width:256},allowClear:!0}),e.jsx(M,{value:z,onChange:E,options:st,style:{width:144}}),e.jsx(M,{value:P,onChange:W,options:at,style:{width:144}})]}),e.jsx(A,{type:"primary",icon:e.jsx(oe,{}),onClick:O,children:"新增技能"})]}),e.jsx(fe,{columns:_,dataSource:a,rowKey:"id",loading:i,pagination:{current:o.current,pageSize:o.pageSize,total:o.total,showSizeChanger:!0,showQuickJumper:!0,showTotal:l=>`共 ${l} 条`},onChange:D,scroll:{x:1100}}),e.jsx(tt,{visible:d,skill:h,onSuccess:J,onCancel:U})]})}const ot=[{label:"初级",value:"beginner"},{label:"中级",value:"intermediate"},{label:"高级",value:"advanced"},{label:"专家",value:"expert"}];function ct({visible:a,personnelId:t,personnelSkill:i,availableSkills:b,onSuccess:d,onCancel:k}){const[h]=f.useForm(),[j,o]=s.useState(!1),[S,g]=s.useState(!1),{message:m}=K.useApp(),r=!!i;s.useEffect(()=>{a&&(i?(h.setFieldsValue({skill_id:i.skill_id,proficiency_level:i.proficiency_level,is_certified:i.is_certified,certification_date:i.certification_date?ae(i.certification_date):void 0,certification_expiry:i.certification_expiry?ae(i.certification_expiry):void 0,certificate_number:i.certificate_number||""}),g(i.is_certified)):(h.resetFields(),h.setFieldsValue({proficiency_level:"beginner",is_certified:!1}),g(!1)))},[a,i,h]);const x=async()=>{try{const n=await h.validateFields();if(o(!0),r&&i){const P={proficiency_level:n.proficiency_level,is_certified:n.is_certified,certification_date:n.certification_date?n.certification_date.format("YYYY-MM-DD"):void 0,certification_expiry:n.certification_expiry?n.certification_expiry.format("YYYY-MM-DD"):void 0,certificate_number:n.certificate_number};await Z.updatePersonnelSkill(t,i.skill_id,P),m.success("技能更新成功")}else{const P={skill_id:n.skill_id,proficiency_level:n.proficiency_level,is_certified:n.is_certified,certification_date:n.certification_date?n.certification_date.format("YYYY-MM-DD"):void 0,certification_expiry:n.certification_expiry?n.certification_expiry.format("YYYY-MM-DD"):void 0,certificate_number:n.certificate_number};await Z.assignSkillToPersonnel(t,P),m.success("技能分配成功")}d()}catch(n){if(n&&typeof n=="object"&&"errorFields"in n)return;m.error(r?"更新失败":"分配失败")}finally{o(!1)}},z=n=>{g(n)};return e.jsx(le,{title:r?"编辑技能":"分配技能",open:a,onOk:x,onCancel:k,confirmLoading:j,width:600,okText:"确定",cancelText:"取消",destroyOnHidden:!0,children:e.jsxs(f,{form:h,layout:"vertical",children:[e.jsxs(B,{gutter:16,children:[e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"skill_id",label:"技能",rules:[{required:!0,message:"请选择技能"}],children:e.jsx(M,{placeholder:"请选择技能",disabled:r,showSearch:!0,optionFilterProp:"label",options:b.map(n=>({label:`${n.name} (${n.code})`,value:n.id}))})})}),e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"proficiency_level",label:"熟练度",rules:[{required:!0,message:"请选择熟练度"}],children:e.jsx(M,{options:ot,placeholder:"请选择熟练度"})})})]}),e.jsx(f.Item,{name:"is_certified",label:"已认证",valuePropName:"checked",children:e.jsx(he,{onChange:z})}),S&&e.jsxs(e.Fragment,{children:[e.jsxs(B,{gutter:16,children:[e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"certification_date",label:"认证日期",children:e.jsx(ne,{style:{width:"100%"},placeholder:"选择认证日期"})})}),e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"certification_expiry",label:"认证到期日",children:e.jsx(ne,{style:{width:"100%"},placeholder:"选择到期日期"})})})]}),e.jsx(f.Item,{name:"certificate_number",label:"证书编号",children:e.jsx(H,{placeholder:"请输入证书编号"})})]})]})})}const dt={beginner:"default",intermediate:"processing",advanced:"success",expert:"warning"},ke={beginner:"初级",intermediate:"中级",advanced:"高级",expert:"专家"};function ut(a){if(!a)return!1;const t=new Date(a),i=new Date,b=new Date(i.getTime()+720*60*60*1e3);return t<=b&&t>i}function ft(a){return a?new Date(a)<new Date:!1}function pt({personnelSkill:a,compact:t=!1}){const{skill:i,proficiency_level:b,is_certified:d,certification_expiry:k,certificate_number:h}=a;if(!i)return null;const j=ft(k),o=ut(k),S=e.jsxs("div",{style:{fontSize:14},children:[e.jsx("div",{style:{fontWeight:600},children:i.name}),e.jsxs("div",{children:["代码: ",i.code]}),e.jsxs("div",{children:["熟练度: ",ke[b]]}),d&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:["认证状态:"," ",j?e.jsx("span",{style:{color:"#ff4d4f"},children:"已过期"}):o?e.jsx("span",{style:{color:"#faad14"},children:"即将过期"}):e.jsx("span",{style:{color:"#52c41a"},children:"有效"})]}),k&&e.jsxs("div",{children:["有效期至: ",k]}),h&&e.jsxs("div",{children:["证书编号: ",h]})]})]}),g=j?"error":dt[b];return t?e.jsx(ge,{title:S,children:e.jsx("span",{children:e.jsx(N,{color:g,style:{marginBottom:4,cursor:"pointer"},children:e.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[i.code,d&&!j&&e.jsx(Se,{style:{fontSize:12}}),j&&e.jsx(ye,{style:{fontSize:12}})]})})})}):e.jsx(ge,{title:S,children:e.jsx("span",{children:e.jsx(N,{color:g,style:{marginBottom:4,cursor:"pointer"},children:e.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[i.name,e.jsxs("span",{style:{opacity:.7},children:["(",ke[b],")"]}),d&&!j&&e.jsx(Se,{style:{fontSize:12,color:"#52c41a"}}),o&&!j&&e.jsx(ye,{style:{fontSize:12,color:"#faad14"}}),j&&e.jsx(ye,{style:{fontSize:12}})]})})})})}const ht={beginner:"初级",intermediate:"中级",advanced:"高级",expert:"专家"},mt={beginner:"default",intermediate:"processing",advanced:"success",expert:"warning"};function xt(){const[a,t]=s.useState([]),[i,b]=s.useState(!1),[d,k]=s.useState(""),[h,j]=s.useState(""),[o,S]=s.useState(null),[g,m]=s.useState([]),[r,x]=s.useState(!1),[z,n]=s.useState(!1),[P,u]=s.useState(null),[L,$]=s.useState([]),V=s.useRef(!1),C=s.useRef(!1),D=s.useRef(!0),{message:E}=K.useApp(),W=s.useCallback(async(y="")=>{b(!0);try{const w=await ie.getPersonnel({search:y||void 0,page_size:100});D.current&&(t(w.items),V.current=!1)}catch(w){Y(w)||D.current&&!V.current&&(V.current=!0,E.error("获取人员列表失败"))}finally{D.current&&b(!1)}},[E]),O=s.useCallback(async y=>{x(!0);try{const w=await Z.getPersonnelSkills(y);D.current&&(m(w),C.current=!1)}catch(w){Y(w)||D.current&&!C.current&&(C.current=!0,E.error("获取技能列表失败"))}finally{D.current&&x(!1)}},[E]),Q=s.useCallback(async()=>{try{const y=await Z.getSkills({page_size:100,is_active:!0});D.current&&$(y.items)}catch(y){Y(y)||console.error("Failed to fetch available skills")}},[]);s.useEffect(()=>(D.current=!0,W(),Q(),()=>{D.current=!1}),[W,Q]),s.useEffect(()=>{const y=setTimeout(()=>{d!==h&&(j(d),W(d))},300);return()=>clearTimeout(y)},[d,h,W]),s.useEffect(()=>{o?O(o.id):m([])},[o,O]);const X=y=>{S(y)},J=()=>{u(null),n(!0)},U=y=>{u(y),n(!0)},_=async y=>{if(o)try{await Z.removePersonnelSkill(o.id,y),E.success("技能已移除"),O(o.id)}catch(w){Y(w)||E.error("移除技能失败")}},l=()=>{n(!1),u(null),o&&O(o.id)},R=()=>{n(!1),u(null)},q=L.filter(y=>!g.some(w=>w.skill_id===y.id)),ee=[{title:"技能",key:"skill",render:(y,w)=>e.jsx(pt,{personnelSkill:w})},{title:"熟练度",dataIndex:"proficiency_level",key:"proficiency_level",width:100,render:y=>e.jsx(N,{color:mt[y],children:ht[y]})},{title:"认证状态",key:"certification",width:120,render:(y,w)=>w.is_certified?w.certification_expiry?new Date(w.certification_expiry)<new Date?e.jsx(N,{color:"error",children:"已过期"}):e.jsx(N,{color:"success",children:"已认证"}):e.jsx(N,{color:"success",children:"已认证"}):e.jsx(N,{children:"未认证"})},{title:"到期日",dataIndex:"certification_expiry",key:"certification_expiry",width:120,render:y=>y||"-"},{title:"操作",key:"action",width:150,render:(y,w)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(A,{type:"link",size:"small",icon:e.jsx(ce,{}),onClick:()=>U(w),children:"编辑"}),e.jsx(de,{title:"确认移除",description:`确定要移除技能 "${w.skill?.name}" 吗？`,onConfirm:()=>_(w.skill_id),okText:"确定",cancelText:"取消",children:e.jsx(A,{type:"link",size:"small",danger:!0,icon:e.jsx(ue,{}),children:"移除"})})]})}];return e.jsxs("div",{style:{display:"flex",gap:16},children:[e.jsx("div",{style:{width:"33%"},children:e.jsx(pe,{title:"人员列表",extra:e.jsx(H,{placeholder:"搜索人员",prefix:e.jsx(me,{style:{color:"#999"}}),value:d,onChange:y=>k(y.target.value),style:{width:144},allowClear:!0}),styles:{body:{padding:8}},children:i?e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:32},children:e.jsx(Ce,{})}):e.jsxs("div",{style:{maxHeight:"calc(100vh - 280px)",overflow:"auto"},children:[a.map(y=>e.jsx("div",{onClick:()=>X(y),style:{padding:12,borderRadius:6,cursor:"pointer",marginBottom:4,transition:"all 0.2s",backgroundColor:o?.id===y.id?"#e6f7ff":void 0,border:o?.id===y.id?"1px solid #91d5ff":"1px solid transparent"},onMouseEnter:w=>{o?.id!==y.id&&(w.currentTarget.style.backgroundColor="#fafafa")},onMouseLeave:w=>{o?.id!==y.id&&(w.currentTarget.style.backgroundColor="")},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[e.jsx(Ie,{style:{color:"#999"}}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontWeight:500,color:"#333",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:y.user?.full_name||y.employee_id}),e.jsxs("div",{style:{fontSize:12,color:"#999",display:"flex",alignItems:"center",gap:8},children:[e.jsx("span",{children:y.employee_id}),y.job_title&&e.jsx("span",{children:y.job_title})]})]})]})},y.id)),a.length===0&&e.jsx("div",{style:{padding:32,textAlign:"center",color:"#999"},children:"暂无人员数据"})]})})}),e.jsx("div",{style:{flex:1},children:e.jsx(pe,{title:o?`${o.user?.full_name||o.employee_id} 的技能`:"人员技能",extra:o&&e.jsx(A,{type:"primary",size:"small",icon:e.jsx(oe,{}),onClick:J,disabled:q.length===0,children:"添加技能"}),styles:{body:{padding:16}},children:o?e.jsx(fe,{columns:ee,dataSource:g,rowKey:"id",loading:r,pagination:!1,size:"small"}):e.jsx("div",{style:{padding:48,textAlign:"center",color:"#999"},children:"请从左侧选择一名人员查看其技能"})})}),o&&e.jsx(ct,{visible:z,personnelId:o.id,personnelSkill:P,availableSkills:P?L:q,onSuccess:l,onCancel:R})]})}const ve={async getBorrowRequests(a){return(await T.get("/personnel/borrow-requests/",{params:a})).data},async createBorrowRequest(a){return(await T.post("/personnel/borrow-requests",a)).data},async approveBorrowRequest(a,t,i){return(await T.post(`/personnel/borrow-requests/${a}/approve`,{approved:t,rejection_reason:i})).data}},{TextArea:yt}=H;function gt({visible:a,personnelList:t,laboratories:i,onSuccess:b,onCancel:d}){const[k]=f.useForm(),[h,j]=s.useState(!1),[o,S]=s.useState(),{message:g}=K.useApp();s.useEffect(()=>{a&&(k.resetFields(),S(void 0))},[a,k]);const m=async()=>{try{const n=await k.validateFields();j(!0);const P=n.start_date,u=n.end_date,L={personnel_id:n.personnel_id,to_laboratory_id:n.to_laboratory_id,reason:n.reason,start_date:P.format("YYYY-MM-DD"),end_date:u.format("YYYY-MM-DD")};await ve.createBorrowRequest(L),g.success("借调申请创建成功"),b()}catch(n){if(n&&typeof n=="object"&&"errorFields"in n)return;g.error("创建借调申请失败")}finally{j(!1)}},r=n=>{S(n),k.setFieldValue("to_laboratory_id",void 0)},x=t.find(n=>n.id===o),z=i.filter(n=>n.id!==x?.primary_laboratory_id);return e.jsx(le,{title:"新建借调申请",open:a,onOk:m,onCancel:d,confirmLoading:h,width:600,okText:"提交申请",cancelText:"取消",destroyOnHidden:!0,children:e.jsxs(f,{form:k,layout:"vertical",children:[e.jsx(f.Item,{name:"personnel_id",label:"借调人员",rules:[{required:!0,message:"请选择借调人员"}],children:e.jsx(M,{placeholder:"请选择人员",showSearch:!0,optionFilterProp:"label",onChange:r,options:t.map(n=>({label:`${n.user?.full_name||n.employee_id} (${n.employee_id})`,value:n.id}))})}),x&&e.jsxs("div",{style:{marginBottom:16},children:[e.jsx("label",{style:{display:"block",fontSize:14,fontWeight:500,color:"#374151",marginBottom:4},children:"当前所属实验室"}),e.jsx(H,{disabled:!0,value:x.primary_laboratory?.name||"未分配"})]}),e.jsx(f.Item,{name:"to_laboratory_id",label:"目标实验室",rules:[{required:!0,message:"请选择目标实验室"}],children:e.jsx(M,{placeholder:"请选择目标实验室",disabled:!o,optionFilterProp:"label",options:z.map(n=>({label:`${n.name} (${n.code})`,value:n.id}))})}),e.jsxs(B,{gutter:16,children:[e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"start_date",label:"开始日期",rules:[{required:!0,message:"请选择开始日期"}],children:e.jsx(ne,{style:{width:"100%"},placeholder:"选择开始日期"})})}),e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"end_date",label:"结束日期",rules:[{required:!0,message:"请选择结束日期"}],children:e.jsx(ne,{style:{width:"100%"},placeholder:"选择结束日期"})})})]}),e.jsx(f.Item,{name:"reason",label:"借调原因",children:e.jsx(yt,{rows:3,placeholder:"请输入借调原因"})})]})})}const{TextArea:jt}=H,_t=[{label:"批准",value:"approve"},{label:"拒绝",value:"reject"}];function vt({visible:a,borrowRequest:t,onSuccess:i,onCancel:b}){const[d]=f.useForm(),[k,h]=s.useState(!1),[j,o]=s.useState("approve"),{message:S}=K.useApp();s.useEffect(()=>{a&&(d.resetFields(),d.setFieldValue("decision","approve"),o("approve"))},[a,d]);const g=async()=>{if(t)try{const x=await d.validateFields();if(x.decision==="reject"&&!x.rejection_reason){S.error("请输入拒绝原因");return}h(!0);const z=x.decision==="approve";await ve.approveBorrowRequest(t.id,z,x.rejection_reason),S.success(z?"借调申请已批准":"借调申请已拒绝"),d.resetFields(),i()}catch(x){if(x&&typeof x=="object"&&"errorFields"in x)return;S.error("操作失败")}finally{h(!1)}},m=x=>{o(x)},r=()=>{d.resetFields(),b()};return e.jsxs(le,{title:"审批借调申请",open:a,onOk:g,onCancel:r,confirmLoading:k,width:500,okText:"确认",cancelText:"取消",destroyOnHidden:!0,children:[t&&e.jsxs("div",{style:{marginBottom:16,padding:12,backgroundColor:"#fafafa",borderRadius:6,fontSize:14},children:[e.jsxs("p",{style:{marginBottom:4},children:[e.jsx("strong",{children:"人员:"})," ",t.personnel?.user?.full_name||t.personnel?.employee_id]}),e.jsxs("p",{style:{marginBottom:4},children:[e.jsx("strong",{children:"调出实验室:"})," ",t.from_laboratory?.name]}),e.jsxs("p",{style:{marginBottom:4},children:[e.jsx("strong",{children:"调入实验室:"})," ",t.to_laboratory?.name]}),e.jsxs("p",{style:{marginBottom:4},children:[e.jsx("strong",{children:"借调时间:"})," ",t.start_date," 至 ",t.end_date]}),t.reason&&e.jsxs("p",{style:{marginBottom:0},children:[e.jsx("strong",{children:"借调原因:"})," ",t.reason]})]}),e.jsxs(f,{form:d,layout:"vertical",children:[e.jsx(f.Item,{name:"decision",label:"审批决定",rules:[{required:!0,message:"请选择审批决定"}],children:e.jsx(M,{options:_t,onChange:m})}),j==="reject"&&e.jsx(f.Item,{name:"rejection_reason",label:"拒绝原因",rules:[{required:!0,message:"请输入拒绝原因"}],children:e.jsx(jt,{rows:3,placeholder:"请输入拒绝原因"})})]})]})}const bt=[{label:"全部状态",value:""},{label:"待审批",value:"pending"},{label:"已批准",value:"approved"},{label:"已拒绝",value:"rejected"},{label:"已完成",value:"completed"}],St={pending:"processing",approved:"success",rejected:"error",completed:"default"},wt={pending:"待审批",approved:"已批准",rejected:"已拒绝",completed:"已完成"};function kt(){const[a,t]=s.useState([]),[i,b]=s.useState(!1),[d,k]=s.useState({current:1,pageSize:10,total:0}),[h,j]=s.useState(""),[o,S]=s.useState(!1),[g,m]=s.useState(!1),[r,x]=s.useState(null),[z,n]=s.useState([]),[P,u]=s.useState([]),L=s.useRef(!1),$=s.useRef(!0),{message:V}=K.useApp(),C=s.useCallback(async(_=1,l=10,R="")=>{b(!0);try{const q=await ve.getBorrowRequests({page:_,page_size:l,status:R||void 0});$.current&&(t(q.items),k({current:q.page,pageSize:q.page_size,total:q.total}),L.current=!1)}catch(q){Y(q)||$.current&&!L.current&&(L.current=!0,V.error("获取借调申请列表失败"))}finally{$.current&&b(!1)}},[V]),D=s.useCallback(async()=>{try{const[_,l]=await Promise.all([ie.getPersonnel({page_size:100}),xe.getLaboratories({page_size:100})]);$.current&&(n(_.items),u(l.items))}catch(_){Y(_)||console.error("Failed to fetch reference data")}},[]);s.useEffect(()=>($.current=!0,C(),D(),()=>{$.current=!1}),[C,D]);const E=_=>{C(_.current||1,_.pageSize||10,h)},W=_=>{j(_),C(1,d.pageSize,_)},O=()=>{S(!0)},Q=_=>{x(_),m(!0)},X=()=>{S(!1),C(d.current,d.pageSize,h)},J=()=>{m(!1),x(null),C(d.current,d.pageSize,h)},U=[{title:"人员",key:"personnel",width:150,render:(_,l)=>l.personnel?.user?.full_name||l.personnel?.employee_id||"-"},{title:"工号",key:"employee_id",width:100,render:(_,l)=>l.personnel?.employee_id||"-"},{title:"调出实验室",key:"from_laboratory",width:150,render:(_,l)=>l.from_laboratory?.name||"-"},{title:"调入实验室",key:"to_laboratory",width:150,render:(_,l)=>l.to_laboratory?.name||"-"},{title:"开始日期",dataIndex:"start_date",key:"start_date",width:120},{title:"结束日期",dataIndex:"end_date",key:"end_date",width:120},{title:"状态",dataIndex:"status",key:"status",width:100,render:_=>e.jsx(N,{color:St[_],children:wt[_]})},{title:"借调原因",dataIndex:"reason",key:"reason",width:200,render:_=>_||"-"},{title:"操作",key:"action",width:120,render:(_,l)=>l.status==="pending"?e.jsx(A,{type:"link",size:"small",onClick:()=>Q(l),children:"审批"}):l.status==="rejected"&&l.rejection_reason?e.jsx(ge,{title:l.rejection_reason,children:e.jsx("span",{style:{color:"#ff4d4f",fontSize:12,cursor:"help"},children:"查看原因"})}):"-"}];return e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16},children:[e.jsx(M,{value:h,onChange:W,options:bt,style:{width:160}}),e.jsx(A,{type:"primary",icon:e.jsx(oe,{}),onClick:O,children:"新建借调申请"})]}),e.jsx(fe,{columns:U,dataSource:a,rowKey:"id",loading:i,pagination:{current:d.current,pageSize:d.pageSize,total:d.total,showSizeChanger:!0,showQuickJumper:!0,showTotal:_=>`共 ${_} 条`},onChange:E,scroll:{x:1300}}),e.jsx(gt,{visible:o,personnelList:z,laboratories:P,onSuccess:X,onCancel:()=>S(!1)}),e.jsx(vt,{visible:g,borrowRequest:r,onSuccess:J,onCancel:()=>{m(!1),x(null)}})]})}const se={async getShifts(a){return(await T.get("/shifts",{params:a})).data},async getShiftById(a){return(await T.get(`/shifts/${a}`)).data},async createShift(a){return(await T.post("/shifts",a)).data},async updateShift(a,t){return(await T.put(`/shifts/${a}`,t)).data},async deleteShift(a){await T.delete(`/shifts/${a}`)},async getPersonnelByShift(a,t){return(await T.get(`/shifts/${a}/personnel`,{params:t})).data},async getPersonnelShifts(a){return(await T.get(`/shifts/personnel/${a}`)).data},async assignShiftToPersonnel(a,t){return(await T.post(`/shifts/personnel/${a}`,t)).data},async updatePersonnelShift(a,t,i){return(await T.put(`/shifts/personnel/${a}/shifts/${t}`,i)).data},async removePersonnelShift(a,t){await T.delete(`/shifts/personnel/${a}/shifts/${t}`)}};function Ct({visible:a,shift:t,onSuccess:i,onCancel:b}){const[d]=f.useForm(),[k,h]=s.useState(!1),[j,o]=s.useState([]),{message:S}=K.useApp();s.useEffect(()=>{if(a)if(xe.getLaboratories({page_size:100}).then(m=>{o(m.items.filter(r=>r.is_active))}),t){const m=t.start_time?ae(t.start_time,"HH:mm:ss").format("HH:mm"):"",r=t.end_time?ae(t.end_time,"HH:mm:ss").format("HH:mm"):"";d.setFieldsValue({name:t.name,code:t.code,start_time:m,end_time:r,laboratory_id:t.laboratory_id||void 0,is_active:t.is_active})}else d.resetFields(),d.setFieldValue("is_active",!0)},[a,t,d]);const g=async()=>{try{const m=await d.validateFields();h(!0);const r={name:m.name,code:m.code,start_time:m.start_time+":00",end_time:m.end_time+":00",laboratory_id:m.laboratory_id||void 0};t?(await se.updateShift(t.id,{...r,is_active:m.is_active}),S.success("班次更新成功")):(await se.createShift(r),S.success("班次创建成功")),i()}catch(m){if(m&&typeof m=="object"&&"errorFields"in m)return;S.error(t?"更新失败":"创建失败")}finally{h(!1)}};return e.jsx(le,{title:t?"编辑班次":"新增班次",open:a,onOk:g,onCancel:b,confirmLoading:k,width:600,okText:"确定",cancelText:"取消",destroyOnHidden:!0,children:e.jsxs(f,{form:d,layout:"vertical",children:[e.jsxs(B,{gutter:16,children:[e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"name",label:"班次名称",rules:[{required:!0,message:"请输入班次名称"}],children:e.jsx(H,{placeholder:"请输入班次名称"})})}),e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"code",label:"班次代码",rules:[{required:!0,message:"请输入班次代码"}],children:e.jsx(H,{placeholder:"请输入班次代码",disabled:!!t})})})]}),e.jsxs(B,{gutter:16,children:[e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"start_time",label:"开始时间",rules:[{required:!0,message:"请选择开始时间"}],children:e.jsx(H,{type:"time",style:{width:"100%"}})})}),e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"end_time",label:"结束时间",extra:"支持跨午夜班次，如22:00-06:00",rules:[{required:!0,message:"请选择结束时间"}],children:e.jsx(H,{type:"time",style:{width:"100%"}})})})]}),e.jsxs(B,{gutter:16,children:[e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"laboratory_id",label:"适用实验室",children:e.jsx(M,{placeholder:"全部实验室",allowClear:!0,optionFilterProp:"label",options:j.map(m=>({label:`${m.name} (${m.code})`,value:m.id}))})})}),t&&e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"is_active",label:"状态",valuePropName:"checked",children:e.jsx(he,{})})})]})]})})}function It({visible:a,shiftId:t,personnelShift:i,availablePersonnel:b,onSuccess:d,onCancel:k}){const[h]=f.useForm(),[j,o]=s.useState(!1),{message:S}=K.useApp(),g=!!i;s.useEffect(()=>{a&&(i?h.setFieldsValue({personnel_id:i.personnel_id,effective_date:i.effective_date?ae(i.effective_date):void 0,end_date:i.end_date?ae(i.end_date):void 0}):(h.resetFields(),h.setFieldValue("effective_date",ae())))},[a,i,h]);const m=async()=>{try{const r=await h.validateFields();if(o(!0),g&&i){const x={effective_date:r.effective_date?r.effective_date.format("YYYY-MM-DD"):void 0,end_date:r.end_date?r.end_date.format("YYYY-MM-DD"):void 0};await se.updatePersonnelShift(i.personnel_id,i.shift_id,x),S.success("班次分配更新成功")}else{const x=r.effective_date,z={shift_id:t,effective_date:x.format("YYYY-MM-DD"),end_date:r.end_date?r.end_date.format("YYYY-MM-DD"):void 0};await se.assignShiftToPersonnel(r.personnel_id,z),S.success("班次分配成功")}d()}catch(r){if(r&&typeof r=="object"&&"errorFields"in r)return;S.error(g?"更新失败":"分配失败")}finally{o(!1)}};return e.jsx(le,{title:g?"编辑班次分配":"分配人员",open:a,onOk:m,onCancel:k,confirmLoading:j,width:500,okText:"确定",cancelText:"取消",destroyOnHidden:!0,children:e.jsxs(f,{form:h,layout:"vertical",children:[e.jsx(f.Item,{name:"personnel_id",label:"人员",rules:[{required:!0,message:"请选择人员"}],children:e.jsx(M,{placeholder:"请选择人员",disabled:g,showSearch:!0,optionFilterProp:"label",options:b.map(r=>({label:`${r.user?.full_name||r.employee_id} (${r.employee_id})`,value:r.id}))})}),e.jsxs(B,{gutter:16,children:[e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"effective_date",label:"生效日期",rules:[{required:!0,message:"请选择生效日期"}],children:e.jsx(ne,{style:{width:"100%"},placeholder:"选择生效日期"})})}),e.jsx(I,{span:12,children:e.jsx(f.Item,{name:"end_date",label:"结束日期",extra:"留空表示持续有效",children:e.jsx(ne,{style:{width:"100%"},placeholder:"选择结束日期"})})})]})]})})}function zt(){const[a,t]=s.useState([]),[i,b]=s.useState(!1),[d,k]=s.useState(""),[h,j]=s.useState(""),[o,S]=s.useState(),[g,m]=s.useState([]),[r,x]=s.useState(null),[z,n]=s.useState([]),[P,u]=s.useState(!1),[L,$]=s.useState(!1),[V,C]=s.useState(null),[D,E]=s.useState(!1),[W,O]=s.useState(null),[Q,X]=s.useState([]),J=s.useRef(!1),U=s.useRef(!1),_=s.useRef(!0),{message:l}=K.useApp(),R=s.useCallback(async(p="",F)=>{b(!0);try{const re=await se.getShifts({page_size:100,search:p||void 0,laboratory_id:F});_.current&&(t(re.items),J.current=!1)}catch(re){Y(re)||_.current&&!J.current&&(J.current=!0,l.error("获取班次列表失败"))}finally{_.current&&b(!1)}},[l]),q=s.useCallback(async p=>{u(!0);try{const F=await se.getPersonnelByShift(p);_.current&&(n(F),U.current=!1)}catch(F){Y(F)||_.current&&!U.current&&(U.current=!0,l.error("获取人员班次失败"))}finally{_.current&&u(!1)}},[l]),ee=s.useCallback(async()=>{try{const[p,F]=await Promise.all([ie.getPersonnel({page_size:100}),xe.getLaboratories({page_size:100})]);_.current&&(X(p.items),m(F.items.filter(re=>re.is_active)))}catch(p){Y(p)||console.error("Failed to fetch reference data")}},[]);s.useEffect(()=>(_.current=!0,R(),ee(),()=>{_.current=!1}),[R,ee]),s.useEffect(()=>{r?q(r.id):n([])},[r,q]),s.useEffect(()=>{const p=setTimeout(()=>{d!==h&&(j(d),R(d,o))},300);return()=>clearTimeout(p)},[d,h,o,R]);const y=p=>{S(p),R(h,p)},w=()=>{C(null),$(!0)},c=p=>{C(p),$(!0)},v=async p=>{try{await se.deleteShift(p),l.success("删除成功"),R(h,o),r?.id===p&&x(null)}catch(F){Y(F)||l.error("删除失败")}},G=()=>{$(!1),C(null),R(h,o)},te=()=>{O(null),E(!0)},ze=p=>{O(p),E(!0)},Pe=async p=>{try{await se.removePersonnelShift(p.personnel_id,p.shift_id),l.success("移除成功"),r&&q(r.id)}catch(F){Y(F)||l.error("移除失败")}},$e=()=>{E(!1),O(null),r&&q(r.id)},Fe=p=>{const F=p.start_time?.substring(0,5)||"",re=p.end_time?.substring(0,5)||"";return`${F} - ${re}`},Te=Q.filter(p=>!z.some(F=>F.personnel_id===p.id)),Me=[{title:"人员姓名",key:"name",render:(p,F)=>F.personnel?.user?.full_name||"-"},{title:"工号",key:"employee_id",render:(p,F)=>F.personnel?.employee_id||"-"},{title:"生效日期",dataIndex:"effective_date",key:"effective_date"},{title:"结束日期",dataIndex:"end_date",key:"end_date",render:p=>p||"持续有效"},{title:"操作",key:"action",width:150,render:(p,F)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(A,{type:"link",size:"small",icon:e.jsx(ce,{}),onClick:()=>ze(F),children:"编辑"}),e.jsx(de,{title:"确认移除",description:"确定要移除该人员的班次分配吗？",onConfirm:()=>Pe(F),okText:"确定",cancelText:"取消",children:e.jsx(A,{type:"link",size:"small",danger:!0,icon:e.jsx(ue,{}),children:"移除"})})]})}];return e.jsxs("div",{style:{display:"flex",gap:16},children:[e.jsx("div",{style:{width:"33%"},children:e.jsx(pe,{title:"班次列表",extra:e.jsx(A,{type:"primary",size:"small",icon:e.jsx(oe,{}),onClick:w,children:"新增"}),styles:{body:{padding:16}},children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[e.jsx(H,{placeholder:"搜索班次名称或代码",prefix:e.jsx(me,{style:{color:"#999"}}),value:d,onChange:p=>k(p.target.value),allowClear:!0}),e.jsx(M,{placeholder:"全部实验室",allowClear:!0,style:{width:"100%"},value:o,onChange:y,options:g.map(p=>({label:p.name,value:p.id}))}),i?e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:32},children:e.jsx(Ce,{})}):e.jsxs("div",{style:{maxHeight:500,overflow:"auto",display:"flex",flexDirection:"column",gap:8},children:[a.map(p=>e.jsx("div",{onClick:()=>x(p),style:{padding:12,borderRadius:6,border:`1px solid ${r?.id===p.id?"#1677ff":"#d9d9d9"}`,backgroundColor:r?.id===p.id?"#e6f4ff":"#fff",cursor:"pointer",transition:"all 0.2s"},children:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:4},children:[e.jsx("span",{style:{fontWeight:500,color:"#333"},children:p.name}),!p.is_active&&e.jsx(N,{color:"default",children:"已停用"})]}),e.jsxs("div",{style:{fontSize:12,color:"#666"},children:[e.jsxs("div",{children:["代码: ",p.code]}),e.jsxs("div",{children:["时间: ",Fe(p)]}),p.laboratory&&e.jsxs("div",{children:["实验室: ",p.laboratory.name]})]})]}),e.jsxs("div",{style:{display:"flex",gap:4,marginLeft:8},children:[e.jsx(A,{type:"text",size:"small",icon:e.jsx(ce,{}),onClick:F=>{F.stopPropagation(),c(p)}}),e.jsx(de,{title:"确认删除",description:`确定要删除班次 "${p.name}" 吗？`,onConfirm:()=>v(p.id),okText:"确定",cancelText:"取消",children:e.jsx(A,{type:"text",size:"small",danger:!0,icon:e.jsx(ue,{}),onClick:F=>F.stopPropagation()})})]})]})},p.id)),a.length===0&&e.jsx("div",{style:{padding:32,textAlign:"center",color:"#999"},children:"暂无班次数据"})]})]})})}),e.jsx("div",{style:{flex:1},children:e.jsx(pe,{title:r?`已分配人员 - ${r.name}`:"已分配人员",extra:r&&e.jsx(A,{type:"primary",size:"small",icon:e.jsx(oe,{}),onClick:te,children:"分配人员"}),styles:{body:{padding:16}},children:r?e.jsx(fe,{columns:Me,dataSource:z,rowKey:"id",loading:P,pagination:!1,size:"small"}):e.jsx("div",{style:{padding:48,textAlign:"center",color:"#999"},children:"请从左侧选择一个班次"})})}),e.jsx(Ct,{visible:L,shift:V,onSuccess:G,onCancel:()=>{$(!1),C(null)}}),r&&e.jsx(It,{visible:D,shiftId:r.id,personnelShift:W,availablePersonnel:W?Q:Te,onSuccess:$e,onCancel:()=>{E(!1),O(null)}})]})}function Wt(){const[a,t]=s.useState("personnel"),i=[{key:"personnel",label:e.jsxs("span",{children:[e.jsx(Ie,{}),"人员列表"]}),children:e.jsx(Ge,{})},{key:"skills-matrix",label:e.jsxs("span",{children:[e.jsx(We,{}),"技能矩阵"]}),children:e.jsx(lt,{})},{key:"skills-config",label:e.jsxs("span",{children:[e.jsx(Re,{}),"技能配置"]}),children:e.jsx(xt,{})},{key:"transfers",label:e.jsxs("span",{children:[e.jsx(Ve,{}),"借调管理"]}),children:e.jsx(kt,{})},{key:"shifts",label:e.jsxs("span",{children:[e.jsx(He,{}),"班次管理"]}),children:e.jsx(zt,{})}];return e.jsx(Le,{activeKey:a,onChange:t,items:i,size:"large",style:{marginTop:-16}})}export{Wt as default};
