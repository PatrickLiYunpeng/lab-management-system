import{a7 as ie,r as o,O as h,P as t,X as oe,a8 as ae,a9 as se,a0 as f,A as de,Q as ne}from"./index-DVAH8G0d.js";import{w as D}from"./workOrderService-Bmn1aSRi.js";import{l as ce}from"./laboratoryService-B77Lyyfa.js";import{m as fe}from"./materialService-CigNgq2n.js";import{S as p,F as R}from"./Table-BH_IQYSB.js";import{S as pe}from"./index-C-m9zxKZ.js";import{M as xe}from"./index-D5-92eMw.js";import{R as ue}from"./ExclamationCircleOutlined-CZLhAH0C.js";import{P as he}from"./progress-lvmwxBfu.js";import{R as ye}from"./ClockCircleOutlined-C4lKWGcp.js";import{R as ge}from"./InfoCircleOutlined-DHwaGtqA.js";import"./CheckOutlined-CP9fMx1j.js";const P={failure_analysis:"失效分析",reliability_test:"可靠性测试"},b={draft:{text:"草稿",color:"default"},pending:{text:"待处理",color:"warning"},assigned:{text:"已分配",color:"blue"},in_progress:{text:"进行中",color:"processing"},on_hold:{text:"暂停",color:"warning"},review:{text:"待审核",color:"processing"},completed:{text:"已完成",color:"success"},cancelled:{text:"已取消",color:"default"}},ve=[{value:"",label:"全部类型"},{value:"failure_analysis",label:"失效分析"},{value:"reliability_test",label:"可靠性测试"}],_e=[{value:"",label:"全部状态"},{value:"draft",label:"草稿"},{value:"pending",label:"待处理"},{value:"assigned",label:"已分配"},{value:"in_progress",label:"进行中"},{value:"on_hold",label:"暂停"},{value:"review",label:"待审核"},{value:"completed",label:"已完成"},{value:"cancelled",label:"已取消"}];function Oe(){const{message:x}=ie.useApp(),[F,$]=o.useState([]),[m,A]=o.useState([]),[w,N]=o.useState([]),[E,j]=o.useState(!1),[y,M]=o.useState({current:1,pageSize:10,total:0}),[l,d]=o.useState({search:"",overdue_only:!1}),[u,V]=o.useState(""),[Q,k]=o.useState(!1),[a,S]=o.useState(null),[K,C]=o.useState([]),[J,z]=o.useState(!1),g=o.useRef(!1),n=o.useRef(!0),v=o.useCallback(async(e=1,r=10)=>{j(!0);try{const i={page:e,page_size:r};l.search&&(i.search=l.search),l.laboratory_id&&(i.laboratory_id=l.laboratory_id),l.client_id&&(i.client_id=l.client_id),l.work_order_type&&(i.work_order_type=l.work_order_type),l.status&&(i.status=l.status),l.priority_level&&(i.priority_level=l.priority_level),l.overdue_only&&(i.overdue_only=l.overdue_only),l.sort_by&&(i.sort_by=l.sort_by),l.sort_order&&(i.sort_order=l.sort_order);const s=await D.getWorkOrders(i);n.current&&($(s.items),M({current:s.page,pageSize:s.page_size,total:s.total}),g.current=!1)}catch(i){h(i)||n.current&&!g.current&&(g.current=!0,x.error("获取工单列表失败"))}finally{n.current&&j(!1)}},[l,x]),I=o.useCallback(async()=>{try{const e=await ce.getLaboratories({page:1,page_size:100});n.current&&A(e.items)}catch(e){h(e)||console.error("Failed to fetch laboratories")}},[]),W=o.useCallback(async()=>{try{const e=await fe.getAllClients();n.current&&N(e)}catch(e){h(e)||console.error("Failed to fetch clients")}},[]),X=o.useCallback(async e=>{z(!0);try{const r=await D.getTasks(e);C(r)}catch(r){h(r)||x.error("获取任务列表失败")}finally{z(!1)}},[x]);o.useEffect(()=>(n.current=!0,I(),W(),()=>{n.current=!1}),[I,W]),o.useEffect(()=>{v()},[v]),o.useEffect(()=>{const e=setTimeout(()=>{u!==l.search&&d(r=>({...r,search:u}))},300);return()=>clearTimeout(e)},[u,l.search]);const q=(e,r,i)=>{const s=Array.isArray(i)?i[0]:i;let _,B;if(s?.field&&s?.order){const c=s.field;c==="priority_score"||c==="priority"?_="priority_score":c==="sla_deadline"&&(_="sla_deadline"),B=s.order==="ascend"?"asc":"desc"}d(c=>({...c,sort_by:_,sort_order:B})),v(e.current||1,e.pageSize||10)},G=e=>{d(r=>({...r,laboratory_id:e||void 0}))},H=e=>{d(r=>({...r,client_id:e||void 0}))},U=e=>{d(r=>({...r,work_order_type:e||void 0}))},Y=e=>{d(r=>({...r,status:e||void 0}))},Z=e=>{d(r=>({...r,overdue_only:e}))},ee=e=>{S(e),k(!0),X(e.id)},te=()=>{k(!1),S(null),C([])},L=e=>{const r=m.find(i=>i.id===e);return r?r.name:"-"},T=e=>{if(!e)return"-";const r=w.find(i=>i.id===e);return r?r.name:"-"},O=e=>!e.sla_deadline||e.status==="completed"||e.status==="cancelled"?!1:new Date(e.sla_deadline)<new Date,re=[{title:"工单号",dataIndex:"order_number",key:"order_number",width:160,render:(e,r)=>t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[O(r)&&t.jsx(de,{title:"已逾期",children:t.jsx(ue,{style:{color:"#ff4d4f"}})}),t.jsx("span",{style:{fontWeight:500,color:"#333"},children:e})]})},{title:"标题",dataIndex:"title",key:"title",width:200},{title:"类型",dataIndex:"work_order_type",key:"work_order_type",width:100,render:e=>t.jsx(f,{color:e==="failure_analysis"?"warning":"blue",children:P[e]||e})},{title:"实验室",dataIndex:"laboratory_id",key:"laboratory_id",width:120,render:e=>L(e)},{title:"客户",dataIndex:"client_id",key:"client_id",width:120,render:e=>T(e)},{title:"优先级",key:"priority",dataIndex:"priority_score",width:100,sorter:!0,render:(e,r)=>t.jsx(he,{percent:r.priority_score,size:"small",format:()=>`P${r.priority_level}`,strokeColor:r.priority_score>70?"#ff4d4f":r.priority_score>50?"#faad14":"#52c41a"})},{title:"状态",dataIndex:"status",key:"status",width:90,render:e=>{const r=b[e]||{text:e,color:"default"};return t.jsx(f,{color:r.color,children:r.text})}},{title:"截止日",dataIndex:"sla_deadline",key:"sla_deadline",width:110,sorter:!0,render:(e,r)=>{if(!e)return"-";const i=new Date(e).toLocaleDateString("zh-CN"),s=O(r);return t.jsxs("span",{style:s?{color:"#ff4d4f",display:"flex",alignItems:"center",gap:4}:void 0,children:[s&&t.jsx(ye,{style:{fontSize:14}}),i]})}},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:110,render:e=>new Date(e).toLocaleDateString("zh-CN")},{title:"操作",key:"action",width:80,fixed:"right",render:(e,r)=>t.jsx(ne,{type:"link",size:"small",icon:t.jsx(ge,{}),onClick:()=>ee(r),children:"详情"})}],le=[{title:"任务号",dataIndex:"task_number",key:"task_number",width:120},{title:"任务标题",dataIndex:"title",key:"title",width:200},{title:"状态",dataIndex:"status",key:"status",width:100,render:e=>{const r={pending:"warning",assigned:"blue",in_progress:"processing",completed:"success",blocked:"error",cancelled:"default"},i={pending:"待处理",assigned:"已分配",in_progress:"进行中",completed:"已完成",blocked:"已阻塞",cancelled:"已取消"};return t.jsx(f,{color:r[e]||"default",children:i[e]||e})}},{title:"方法",dataIndex:"method",key:"method",width:150,render:(e,r)=>r.method?.name||"-"}];return t.jsxs("div",{children:[t.jsx(oe,{style:{marginBottom:16},children:t.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(6, 1fr)",gap:16},children:[t.jsx("div",{style:{gridColumn:"span 2"},children:t.jsx(ae,{placeholder:"搜索工单号或标题",prefix:t.jsx(se,{style:{color:"#999"}}),value:u,onChange:e=>V(e.target.value),allowClear:!0})}),t.jsx("div",{children:t.jsx(p,{placeholder:"选择实验室",value:l.laboratory_id,onChange:G,allowClear:!0,style:{width:"100%"},options:[{value:void 0,label:"全部实验室"},...m.map(e=>({label:`${e.name} (${e.code})`,value:e.id}))]})}),t.jsx("div",{children:t.jsx(p,{placeholder:"选择客户",value:l.client_id,onChange:H,allowClear:!0,style:{width:"100%"},options:[{value:void 0,label:"全部客户"},...w.map(e=>({label:e.name,value:e.id}))]})}),t.jsx("div",{children:t.jsx(p,{value:l.work_order_type||"",onChange:U,options:ve,style:{width:"100%"}})}),t.jsx("div",{children:t.jsx(p,{value:l.status||"",onChange:Y,options:_e,style:{width:"100%"}})}),t.jsx("div",{children:t.jsx(p,{placeholder:"优先级",value:l.priority_level,onChange:e=>d(r=>({...r,priority_level:e||void 0})),allowClear:!0,style:{width:"100%"},options:[{value:1,label:"P1 - 最高"},{value:2,label:"P2 - 高"},{value:3,label:"P3 - 中"},{value:4,label:"P4 - 低"},{value:5,label:"P5 - 最低"}]})}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("span",{style:{fontSize:14,color:"#666"},children:"仅显示逾期:"}),t.jsx(pe,{checked:l.overdue_only,onChange:Z})]})]})}),t.jsx(R,{columns:re,dataSource:F,rowKey:"id",loading:E,pagination:{current:y.current,pageSize:y.pageSize,total:y.total,showSizeChanger:!0,showQuickJumper:!0,showTotal:e=>`共 ${e} 条工单`},onChange:q,scroll:{x:1200}}),t.jsx(xe,{title:`工单详情 - ${a?.order_number||""}`,open:Q,onCancel:te,footer:null,width:800,children:a&&t.jsxs("div",{children:[t.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",border:"1px solid #f0f0f0",borderRadius:8,overflow:"hidden"},children:[t.jsxs("div",{style:{display:"flex",borderBottom:"1px solid #f0f0f0"},children:[t.jsx("div",{style:{width:96,padding:"8px 12px",backgroundColor:"#fafafa",fontSize:14,color:"#999",fontWeight:500},children:"工单号"}),t.jsx("div",{style:{flex:1,padding:"8px 12px",fontSize:14},children:a.order_number})]}),t.jsxs("div",{style:{display:"flex",borderBottom:"1px solid #f0f0f0"},children:[t.jsx("div",{style:{width:96,padding:"8px 12px",backgroundColor:"#fafafa",fontSize:14,color:"#999",fontWeight:500},children:"标题"}),t.jsx("div",{style:{flex:1,padding:"8px 12px",fontSize:14},children:a.title})]}),t.jsxs("div",{style:{display:"flex",borderBottom:"1px solid #f0f0f0"},children:[t.jsx("div",{style:{width:96,padding:"8px 12px",backgroundColor:"#fafafa",fontSize:14,color:"#999",fontWeight:500},children:"类型"}),t.jsx("div",{style:{flex:1,padding:"8px 12px"},children:t.jsx(f,{color:a.work_order_type==="failure_analysis"?"warning":"blue",children:P[a.work_order_type]})})]}),t.jsxs("div",{style:{display:"flex",borderBottom:"1px solid #f0f0f0"},children:[t.jsx("div",{style:{width:96,padding:"8px 12px",backgroundColor:"#fafafa",fontSize:14,color:"#999",fontWeight:500},children:"状态"}),t.jsx("div",{style:{flex:1,padding:"8px 12px"},children:t.jsx(f,{color:b[a.status]?.color,children:b[a.status]?.text})})]}),t.jsxs("div",{style:{display:"flex",borderBottom:"1px solid #f0f0f0"},children:[t.jsx("div",{style:{width:96,padding:"8px 12px",backgroundColor:"#fafafa",fontSize:14,color:"#999",fontWeight:500},children:"实验室"}),t.jsx("div",{style:{flex:1,padding:"8px 12px",fontSize:14},children:L(a.laboratory_id)})]}),t.jsxs("div",{style:{display:"flex",borderBottom:"1px solid #f0f0f0"},children:[t.jsx("div",{style:{width:96,padding:"8px 12px",backgroundColor:"#fafafa",fontSize:14,color:"#999",fontWeight:500},children:"客户"}),t.jsx("div",{style:{flex:1,padding:"8px 12px",fontSize:14},children:T(a.client_id)})]}),t.jsxs("div",{style:{display:"flex",borderBottom:"1px solid #f0f0f0"},children:[t.jsx("div",{style:{width:96,padding:"8px 12px",backgroundColor:"#fafafa",fontSize:14,color:"#999",fontWeight:500},children:"优先级"}),t.jsxs("div",{style:{flex:1,padding:"8px 12px",fontSize:14},children:["P",a.priority_level," (",a.priority_score,"分)"]})]}),t.jsxs("div",{style:{display:"flex",borderBottom:"1px solid #f0f0f0"},children:[t.jsx("div",{style:{width:96,padding:"8px 12px",backgroundColor:"#fafafa",fontSize:14,color:"#999",fontWeight:500},children:"截止日"}),t.jsx("div",{style:{flex:1,padding:"8px 12px",fontSize:14},children:a.sla_deadline?new Date(a.sla_deadline).toLocaleString("zh-CN"):"-"})]}),t.jsxs("div",{style:{display:"flex",borderBottom:"1px solid #f0f0f0"},children:[t.jsx("div",{style:{width:96,padding:"8px 12px",backgroundColor:"#fafafa",fontSize:14,color:"#999",fontWeight:500},children:"创建时间"}),t.jsx("div",{style:{flex:1,padding:"8px 12px",fontSize:14},children:new Date(a.created_at).toLocaleString("zh-CN")})]}),t.jsxs("div",{style:{display:"flex",borderBottom:"1px solid #f0f0f0"},children:[t.jsx("div",{style:{width:96,padding:"8px 12px",backgroundColor:"#fafafa",fontSize:14,color:"#999",fontWeight:500},children:"更新时间"}),t.jsx("div",{style:{flex:1,padding:"8px 12px",fontSize:14},children:new Date(a.updated_at).toLocaleString("zh-CN")})]}),t.jsxs("div",{style:{display:"flex",gridColumn:"span 2"},children:[t.jsx("div",{style:{width:96,padding:"8px 12px",backgroundColor:"#fafafa",fontSize:14,color:"#999",fontWeight:500},children:"描述"}),t.jsx("div",{style:{flex:1,padding:"8px 12px",fontSize:14},children:a.description||"-"})]})]}),t.jsxs("div",{style:{marginTop:24},children:[t.jsx("h4",{style:{fontWeight:500,color:"#333",marginBottom:12},children:"关联任务"}),t.jsx(R,{columns:le,dataSource:K,rowKey:"id",loading:J,size:"small"})]})]})})]})}export{Oe as default};
