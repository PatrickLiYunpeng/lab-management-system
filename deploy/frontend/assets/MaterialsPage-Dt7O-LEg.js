import{ai as xe,r as l,aj as de,B as fe,c as A,i as ye,m as je,j as ve,l as R,t as _e,q as Se,ak as we,s as Ce,I as Oe,f as $e,a6 as O,a7 as W,N as Q,P as e,V,W as I,a8 as L,O as D,S as K,a9 as ue,Q as H,aa as pe,a0 as ae,A as Ie,a4 as ze,a1 as Ee}from"./index-DVAH8G0d.js";import{m as k}from"./materialService-CigNgq2n.js";import{l as Me}from"./laboratoryService-B77Lyyfa.js";import{s as Pe}from"./siteService-Bv2y8QeO.js";import{M as le}from"./index-D5-92eMw.js";import{S as T,F as se,E as Te}from"./Table-BH_IQYSB.js";import{T as me}from"./index-fw1Ls6Om.js";import{D as ne}from"./index-Bd8ohf4A.js";import{S as he}from"./index-C-m9zxKZ.js";import{R as ge}from"./EditOutlined-BO1KRQYy.js";import{R as Ne}from"./HistoryOutlined-1oj76i5A.js";import{R as Re}from"./ExperimentOutlined-DmOxbO1D.js";import"./CheckOutlined-CP9fMx1j.js";import"./ClockCircleOutlined-C4lKWGcp.js";const Be={xxl:3,xl:3,lg:3,md:3,sm:2,xs:1},re=xe.createContext({});var Ae=function(n,t){var i={};for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&t.indexOf(a)<0&&(i[a]=n[a]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,a=Object.getOwnPropertySymbols(n);r<a.length;r++)t.indexOf(a[r])<0&&Object.prototype.propertyIsEnumerable.call(n,a[r])&&(i[a[r]]=n[a[r]]);return i};const Fe=n=>fe(n).map(t=>Object.assign(Object.assign({},t?.props),{key:t.key}));function Le(n,t,i){const a=l.useMemo(()=>t||Fe(i),[t,i]);return l.useMemo(()=>a.map(g=>{var{span:m}=g,v=Ae(g,["span"]);return m==="filled"?Object.assign(Object.assign({},v),{filled:!0}):Object.assign(Object.assign({},v),{span:typeof m=="number"?m:de(n,m)})}),[a,n])}var qe=function(n,t){var i={};for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&t.indexOf(a)<0&&(i[a]=n[a]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,a=Object.getOwnPropertySymbols(n);r<a.length;r++)t.indexOf(a[r])<0&&Object.prototype.propertyIsEnumerable.call(n,a[r])&&(i[a[r]]=n[a[r]]);return i};function Ve(n,t){let i=[],a=[],r=!1,g=0;return n.filter(m=>m).forEach(m=>{const{filled:v}=m,b=qe(m,["filled"]);if(v){a.push(b),i.push(a),a=[],g=0;return}const p=t-g;g+=m.span||1,g>=t?(g>t?(r=!0,a.push(Object.assign(Object.assign({},b),{span:p}))):a.push(b),i.push(a),a=[],g=0):a.push(b)}),a.length>0&&i.push(a),i=i.map(m=>{const v=m.reduce((b,p)=>b+(p.span||1),0);if(v<t){const b=m[m.length-1];return b.span=t-(v-(b.span||1)),m}return m}),[i,r]}const ke=(n,t)=>{const[i,a]=l.useMemo(()=>Ve(t,n),[t,n]);return i},He=({children:n})=>n,J=n=>n!=null,ee=n=>{const{itemPrefixCls:t,component:i,span:a,className:r,style:g,labelStyle:m,contentStyle:v,bordered:b,label:p,content:d,colon:S,type:h,styles:c}=n,w=i,{classNames:s}=l.useContext(re),$=Object.assign(Object.assign({},m),c?.label),y=Object.assign(Object.assign({},v),c?.content);return b?l.createElement(w,{colSpan:a,style:g,className:A(r,{[`${t}-item-${h}`]:h==="label"||h==="content",[s?.label]:s?.label&&h==="label",[s?.content]:s?.content&&h==="content"})},J(p)&&l.createElement("span",{style:$},p),J(d)&&l.createElement("span",{style:y},d)):l.createElement(w,{colSpan:a,style:g,className:A(`${t}-item`,r)},l.createElement("div",{className:`${t}-item-container`},J(p)&&l.createElement("span",{style:$,className:A(`${t}-item-label`,s?.label,{[`${t}-item-no-colon`]:!S})},p),J(d)&&l.createElement("span",{style:y,className:A(`${t}-item-content`,s?.content)},d)))};function te(n,{colon:t,prefixCls:i,bordered:a},{component:r,type:g,showLabel:m,showContent:v,labelStyle:b,contentStyle:p,styles:d}){return n.map(({label:S,children:h,prefixCls:c=i,className:w,style:s,labelStyle:$,contentStyle:y,span:z=1,key:x,styles:_},E)=>typeof r=="string"?l.createElement(ee,{key:`${g}-${x||E}`,className:w,style:s,styles:{label:Object.assign(Object.assign(Object.assign(Object.assign({},b),d?.label),$),_?.label),content:Object.assign(Object.assign(Object.assign(Object.assign({},p),d?.content),y),_?.content)},span:z,colon:t,component:r,itemPrefixCls:c,bordered:a,label:m?S:null,content:v?h:null,type:g}):[l.createElement(ee,{key:`label-${x||E}`,className:w,style:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},b),d?.label),s),$),_?.label),span:1,colon:t,component:r[0],itemPrefixCls:c,bordered:a,label:S,type:"label"}),l.createElement(ee,{key:`content-${x||E}`,className:w,style:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},p),d?.content),s),y),_?.content),span:z*2-1,component:r[1],itemPrefixCls:c,bordered:a,content:h,type:"content"})])}const De=n=>{const t=l.useContext(re),{prefixCls:i,vertical:a,row:r,index:g,bordered:m}=n;return a?l.createElement(l.Fragment,null,l.createElement("tr",{key:`label-${g}`,className:`${i}-row`},te(r,n,Object.assign({component:"th",type:"label",showLabel:!0},t))),l.createElement("tr",{key:`content-${g}`,className:`${i}-row`},te(r,n,Object.assign({component:"td",type:"content",showContent:!0},t)))):l.createElement("tr",{key:g,className:`${i}-row`},te(r,n,Object.assign({component:m?["th","td"]:"td",type:"item",showLabel:!0,showContent:!0},t)))},We=n=>{const{componentCls:t,labelBg:i}=n;return{[`&${t}-bordered`]:{[`> ${t}-view`]:{border:`${R(n.lineWidth)} ${n.lineType} ${n.colorSplit}`,"> table":{tableLayout:"auto"},[`${t}-row`]:{borderBottom:`${R(n.lineWidth)} ${n.lineType} ${n.colorSplit}`,"&:first-child":{"> th:first-child, > td:first-child":{borderStartStartRadius:n.borderRadiusLG}},"&:last-child":{borderBottom:"none","> th:first-child, > td:first-child":{borderEndStartRadius:n.borderRadiusLG}},[`> ${t}-item-label, > ${t}-item-content`]:{padding:`${R(n.padding)} ${R(n.paddingLG)}`,borderInlineEnd:`${R(n.lineWidth)} ${n.lineType} ${n.colorSplit}`,"&:last-child":{borderInlineEnd:"none"}},[`> ${t}-item-label`]:{color:n.colorTextSecondary,backgroundColor:i,"&::after":{display:"none"}}}},[`&${t}-middle`]:{[`${t}-row`]:{[`> ${t}-item-label, > ${t}-item-content`]:{padding:`${R(n.paddingSM)} ${R(n.paddingLG)}`}}},[`&${t}-small`]:{[`${t}-row`]:{[`> ${t}-item-label, > ${t}-item-content`]:{padding:`${R(n.paddingXS)} ${R(n.padding)}`}}}}}},Ye=n=>{const{componentCls:t,extraColor:i,itemPaddingBottom:a,itemPaddingEnd:r,colonMarginRight:g,colonMarginLeft:m,titleMarginBottom:v}=n;return{[t]:Object.assign(Object.assign(Object.assign({},ve(n)),We(n)),{"&-rtl":{direction:"rtl"},[`${t}-header`]:{display:"flex",alignItems:"center",marginBottom:v},[`${t}-title`]:Object.assign(Object.assign({},_e),{flex:"auto",color:n.titleColor,fontWeight:n.fontWeightStrong,fontSize:n.fontSizeLG,lineHeight:n.lineHeightLG}),[`${t}-extra`]:{marginInlineStart:"auto",color:i,fontSize:n.fontSize},[`${t}-view`]:{width:"100%",borderRadius:n.borderRadiusLG,table:{width:"100%",tableLayout:"fixed",borderCollapse:"collapse"}},[`${t}-row`]:{"> th, > td":{paddingBottom:a,paddingInlineEnd:r},"> th:last-child, > td:last-child":{paddingInlineEnd:0},"&:last-child":{borderBottom:"none","> th, > td":{paddingBottom:0}}},[`${t}-item-label`]:{color:n.labelColor,fontWeight:"normal",fontSize:n.fontSize,lineHeight:n.lineHeight,textAlign:"start","&::after":{content:'":"',position:"relative",top:-.5,marginInline:`${R(m)} ${R(g)}`},[`&${t}-item-no-colon::after`]:{content:'""'}},[`${t}-item-no-label`]:{"&::after":{margin:0,content:'""'}},[`${t}-item-content`]:{display:"table-cell",flex:1,color:n.contentColor,fontSize:n.fontSize,lineHeight:n.lineHeight,wordBreak:"break-word",overflowWrap:"break-word"},[`${t}-item`]:{paddingBottom:0,verticalAlign:"top","&-container":{display:"flex",[`${t}-item-label`]:{display:"inline-flex",alignItems:"baseline"},[`${t}-item-content`]:{display:"inline-flex",alignItems:"baseline",minWidth:"1em"}}},"&-middle":{[`${t}-row`]:{"> th, > td":{paddingBottom:n.paddingSM}}},"&-small":{[`${t}-row`]:{"> th, > td":{paddingBottom:n.paddingXS}}}})}},Ge=n=>({labelBg:n.colorFillAlter,labelColor:n.colorTextTertiary,titleColor:n.colorText,titleMarginBottom:n.fontSizeSM*n.lineHeightSM,itemPaddingBottom:n.padding,itemPaddingEnd:n.padding,colonMarginRight:n.marginXS,colonMarginLeft:n.marginXXS/2,contentColor:n.colorText,extraColor:n.colorText}),Xe=ye("Descriptions",n=>{const t=je(n,{});return Ye(t)},Ge);var Ke=function(n,t){var i={};for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&t.indexOf(a)<0&&(i[a]=n[a]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,a=Object.getOwnPropertySymbols(n);r<a.length;r++)t.indexOf(a[r])<0&&Object.prototype.propertyIsEnumerable.call(n,a[r])&&(i[a[r]]=n[a[r]]);return i};const X=n=>{const{prefixCls:t,title:i,extra:a,column:r,colon:g=!0,bordered:m,layout:v,children:b,className:p,rootClassName:d,style:S,size:h,labelStyle:c,contentStyle:w,styles:s,items:$,classNames:y}=n,z=Ke(n,["prefixCls","title","extra","column","colon","bordered","layout","children","className","rootClassName","style","size","labelStyle","contentStyle","styles","items","classNames"]),{getPrefixCls:x,direction:_,className:E,style:F,classNames:M,styles:C}=Se("descriptions"),o=x("descriptions",t),f=we(),N=l.useMemo(()=>{var P;return typeof r=="number"?r:(P=de(f,Object.assign(Object.assign({},Be),r)))!==null&&P!==void 0?P:3},[f,r]),B=Le(f,$,b),Y=Ce(h),U=ke(N,B),[Z,u,j]=Xe(o),q=l.useMemo(()=>({labelStyle:c,contentStyle:w,styles:{content:Object.assign(Object.assign({},C.content),s?.content),label:Object.assign(Object.assign({},C.label),s?.label)},classNames:{label:A(M.label,y?.label),content:A(M.content,y?.content)}}),[c,w,s,y,M,C]);return Z(l.createElement(re.Provider,{value:q},l.createElement("div",Object.assign({className:A(o,E,M.root,y?.root,{[`${o}-${Y}`]:Y&&Y!=="default",[`${o}-bordered`]:!!m,[`${o}-rtl`]:_==="rtl"},p,d,u,j),style:Object.assign(Object.assign(Object.assign(Object.assign({},F),C.root),s?.root),S)},z),(i||a)&&l.createElement("div",{className:A(`${o}-header`,M.header,y?.header),style:Object.assign(Object.assign({},C.header),s?.header)},i&&l.createElement("div",{className:A(`${o}-title`,M.title,y?.title),style:Object.assign(Object.assign({},C.title),s?.title)},i),a&&l.createElement("div",{className:A(`${o}-extra`,M.extra,y?.extra),style:Object.assign(Object.assign({},C.extra),s?.extra)},a)),l.createElement("div",{className:`${o}-view`},l.createElement("table",null,l.createElement("tbody",null,U.map((P,G)=>l.createElement(De,{key:G,index:G,colon:g,prefixCls:o,vertical:v==="vertical",bordered:m,row:P}))))))))};X.Item=He;var Qe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M696 480H544V328c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v152H328c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h152v152c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V544h152c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8z"}},{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"}}]},name:"plus-circle",theme:"outlined"},Je=function(t,i){return l.createElement(Oe,$e({},t,{ref:i,icon:Qe}))},Ue=l.forwardRef(Je);const{TextArea:Ze}=L,et=[{label:"样品",value:"sample"},{label:"耗材",value:"consumable"},{label:"试剂",value:"reagent"},{label:"工具",value:"tool"},{label:"其他",value:"other"}],tt=[{label:"已接收",value:"received"},{label:"入库",value:"in_storage"},{label:"已分配",value:"allocated"},{label:"使用中",value:"in_use"},{label:"待返还",value:"pending_return"},{label:"已返还",value:"returned"},{label:"已处置",value:"disposed"},{label:"遗失",value:"lost"}],nt=[{label:"件",value:"piece"},{label:"个",value:"unit"},{label:"片",value:"slice"},{label:"组",value:"set"},{label:"批",value:"batch"},{label:"毫升",value:"ml"},{label:"克",value:"g"}];function at({visible:n,material:t,sites:i,laboratories:a,clients:r,defaultMaterialType:g="sample",onSuccess:m,onCancel:v}){const[b]=O.useForm(),[p,d]=l.useState(!1),[S,h]=l.useState(),[c,w]=l.useState(g),{message:s}=W.useApp(),$=S?a.filter(x=>x.site_id===S):a;l.useEffect(()=>{n&&(t?(h(t.site_id),w(t.material_type),b.setFieldsValue({...t,storage_deadline:t.storage_deadline?Q(t.storage_deadline):void 0,processing_deadline:t.processing_deadline?Q(t.processing_deadline):void 0})):(b.resetFields(),b.setFieldsValue({quantity:1,unit:"piece",material_type:g}),h(void 0),w(g)))},[n,t,b,g]);const y=x=>{h(x);const _=b.getFieldValue("laboratory_id");if(_){const E=a.find(F=>F.id===_);E&&E.site_id!==x&&b.setFieldValue("laboratory_id",void 0)}},z=async()=>{try{const x=await b.validateFields();d(!0);const _={...x,storage_deadline:x.storage_deadline?x.storage_deadline.toISOString():void 0,processing_deadline:x.processing_deadline?x.processing_deadline.toISOString():void 0};t?(await k.updateMaterial(t.id,_),s.success("更新成功")):(await k.createMaterial(_),s.success("创建成功")),m()}catch{s.error(t?"更新失败":"创建失败")}finally{d(!1)}};return e.jsx(le,{title:t?"编辑物料":"新增物料",open:n,onOk:z,onCancel:v,confirmLoading:p,width:800,okText:"确定",cancelText:"取消",destroyOnHidden:!0,children:e.jsxs(O,{form:b,layout:"vertical",children:[e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"基本信息"})}),e.jsxs(V,{gutter:16,children:[e.jsx(I,{span:8,children:e.jsx(O.Item,{name:"material_code",label:"物料编码",rules:[{required:!0,message:"请输入物料编码"}],children:e.jsx(L,{placeholder:"请输入物料编码",disabled:!!t})})}),e.jsx(I,{span:8,children:e.jsx(O.Item,{name:"name",label:"物料名称",rules:[{required:!0,message:"请输入物料名称"}],children:e.jsx(L,{placeholder:"请输入物料名称"})})}),e.jsx(I,{span:8,children:e.jsx(O.Item,{name:"material_type",label:"物料类型",rules:[{required:!0,message:"请选择物料类型"}],children:e.jsx(T,{placeholder:"请选择物料类型",options:et,disabled:!!t,onChange:x=>w(x)})})})]}),e.jsxs(V,{gutter:16,children:[e.jsx(I,{span:12,children:e.jsx(O.Item,{name:"site_id",label:"所属站点",rules:[{required:!0,message:"请选择所属站点"}],children:e.jsx(T,{placeholder:"请选择所属站点",onChange:y,disabled:!!t,showSearch:!0,optionFilterProp:"label",options:i.map(x=>({label:`${x.name} (${x.code})`,value:x.id}))})})}),e.jsx(I,{span:12,children:e.jsx(O.Item,{name:"laboratory_id",label:"所属实验室",rules:[{required:!0,message:"请选择所属实验室"}],children:e.jsx(T,{placeholder:"请先选择所属站点",disabled:!S||!!t,showSearch:!0,optionFilterProp:"label",options:$.map(x=>({label:`${x.name} (${x.code})`,value:x.id}))})})})]}),e.jsx(O.Item,{name:"description",label:"描述",children:e.jsx(Ze,{rows:2,placeholder:"请输入物料描述"})}),e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16,marginTop:24},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"存储与数量"})}),e.jsxs(V,{gutter:16,children:[e.jsx(I,{span:8,children:e.jsx(O.Item,{name:"storage_location",label:"存储位置",children:e.jsx(L,{placeholder:"请输入存储位置"})})}),e.jsx(I,{span:8,children:e.jsx(O.Item,{name:"quantity",label:"数量",children:e.jsx(me,{min:1,placeholder:"数量",style:{width:"100%"}})})}),e.jsx(I,{span:8,children:e.jsx(O.Item,{name:"unit",label:"单位",children:e.jsx(T,{placeholder:"请选择单位",options:nt})})})]}),c==="sample"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16,marginTop:24},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"客户信息"})}),e.jsxs(V,{gutter:16,children:[e.jsx(I,{span:12,children:e.jsx(O.Item,{name:"client_id",label:"客户",children:e.jsx(T,{placeholder:"请选择客户",allowClear:!0,showSearch:!0,optionFilterProp:"label",options:r.map(x=>({label:`${x.name} (${x.code})`,value:x.id}))})})}),e.jsx(I,{span:12,children:e.jsx(O.Item,{name:"client_reference",label:"客户参考号",children:e.jsx(L,{placeholder:"客户的参考编号"})})})]})]}),e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16,marginTop:24},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"时间要求"})}),e.jsxs(V,{gutter:16,children:[e.jsx(I,{span:8,children:e.jsx(O.Item,{name:"storage_deadline",label:"存储期限",children:e.jsx(ne,{style:{width:"100%"},placeholder:"存储截止日期"})})}),e.jsx(I,{span:8,children:e.jsx(O.Item,{name:"processing_deadline",label:"处理期限",children:e.jsx(ne,{style:{width:"100%"},placeholder:"处理截止日期"})})}),t&&e.jsx(I,{span:8,children:e.jsx(O.Item,{name:"status",label:"状态",children:e.jsx(T,{placeholder:"请选择状态",options:tt})})})]})]})})}const oe={received:{text:"已接收",color:"blue"},in_storage:{text:"入库",color:"cyan"},allocated:{text:"已分配",color:"purple"},in_use:{text:"使用中",color:"blue"},pending_return:{text:"待返还",color:"warning"},returned:{text:"已返还",color:"success"},disposed:{text:"已处置",color:"default"},lost:{text:"遗失",color:"red"}};function lt({laboratories:n,clients:t,onAdd:i,onEdit:a}){const[r,g]=l.useState([]),[m,v]=l.useState(!1),[b,p]=l.useState({current:1,pageSize:10,total:0}),[d,S]=l.useState({search:"",overdue_only:!1}),[h,c]=l.useState(""),{message:w}=W.useApp(),s=l.useRef(null),$=l.useCallback(async(o=1,f=10,N)=>{v(!0);try{const B=await k.getMaterials({page:o,page_size:f,search:d.search||void 0,laboratory_id:d.laboratory_id,client_id:d.client_id,material_type:"sample",status:d.status,overdue_only:d.overdue_only,signal:N});g(B.items),p({current:B.page,pageSize:B.page_size,total:B.total})}catch(B){D(B)||w.error("获取样品列表失败")}finally{v(!1)}},[d,w]);l.useEffect(()=>{s.current&&s.current.abort();const o=new AbortController;return s.current=o,$(b.current,b.pageSize,o.signal),()=>{o.abort()}},[d]),l.useEffect(()=>{const o=setTimeout(()=>{h!==d.search&&S(f=>({...f,search:h}))},300);return()=>clearTimeout(o)},[h,d.search]);const y=o=>{s.current&&s.current.abort();const f=new AbortController;s.current=f,$(o.current,o.pageSize,f.signal)},z=o=>{S(f=>({...f,laboratory_id:o}))},x=o=>{S(f=>({...f,client_id:o}))},_=o=>{S(f=>({...f,status:o}))},E=o=>{S(f=>({...f,overdue_only:o}))},F=o=>{const f=n.find(N=>N.id===o);return f?f.name:"-"},M=o=>{if(!o)return"-";const f=t.find(N=>N.id===o);return f?f.name:"-"},C=[{title:"物料编码",dataIndex:"material_code",key:"material_code",width:120},{title:"名称",dataIndex:"name",key:"name",width:180},{title:"实验室",dataIndex:"laboratory_id",key:"laboratory_id",width:90,render:o=>F(o)},{title:"客户",dataIndex:"client_id",key:"client_id",width:120,render:o=>M(o)},{title:"数量",key:"quantity",width:80,render:(o,f)=>`${f.quantity} ${f.unit}`},{title:"存储位置",dataIndex:"storage_location",key:"storage_location",width:100,render:o=>o||"-"},{title:"状态",dataIndex:"status",key:"status",width:90,render:o=>{const f=o,N=oe[f]||{text:f,color:"default"};return e.jsx(ae,{color:N.color,children:N.text})}},{title:"操作",key:"action",width:80,render:(o,f)=>e.jsx(H,{type:"link",size:"small",icon:e.jsx(ge,{}),onClick:()=>a(f),children:"编辑"})}];return l.useEffect(()=>{},[]),e.jsxs("div",{children:[e.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between"},children:[e.jsxs(K,{wrap:!0,children:[e.jsx(L,{placeholder:"搜索物料编码或名称",prefix:e.jsx(ue,{}),value:h,onChange:o=>c(o.target.value),style:{width:200},allowClear:!0}),e.jsx(T,{placeholder:"实验室",value:d.laboratory_id,onChange:z,style:{width:160},allowClear:!0,options:n.map(o=>({label:`${o.name} (${o.code})`,value:o.id}))}),e.jsx(T,{placeholder:"客户",value:d.client_id,onChange:x,style:{width:150},allowClear:!0,options:t.map(o=>({label:o.name,value:o.id}))}),e.jsx(T,{placeholder:"状态",value:d.status,onChange:_,style:{width:100},allowClear:!0,options:Object.entries(oe).map(([o,f])=>({label:f.text,value:o}))}),e.jsxs(K,{children:[e.jsx("span",{style:{fontSize:14,color:"#666"},children:"仅逾期:"}),e.jsx(he,{checked:d.overdue_only,onChange:E,size:"small"})]})]}),e.jsx(H,{type:"primary",icon:e.jsx(pe,{}),onClick:i,children:"新增样品"})]}),e.jsx(se,{columns:C,dataSource:r,rowKey:"id",loading:m,pagination:{...b,showSizeChanger:!0,showQuickJumper:!0,showTotal:o=>`共 ${o} 条`},onChange:y,scroll:{x:1e3}})]})}const{TextArea:st}=L,rt=[{label:"内部转移",value:"internal_transfer"},{label:"紧急采购",value:"emergency_purchase"},{label:"赠品/样品",value:"gift_sample"},{label:"库存盘点调整",value:"inventory_adjustment"},{label:"其他",value:"other"}];function ot({visible:n,material:t,onSuccess:i,onCancel:a}){const[r]=O.useForm(),[g,m]=l.useState(!1),[v,b]=l.useState(""),{message:p}=W.useApp();l.useEffect(()=>{n&&(r.resetFields(),r.setFieldsValue({received_date:Q(),quantity_added:1}),b(""))},[n,r]);const d=h=>{const c=h.target.value;b(c),r.setFieldValue("sap_order_no",c),r.validateFields(["non_sap_source"])},S=async()=>{if(t)try{const h=await r.validateFields();if(!h.sap_order_no&&!h.non_sap_source){p.error("SAP订单号和非SAP来源至少填写一个");return}m(!0);const c={received_date:h.received_date.toISOString(),quantity_added:h.quantity_added,sap_order_no:h.sap_order_no||void 0,non_sap_source:h.non_sap_source||void 0,notes:h.notes||void 0};await k.replenishMaterial(t.id,c),p.success(`补充成功，库存已更新为 ${t.quantity+h.quantity_added} ${t.unit}`),i()}catch(h){h instanceof Error?p.error(h.message||"补充失败"):p.error("补充失败")}finally{m(!1)}};return e.jsx(le,{title:"补充物料",open:n,onOk:S,onCancel:a,confirmLoading:g,width:600,okText:"确定补充",cancelText:"取消",destroyOnHidden:!0,children:t&&e.jsxs(e.Fragment,{children:[e.jsxs(X,{bordered:!0,size:"small",column:2,style:{marginBottom:24},children:[e.jsx(X.Item,{label:"物料编码",children:t.material_code}),e.jsx(X.Item,{label:"名称",children:t.name}),e.jsx(X.Item,{label:"当前库存",span:2,children:e.jsxs("span",{style:{fontWeight:600,fontSize:16,color:"#1677ff"},children:[t.quantity," ",t.unit]})})]}),e.jsxs(O,{form:r,layout:"vertical",children:[e.jsxs(V,{gutter:16,children:[e.jsx(I,{span:12,children:e.jsx(O.Item,{name:"received_date",label:"收货日期",rules:[{required:!0,message:"请选择收货日期"}],children:e.jsx(ne,{style:{width:"100%"},placeholder:"请选择收货日期"})})}),e.jsx(I,{span:12,children:e.jsx(O.Item,{name:"quantity_added",label:`增加数量 (${t.unit})`,rules:[{required:!0,message:"请输入增加数量"},{type:"number",min:1,message:"数量必须大于0"}],children:e.jsx(me,{min:1,placeholder:"请输入增加数量",style:{width:"100%"}})})})]}),e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"来源信息（至少填写一项）"})}),e.jsxs(V,{gutter:16,children:[e.jsx(I,{span:12,children:e.jsx(O.Item,{name:"sap_order_no",label:"SAP订单号",children:e.jsx(L,{placeholder:"请输入SAP订单号",maxLength:100,onChange:d})})}),e.jsx(I,{span:12,children:e.jsx(O.Item,{name:"non_sap_source",label:"非SAP来源",rules:[{validator:(h,c)=>!r.getFieldValue("sap_order_no")&&!c?Promise.reject(new Error("当SAP订单号为空时，必须选择非SAP来源")):Promise.resolve()}],children:e.jsx(T,{placeholder:v?"选填":"请选择来源",allowClear:!0,options:rt})})})]}),e.jsx(O.Item,{name:"notes",label:"备注",children:e.jsx(st,{rows:3,placeholder:"请输入备注信息（可选）"})})]})]})})}const it={internal_transfer:{text:"内部转移",color:"blue"},emergency_purchase:{text:"紧急采购",color:"orange"},gift_sample:{text:"赠品/样品",color:"green"},inventory_adjustment:{text:"库存盘点调整",color:"purple"},other:{text:"其他",color:"default"}};function ct({visible:n,material:t,onClose:i}){const[a,r]=l.useState([]),[g,m]=l.useState(!1),[v,b]=l.useState({current:1,pageSize:10,total:0}),{message:p}=W.useApp();l.useEffect(()=>{n&&t&&d(1,10)},[n,t]);const d=async(c,w)=>{if(t){m(!0);try{const s=await k.getReplenishments(t.id,{page:c,page_size:w});r(s.items),b({current:s.page,pageSize:s.page_size,total:s.total})}catch(s){D(s)||p.error("获取补充履历失败")}finally{m(!1)}}},S=c=>{d(c.current||1,c.pageSize||10)},h=[{title:"收货日期",dataIndex:"received_date",key:"received_date",width:120,render:c=>Q(c).format("YYYY-MM-DD")},{title:"增加数量",dataIndex:"quantity_added",key:"quantity_added",width:100,render:c=>e.jsxs("span",{style:{fontWeight:600,color:"#52c41a"},children:["+",c," ",t?.unit]})},{title:"SAP订单号",dataIndex:"sap_order_no",key:"sap_order_no",width:130,render:c=>c||"-"},{title:"非SAP来源",dataIndex:"non_sap_source",key:"non_sap_source",width:120,render:c=>{if(!c)return"-";const w=it[c];return e.jsx(ae,{color:w.color,children:w.text})}},{title:"操作人",key:"created_by",width:100,render:(c,w)=>w.created_by?.full_name||w.created_by?.username||"-"},{title:"操作时间",dataIndex:"created_at",key:"created_at",width:150,render:c=>Q(c).format("YYYY-MM-DD HH:mm")},{title:"备注",dataIndex:"notes",key:"notes",width:150,ellipsis:!0,render:c=>c?e.jsx(Ie,{title:c,children:e.jsx("span",{children:c})}):"-"}];return e.jsxs(le,{title:`补充履历 - ${t?.name||""}`,open:n,onCancel:i,footer:null,width:900,destroyOnHidden:!0,children:[t&&e.jsxs("div",{style:{marginBottom:16,padding:"12px 16px",background:"#f5f5f5",borderRadius:6},children:[e.jsxs("span",{style:{marginRight:24},children:[e.jsx("strong",{children:"物料编码:"})," ",t.material_code]}),e.jsxs("span",{style:{marginRight:24},children:[e.jsx("strong",{children:"当前库存:"})," ",e.jsxs("span",{style:{color:"#1677ff",fontWeight:600},children:[t.quantity," ",t.unit]})]})]}),a.length===0&&!g?e.jsx(Te,{description:"暂无补充记录"}):e.jsx(se,{columns:h,dataSource:a,rowKey:"id",loading:g,pagination:{...v,showSizeChanger:!0,showQuickJumper:!0,showTotal:c=>`共 ${c} 条记录`},onChange:S,scroll:{x:900},size:"small"})]})}const ie={consumable:"耗材",reagent:"试剂",tool:"工具",other:"其他"},ce={received:{text:"已接收",color:"blue"},in_storage:{text:"入库",color:"cyan"},allocated:{text:"已分配",color:"purple"},in_use:{text:"使用中",color:"blue"},pending_return:{text:"待返还",color:"warning"},returned:{text:"已返还",color:"success"},disposed:{text:"已处置",color:"default"},lost:{text:"遗失",color:"red"}};function dt({laboratories:n,onAdd:t,onEdit:i}){const[a,r]=l.useState([]),[g,m]=l.useState(!1),[v,b]=l.useState({current:1,pageSize:10,total:0}),[p,d]=l.useState({search:"",overdue_only:!1}),[S,h]=l.useState(""),[c,w]=l.useState(!1),[s,$]=l.useState(!1),[y,z]=l.useState(null),{message:x}=W.useApp(),_=l.useRef(null),E=l.useCallback(async(u=1,j=10,q)=>{m(!0);try{const P=await k.getMaterials({page:u,page_size:j,search:p.search||void 0,laboratory_id:p.laboratory_id,material_type:p.material_type,status:p.status,overdue_only:p.overdue_only,signal:q}),G=p.material_type?P.items:P.items.filter(be=>be.material_type!=="sample");r(G),b({current:P.page,pageSize:P.page_size,total:p.material_type?P.total:G.length})}catch(P){D(P)||x.error("获取材料列表失败")}finally{m(!1)}},[p,x]);l.useEffect(()=>{_.current&&_.current.abort();const u=new AbortController;return _.current=u,E(v.current,v.pageSize,u.signal),()=>{u.abort()}},[p]),l.useEffect(()=>{const u=setTimeout(()=>{S!==p.search&&d(j=>({...j,search:S}))},300);return()=>clearTimeout(u)},[S,p.search]);const F=u=>{_.current&&_.current.abort();const j=new AbortController;_.current=j,E(u.current,u.pageSize,j.signal)},M=u=>{d(j=>({...j,laboratory_id:u}))},C=u=>{d(j=>({...j,material_type:u}))},o=u=>{d(j=>({...j,status:u}))},f=u=>{d(j=>({...j,overdue_only:u}))},N=u=>{z(u),w(!0)},B=u=>{z(u),$(!0)},Y=()=>{w(!1),z(null),E(v.current,v.pageSize)},U=u=>{const j=n.find(q=>q.id===u);return j?j.name:"-"},Z=[{title:"物料编码",dataIndex:"material_code",key:"material_code",width:120},{title:"名称",dataIndex:"name",key:"name",width:180},{title:"类型",dataIndex:"material_type",key:"material_type",width:80,render:u=>ie[u]||u},{title:"实验室",dataIndex:"laboratory_id",key:"laboratory_id",width:90,render:u=>U(u)},{title:"库存",key:"quantity",width:100,render:(u,j)=>e.jsxs("span",{style:{fontWeight:600},children:[j.quantity," ",j.unit]})},{title:"存储位置",dataIndex:"storage_location",key:"storage_location",width:100,render:u=>u||"-"},{title:"状态",dataIndex:"status",key:"status",width:90,render:u=>{const j=u,q=ce[j]||{text:j,color:"default"};return e.jsx(ae,{color:q.color,children:q.text})}},{title:"操作",key:"action",width:200,render:(u,j)=>e.jsxs(K,{size:"small",children:[e.jsx(H,{type:"link",size:"small",icon:e.jsx(ge,{}),onClick:()=>i(j),children:"编辑"}),e.jsx(H,{type:"link",size:"small",icon:e.jsx(Ue,{}),onClick:()=>N(j),children:"补充"}),e.jsx(H,{type:"link",size:"small",icon:e.jsx(Ne,{}),onClick:()=>B(j),children:"履历"})]})}];return e.jsxs("div",{children:[e.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between"},children:[e.jsxs(K,{wrap:!0,children:[e.jsx(L,{placeholder:"搜索物料编码或名称",prefix:e.jsx(ue,{}),value:S,onChange:u=>h(u.target.value),style:{width:200},allowClear:!0}),e.jsx(T,{placeholder:"实验室",value:p.laboratory_id,onChange:M,style:{width:160},allowClear:!0,options:n.map(u=>({label:`${u.name} (${u.code})`,value:u.id}))}),e.jsx(T,{placeholder:"类型",value:p.material_type,onChange:C,style:{width:100},allowClear:!0,options:Object.entries(ie).map(([u,j])=>({label:j,value:u}))}),e.jsx(T,{placeholder:"状态",value:p.status,onChange:o,style:{width:100},allowClear:!0,options:Object.entries(ce).map(([u,j])=>({label:j.text,value:u}))}),e.jsxs(K,{children:[e.jsx("span",{style:{fontSize:14,color:"#666"},children:"仅逾期:"}),e.jsx(he,{checked:p.overdue_only,onChange:f,size:"small"})]})]}),e.jsx(H,{type:"primary",icon:e.jsx(pe,{}),onClick:t,children:"新增材料"})]}),e.jsx(se,{columns:Z,dataSource:a,rowKey:"id",loading:g,pagination:{...v,showSizeChanger:!0,showQuickJumper:!0,showTotal:u=>`共 ${u} 条`},onChange:F,scroll:{x:1100}}),e.jsx(ot,{visible:c,material:y,onSuccess:Y,onCancel:()=>{w(!1),z(null)}}),e.jsx(ct,{visible:s,material:y,onClose:()=>{$(!1),z(null)}})]})}function Ct(){const[n,t]=l.useState("samples"),[i,a]=l.useState([]),[r,g]=l.useState([]),[m,v]=l.useState([]),[b,p]=l.useState(!1),[d,S]=l.useState(null),[h,c]=l.useState("sample"),{message:w}=W.useApp(),s=l.useCallback(async()=>{try{const C=await Pe.getAllSites();a(C)}catch(C){D(C)||console.error("Failed to fetch sites")}},[]),$=l.useCallback(async()=>{try{const C=await Me.getLaboratories({page:1,page_size:100});g(C.items)}catch(C){D(C)||console.error("Failed to fetch laboratories")}},[]),y=l.useCallback(async()=>{try{const C=await k.getAllClients();v(C)}catch(C){D(C)||console.error("Failed to fetch clients")}},[]);l.useEffect(()=>{s(),$(),y()},[s,$,y]);const z=()=>{S(null),c("sample"),p(!0)},x=()=>{S(null),c("consumable"),p(!0)},_=C=>{S(C),p(!0)},E=()=>{p(!1),S(null),w.success(d?"更新成功":"创建成功")},F=()=>{p(!1),S(null)},M=[{key:"samples",label:e.jsxs("span",{children:[e.jsx(Re,{}),"样品管理"]}),children:e.jsx(lt,{laboratories:r,clients:m,onAdd:z,onEdit:_})},{key:"materials",label:e.jsxs("span",{children:[e.jsx(Ee,{}),"材料管理"]}),children:e.jsx(dt,{laboratories:r,onAdd:x,onEdit:_})}];return e.jsxs("div",{children:[e.jsx(ze,{activeKey:n,onChange:C=>t(C),items:M}),e.jsx(at,{visible:b,material:d,sites:i,laboratories:r,clients:m,defaultMaterialType:h,onSuccess:E,onCancel:F})]})}export{Ct as default};
