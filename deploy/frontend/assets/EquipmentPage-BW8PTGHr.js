import{a6 as d,r as a,a7 as X,N as O,P as e,V as K,W as g,a8 as M,a2 as ve,Q as L,af as we,ag as Ce,U as Se,A as ke,a0 as he,X as xe,aa as le,S as Z,a9 as be,O as te,ah as Ie,a4 as Ee}from"./index-DVAH8G0d.js";import{e as F}from"./equipmentService-ABHB664f.js";import{s as Fe}from"./siteService-Bv2y8QeO.js";import{l as _e}from"./laboratoryService-B77Lyyfa.js";import{M as me}from"./index-D5-92eMw.js";import{S as E,F as oe}from"./Table-BH_IQYSB.js";import{T as U}from"./index-fw1Ls6Om.js";import{D as ae,R as Te}from"./index-Bd8ohf4A.js";import{S as se}from"./index-C-m9zxKZ.js";import{R as $e}from"./ReloadOutlined-Ci7PDsnU.js";import{S as de}from"./StatusTag-CYqPBP0F.js";import{R as ce}from"./EditOutlined-BO1KRQYy.js";import{P as ue}from"./index-BDasguwL.js";import{R as pe}from"./DeleteOutlined-DADLfnzs.js";import{R as qe}from"./UnorderedListOutlined-p92xOUYH.js";import"./CheckOutlined-CP9fMx1j.js";import"./ClockCircleOutlined-C4lKWGcp.js";const{TextArea:ze}=M,Le=[{label:"自主运行设备",value:"autonomous"},{label:"操作员依赖设备",value:"operator_dependent"}],Me=[{label:"可用",value:"available"},{label:"使用中",value:"in_use"},{label:"维护中",value:"maintenance"},{label:"停用",value:"out_of_service"},{label:"已预约",value:"reserved"}];function De({visible:m,equipment:i,sites:D,laboratories:T,onSuccess:y,onCancel:v}){const[h]=d.useForm(),[w,$]=a.useState(!1),[u,I]=a.useState(),[l,A]=a.useState([]),[f,b]=a.useState([]),[x,p]=a.useState(),{message:S}=X.useApp(),R=u?T.filter(r=>r.site_id===u):T,N=a.useCallback(async()=>{try{const r=await F.getEquipmentCategories(!0);A(r)}catch{console.error("Failed to fetch categories")}},[]),j=a.useCallback(async r=>{try{const k=await F.getEquipmentNamesByCategory(r);b(k.filter(B=>B.is_active))}catch{console.error("Failed to fetch equipment names")}},[]);a.useEffect(()=>{m&&N()},[m,N]),a.useEffect(()=>{x?j(x):b([])},[x,j]),a.useEffect(()=>{m&&(i?(I(i.site_id),p(i.category_id),h.setFieldsValue({...i,purchase_date:i.purchase_date?O(i.purchase_date):void 0,warranty_expiry:i.warranty_expiry?O(i.warranty_expiry):void 0})):(h.resetFields(),h.setFieldsValue({max_concurrent_tasks:1,is_active:!0}),I(void 0),p(void 0),b([])))},[m,i,h]);const C=r=>{I(r);const k=h.getFieldValue("laboratory_id");if(k){const B=T.find(W=>W.id===k);B&&B.site_id!==r&&h.setFieldValue("laboratory_id",void 0)}},q=r=>{p(r),h.setFieldValue("equipment_name_id",void 0),h.setFieldValue("name",void 0)},V=r=>{if(r){const k=f.find(B=>B.id===r);k&&h.setFieldValue("name",k.name)}else h.setFieldValue("name",void 0)},P=async()=>{try{const r=await h.validateFields();$(!0);const k={...r,purchase_date:r.purchase_date?r.purchase_date.toISOString():void 0,warranty_expiry:r.warranty_expiry?r.warranty_expiry.toISOString():void 0};i?(await F.updateEquipment(i.id,k),S.success("更新成功")):(await F.createEquipment(k),S.success("创建成功")),y()}catch(r){if(r&&typeof r=="object"&&"errorFields"in r)return;S.error(i?"更新失败":"创建失败")}finally{$(!1)}};return e.jsx(me,{title:i?"编辑设备":"新增设备",open:m,onOk:P,onCancel:v,confirmLoading:w,width:800,okText:"确定",cancelText:"取消",destroyOnHidden:!0,children:e.jsxs(d,{form:h,layout:"vertical",children:[e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"基本信息"})}),e.jsxs(K,{gutter:16,children:[e.jsx(g,{span:6,children:e.jsx(d.Item,{name:"category_id",label:"设备类别",rules:[{required:!0,message:"请选择设备类别"}],children:e.jsx(E,{placeholder:"请选择设备类别",showSearch:!0,optionFilterProp:"label",onChange:q,options:l.map(r=>({label:r.name,value:r.id}))})})}),e.jsx(g,{span:6,children:e.jsx(d.Item,{name:"equipment_name_id",label:"设备名称",rules:[{required:!0,message:"请选择设备名称"}],children:e.jsx(E,{placeholder:x?"请选择设备名称":"请先选择类别",disabled:!x,showSearch:!0,optionFilterProp:"label",onChange:V,options:f.map(r=>({label:r.name,value:r.id}))})})}),e.jsx(g,{span:6,children:e.jsx(d.Item,{name:"code",label:"设备编号",rules:[{required:!0,message:"请输入设备编号"}],children:e.jsx(M,{placeholder:"请输入设备编号"})})}),e.jsx(g,{span:6,children:e.jsx(d.Item,{name:"equipment_type",label:"设备类型",rules:[{required:!0,message:"请选择设备类型"}],children:e.jsx(E,{placeholder:"请选择设备类型",options:Le})})})]}),e.jsx(d.Item,{name:"name",hidden:!0,children:e.jsx(M,{})}),e.jsxs(K,{gutter:16,children:[e.jsx(g,{span:12,children:e.jsx(d.Item,{name:"site_id",label:"所属站点",rules:[{required:!0,message:"请选择所属站点"}],children:e.jsx(E,{placeholder:"请选择所属站点",onChange:C,showSearch:!0,optionFilterProp:"label",options:D.map(r=>({label:`${r.name} (${r.code})`,value:r.id}))})})}),e.jsx(g,{span:12,children:e.jsx(d.Item,{name:"laboratory_id",label:"所属实验室",rules:[{required:!0,message:"请选择所属实验室"}],children:e.jsx(E,{placeholder:"请先选择所属站点",disabled:!u,showSearch:!0,optionFilterProp:"label",options:R.map(r=>({label:`${r.name} (${r.code})`,value:r.id}))})})})]}),e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16,marginTop:24},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"设备详情"})}),e.jsxs(K,{gutter:16,children:[e.jsx(g,{span:8,children:e.jsx(d.Item,{name:"model",label:"型号",children:e.jsx(M,{placeholder:"请输入型号"})})}),e.jsx(g,{span:8,children:e.jsx(d.Item,{name:"manufacturer",label:"制造商",children:e.jsx(M,{placeholder:"请输入制造商"})})}),e.jsx(g,{span:8,children:e.jsx(d.Item,{name:"serial_number",label:"序列号",children:e.jsx(M,{placeholder:"请输入序列号"})})})]}),e.jsx(d.Item,{name:"description",label:"描述",children:e.jsx(ze,{rows:2,placeholder:"请输入设备描述"})}),e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16,marginTop:24},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"性能参数"})}),e.jsxs(K,{gutter:16,children:[e.jsx(g,{span:6,children:e.jsx(d.Item,{name:"capacity",label:"容量",children:e.jsx(U,{min:1,placeholder:"最大容量",style:{width:"100%"}})})}),e.jsx(g,{span:6,children:e.jsx(d.Item,{name:"uph",label:"UPH (每小时产能)",children:e.jsx(U,{min:0,step:.1,placeholder:"每小时产能",style:{width:"100%"}})})}),e.jsx(g,{span:6,children:e.jsx(d.Item,{name:"max_concurrent_tasks",label:"最大并发任务",children:e.jsx(U,{min:1,placeholder:"并发任务数",style:{width:"100%"}})})}),i&&e.jsx(g,{span:6,children:e.jsx(d.Item,{name:"status",label:"状态",children:e.jsx(E,{placeholder:"请选择状态",options:Me})})})]}),e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16,marginTop:24},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"维保信息"})}),e.jsxs(K,{gutter:16,children:[e.jsx(g,{span:8,children:e.jsx(d.Item,{name:"purchase_date",label:"采购日期",children:e.jsx(ae,{style:{width:"100%"},placeholder:"请选择采购日期"})})}),e.jsx(g,{span:8,children:e.jsx(d.Item,{name:"warranty_expiry",label:"保修到期日",children:e.jsx(ae,{style:{width:"100%"},placeholder:"请选择保修到期日"})})}),e.jsx(g,{span:8,children:e.jsx(d.Item,{name:"maintenance_interval_days",label:"维护周期(天)",children:e.jsx(U,{min:1,placeholder:"维护周期",style:{width:"100%"}})})})]}),e.jsxs(K,{gutter:16,children:[e.jsx(g,{span:8,children:e.jsx(d.Item,{name:"calibration_interval_days",label:"校准周期(天)",children:e.jsx(U,{min:1,placeholder:"校准周期",style:{width:"100%"}})})}),i&&e.jsx(g,{span:8,children:e.jsx(d.Item,{name:"is_active",label:"启用状态",valuePropName:"checked",children:e.jsx(se,{checkedChildren:"启用",unCheckedChildren:"停用"})})})]})]})})}const Ae={scheduled:"已排程",in_progress:"进行中",completed:"已完成",cancelled:"已取消"},ne={1:"#ef4444",2:"#f97316",3:"#3b82f6",4:"#22c55e",5:"#6b7280"},ye={1:"紧急",2:"高",3:"正常",4:"低",5:"常规"},Be={autonomous:"自主运行",operator_dependent:"操作员依赖"},Oe={thermal:"热学设备",mechanical:"机械设备",electrical:"电学设备",optical:"光学设备",analytical:"分析设备",environmental:"环境设备",measurement:"测量设备",other:"其他"};function Re({laboratoryId:m}){const{message:i}=X.useApp(),D=ve(),[T,y]=a.useState(!1),[v,h]=a.useState([]),[w,$]=a.useState([]),[u,I]=a.useState(m),[l,A]=a.useState(void 0),[f,b]=a.useState(O().startOf("day")),[x,p]=a.useState(O().add(7,"day").endOf("day")),S=a.useMemo(()=>{const s=[];let c=f.startOf("day");const z=x.endOf("day");for(;c.isBefore(z)||c.isSame(z,"day");)s.push({date:c,label:c.format("MM/DD")}),c=c.add(1,"day");return s},[f,x]),N=S.length*24,j=a.useCallback(async()=>{try{const s=await _e.getLaboratories({page_size:100});h(s.items)}catch{console.error("Failed to fetch laboratories")}},[]),C=a.useCallback(async()=>{y(!0);try{const s=await F.getGanttData({start_date:f.format("YYYY-MM-DD"),end_date:x.format("YYYY-MM-DD"),laboratory_id:u,category:l});$(s.equipment)}catch{i.error("获取设备排程数据失败")}finally{y(!1)}},[f,x,u,l,i]);a.useEffect(()=>{j()},[j]),a.useEffect(()=>{C()},[C]);const q=()=>{b(f.subtract(7,"day")),p(x.subtract(7,"day"))},V=()=>{b(f.add(7,"day")),p(x.add(7,"day"))},P=()=>{b(O().startOf("day")),p(O().add(7,"day").endOf("day"))},r=s=>{I(s)},k=s=>{A(s)},B=s=>{s.work_order_id&&D(`/work-orders?expand=${s.work_order_id}`)},W=s=>{const c=O(s.start_time),z=O(s.end_time),n=f.startOf("day"),_=x.endOf("day"),G=c.isBefore(n)?n:c,Y=z.isAfter(_)?_:z,ie=G.diff(n,"hour",!0),re=Y.diff(G,"hour",!0),ee=ie/N*100,t=re/N*100,o=s.priority_level||3,H=ne[o]||ne[3];return{left:`${Math.max(0,ee)}%`,width:`${Math.min(100-ee,Math.max(.5,t))}%`,backgroundColor:H}},J=s=>{const c=O(s.start_time),z=O(s.end_time),n=s.priority_level||3;return`${s.title||"排程"}
开始: ${c.format("MM/DD HH:mm")}
结束: ${z.format("MM/DD HH:mm")}
优先级: ${ye[n]||"正常"}
状态: ${Ae[s.status]||s.status}${s.operator_name?`
操作员: ${s.operator_name}`:""}`};return e.jsxs("div",{style:{background:"#fff",borderRadius:8,border:"1px solid #e5e5e5",boxShadow:"0 1px 2px rgba(0,0,0,0.05)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px 16px",borderBottom:"1px solid #e5e5e5",background:"#fafafa"},children:[e.jsx("span",{style:{fontWeight:500,color:"#171717"},children:"设备排程甘特图"}),e.jsx(L,{size:"small",icon:e.jsx($e,{}),onClick:C,loading:T,children:"刷新"})]}),e.jsxs("div",{style:{padding:16},children:[e.jsxs("div",{style:{display:"flex",flexWrap:"wrap",alignItems:"center",gap:16,marginBottom:16},children:[e.jsx("div",{style:{width:192},children:e.jsx(E,{placeholder:"选择实验室",value:u,onChange:r,allowClear:!0,style:{width:"100%"},options:v.map(s=>({label:s.name,value:s.id}))})}),e.jsx("div",{style:{width:140},children:e.jsx(E,{placeholder:"设备类别",value:l,onChange:k,allowClear:!0,style:{width:"100%"},options:Object.entries(Oe).map(([s,c])=>({label:c,value:s}))})}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(ae,{value:f,onChange:s=>s&&b(s),placeholder:"开始日期"}),e.jsx("span",{style:{color:"#a3a3a3"},children:"-"}),e.jsx(ae,{value:x,onChange:s=>s&&p(s),placeholder:"结束日期"})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:4},children:[e.jsx(L,{size:"small",icon:e.jsx(we,{}),onClick:q}),e.jsx(L,{size:"small",onClick:P,children:"今天"}),e.jsx(L,{size:"small",icon:e.jsx(Ce,{}),onClick:V})]})]}),T?e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:"48px 0"},children:e.jsx(Se,{size:"large"})}):w.length===0?e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"48px 0",color:"#a3a3a3"},children:[e.jsx("svg",{style:{width:48,height:48,marginBottom:8},fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1,d:"M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"})}),e.jsx("span",{children:"暂无设备数据"})]}):e.jsxs("div",{style:{overflowX:"auto"},children:[e.jsxs("div",{style:{minWidth:800},children:[e.jsxs("div",{style:{display:"flex",borderBottom:"1px solid #e5e5e5"},children:[e.jsx("div",{style:{width:192,minWidth:192,padding:"8px 12px",fontWeight:500,color:"#404040",background:"#fafafa",borderRight:"1px solid #e5e5e5"},children:"设备"}),e.jsx("div",{style:{flex:1,display:"flex"},children:S.map((s,c)=>e.jsxs("div",{style:{flex:1,textAlign:"center",padding:"8px 4px",fontSize:12,borderRight:"1px solid #f5f5f5",background:s.date.isSame(O(),"day")?"#f0f5ff":"#fafafa"},children:[s.label,e.jsx("div",{style:{fontSize:10,color:"#a3a3a3"},children:s.date.format("ddd")})]},c))})]}),w.map(s=>e.jsxs("div",{style:{display:"flex",borderBottom:"1px solid #f5f5f5",minHeight:50},children:[e.jsxs("div",{style:{width:192,minWidth:192,padding:"8px 12px",borderRight:"1px solid #f5f5f5",display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx("div",{style:{fontWeight:500,color:"#171717",fontSize:14},children:s.name}),e.jsxs("div",{style:{fontSize:11,color:"#737373"},children:[s.code," · ",Be[s.equipment_type]||s.equipment_type]})]}),e.jsxs("div",{style:{flex:1,position:"relative",background:"#fff"},children:[e.jsx("div",{style:{position:"absolute",inset:0,display:"flex"},children:S.map((c,z)=>e.jsx("div",{style:{flex:1,borderRight:"1px solid #fafafa",background:c.date.isSame(O(),"day")?"rgba(250,250,250,0.5)":void 0}},z))}),s.schedules.map(c=>e.jsx(ke,{title:J(c),children:e.jsx("div",{onClick:()=>B(c),style:{position:"absolute",top:8,height:"calc(100% - 16px)",minHeight:24,borderRadius:4,cursor:c.work_order_id?"pointer":"default",display:"flex",alignItems:"center",padding:"0 8px",color:"#fff",fontSize:11,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",boxShadow:"0 1px 2px rgba(0,0,0,0.1)",...W(c)},children:c.title||`#${c.task_id||c.id}`})},c.id)),s.schedules.length===0&&e.jsx("div",{style:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",color:"#d4d4d4",fontSize:12},children:"无排程"})]})]},s.id))]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"flex-end",gap:16,marginTop:16},children:[e.jsx("span",{style:{fontSize:12,color:"#737373"},children:"优先级:"}),Object.entries(ye).map(([s,c])=>e.jsx(he,{style:{backgroundColor:ne[Number(s)],color:"#fff",border:"none"},children:c},s))]})]})]})]})}const{TextArea:Ne}=M;function Ve({visible:m,category:i,onSuccess:D,onCancel:T}){const[y]=d.useForm(),[v,h]=a.useState(!1),{message:w}=X.useApp();a.useEffect(()=>{m&&(i?y.setFieldsValue({name:i.name,code:i.code,description:i.description,display_order:i.display_order,is_active:i.is_active}):(y.resetFields(),y.setFieldsValue({display_order:0,is_active:!0})))},[m,i,y]);const $=async()=>{try{const u=await y.validateFields();h(!0);const I={name:u.name,code:u.code,description:u.description,display_order:u.display_order,is_active:u.is_active};i?(await F.updateEquipmentCategory(i.id,I),w.success("更新成功")):(await F.createEquipmentCategory(I),w.success("创建成功")),D()}catch(u){if(u&&typeof u=="object"&&"errorFields"in u)return;const l=u?.response?.data?.detail;w.error(l||(i?"更新失败":"创建失败"))}finally{h(!1)}};return e.jsx(me,{title:i?"编辑设备类别":"新增设备类别",open:m,onOk:$,onCancel:T,confirmLoading:v,width:500,okText:"确定",cancelText:"取消",destroyOnHidden:!0,children:e.jsxs(d,{form:y,layout:"vertical",children:[e.jsx(d.Item,{name:"name",label:"类别名称",rules:[{required:!0,message:"请输入类别名称"}],children:e.jsx(M,{placeholder:"请输入类别名称，如：电学分析"})}),e.jsx(d.Item,{name:"code",label:"类别编码",rules:[{required:!0,message:"请输入类别编码"},{pattern:/^[a-z_]+$/,message:"编码只能包含小写字母和下划线"}],children:e.jsx(M,{placeholder:"请输入类别编码，如：electrical_analysis",disabled:!!i})}),e.jsx(d.Item,{name:"description",label:"描述",children:e.jsx(Ne,{rows:2,placeholder:"请输入类别描述"})}),e.jsx(d.Item,{name:"display_order",label:"排序序号",children:e.jsx(U,{min:0,placeholder:"排序序号",style:{width:"100%"}})}),e.jsx(d.Item,{name:"is_active",label:"启用状态",valuePropName:"checked",children:e.jsx(se,{checkedChildren:"启用",unCheckedChildren:"停用"})})]})})}const{TextArea:Pe}=M;function He({visible:m,equipmentName:i,categories:D,onSuccess:T,onCancel:y}){const[v]=d.useForm(),[h,w]=a.useState(!1),{message:$}=X.useApp();a.useEffect(()=>{m&&(i?v.setFieldsValue({category_id:i.category_id,name:i.name,description:i.description,is_critical:i.is_critical,is_active:i.is_active}):(v.resetFields(),v.setFieldsValue({is_critical:!1,is_active:!0})))},[m,i,v]);const u=async()=>{try{const l=await v.validateFields();if(w(!0),i){const A={name:l.name,description:l.description,is_critical:l.is_critical,is_active:l.is_active};await F.updateEquipmentName(i.id,A),$.success("更新成功")}else{const A={category_id:l.category_id,name:l.name,description:l.description,is_critical:l.is_critical,is_active:l.is_active};await F.createEquipmentName(A),$.success("创建成功")}T()}catch(l){if(l&&typeof l=="object"&&"errorFields"in l)return;const f=l?.response?.data?.detail;$.error(f||(i?"更新失败":"创建失败"))}finally{w(!1)}},I=D.filter(l=>l.is_active);return e.jsx(me,{title:i?"编辑设备名":"新增设备名",open:m,onOk:u,onCancel:y,confirmLoading:h,width:500,okText:"确定",cancelText:"取消",destroyOnHidden:!0,children:e.jsxs(d,{form:v,layout:"vertical",children:[e.jsx(d.Item,{name:"category_id",label:"所属类别",rules:[{required:!0,message:"请选择所属类别"}],children:e.jsx(E,{placeholder:"请选择所属类别",disabled:!!i,showSearch:!0,optionFilterProp:"label",options:I.map(l=>({label:l.name,value:l.id}))})}),e.jsx(d.Item,{name:"name",label:"设备名",rules:[{required:!0,message:"请输入设备名"}],children:e.jsx(M,{placeholder:"请输入设备名，如：万用表、示波器"})}),e.jsx(d.Item,{name:"description",label:"描述",children:e.jsx(Pe,{rows:2,placeholder:"请输入设备名描述"})}),e.jsx(d.Item,{name:"is_critical",label:"关键设备",valuePropName:"checked",rules:[{required:!0,message:"请选择是否为关键设备"}],children:e.jsx(se,{checkedChildren:"是",unCheckedChildren:"否"})}),e.jsx(d.Item,{name:"is_active",label:"启用状态",valuePropName:"checked",children:e.jsx(se,{checkedChildren:"启用",unCheckedChildren:"停用"})})]})})}function We(){const[m,i]=a.useState([]),[D,T]=a.useState([]),[y,v]=a.useState(!1),[h,w]=a.useState(!1),[$,u]=a.useState(!1),[I,l]=a.useState(null),[A,f]=a.useState(!1),[b,x]=a.useState(null),[p,S]=a.useState(),[R,N]=a.useState(""),{message:j}=X.useApp(),C=a.useCallback(async()=>{v(!0);try{const n=await F.getEquipmentCategories();i(n)}catch{j.error("获取设备类别失败")}finally{v(!1)}},[j]),q=a.useCallback(async()=>{w(!0);try{const n=await F.getEquipmentNames({category_id:p,search:R||void 0});T(n)}catch{j.error("获取设备名列表失败")}finally{w(!1)}},[p,R,j]);a.useEffect(()=>{C()},[C]),a.useEffect(()=>{q()},[q]);const V=()=>{l(null),u(!0)},P=n=>{l(n),u(!0)},r=async n=>{try{await F.deleteEquipmentCategory(n),j.success("删除成功"),C(),q()}catch(_){const Y=_?.response?.data?.detail;j.error(Y||"删除失败")}},k=()=>{u(!1),l(null),C()},B=()=>{x(null),f(!0)},W=n=>{x(n),f(!0)},J=async n=>{try{await F.deleteEquipmentName(n),j.success("删除成功"),q()}catch(_){const Y=_?.response?.data?.detail;j.error(Y||"删除失败")}},s=()=>{f(!1),x(null),q()},c=[{title:"类别名称",dataIndex:"name",key:"name",width:150},{title:"类别编码",dataIndex:"code",key:"code",width:150,render:n=>e.jsx(he,{children:n})},{title:"描述",dataIndex:"description",key:"description",ellipsis:!0,render:n=>n||"-"},{title:"排序",dataIndex:"display_order",key:"display_order",width:80,align:"center"},{title:"状态",dataIndex:"is_active",key:"is_active",width:80,render:n=>e.jsx(de,{isActive:n})},{title:"操作",key:"action",width:150,render:(n,_)=>e.jsxs(Z,{children:[e.jsx(L,{type:"link",size:"small",icon:e.jsx(ce,{}),onClick:()=>P(_),children:"编辑"}),e.jsx(ue,{title:"确认删除",description:`确定要删除类别 "${_.name}" 吗？删除后该类别下的设备名将无法关联。`,onConfirm:()=>r(_.id),okText:"确定",cancelText:"取消",okButtonProps:{danger:!0},children:e.jsx(L,{type:"link",size:"small",danger:!0,icon:e.jsx(pe,{}),children:"删除"})})]})}],z=[{title:"设备名",dataIndex:"name",key:"name",width:180},{title:"所属类别",dataIndex:"category",key:"category",width:130,render:(n,_)=>_.category?.name||"-"},{title:"描述",dataIndex:"description",key:"description",ellipsis:!0,render:n=>n||"-"},{title:"关键设备",dataIndex:"is_critical",key:"is_critical",width:90,align:"center",render:n=>n?e.jsx("span",{style:{color:"#f5222d"},children:"是"}):e.jsx("span",{style:{color:"#8c8c8c"},children:"否"})},{title:"状态",dataIndex:"is_active",key:"is_active",width:80,render:n=>e.jsx(de,{isActive:n})},{title:"操作",key:"action",width:150,render:(n,_)=>e.jsxs(Z,{children:[e.jsx(L,{type:"link",size:"small",icon:e.jsx(ce,{}),onClick:()=>W(_),children:"编辑"}),e.jsx(ue,{title:"确认删除",description:`确定要删除设备名 "${_.name}" 吗？`,onConfirm:()=>J(_.id),okText:"确定",cancelText:"取消",okButtonProps:{danger:!0},children:e.jsx(L,{type:"link",size:"small",danger:!0,icon:e.jsx(pe,{}),children:"删除"})})]})}];return e.jsxs("div",{children:[e.jsxs(K,{gutter:16,children:[e.jsx(g,{span:10,children:e.jsx(xe,{title:"设备类别管理",extra:e.jsx(L,{type:"primary",icon:e.jsx(le,{}),onClick:V,children:"新增类别"}),children:e.jsx(oe,{columns:c,dataSource:m,rowKey:"id",loading:y,pagination:!1,size:"small",scroll:{y:500}})})}),e.jsx(g,{span:14,children:e.jsxs(xe,{title:"设备名管理",extra:e.jsx(L,{type:"primary",icon:e.jsx(le,{}),onClick:B,children:"新增设备名"}),children:[e.jsxs(Z,{style:{marginBottom:16},wrap:!0,children:[e.jsx(M,{placeholder:"搜索设备名",prefix:e.jsx(be,{}),value:R,onChange:n=>N(n.target.value),style:{width:200},allowClear:!0}),e.jsx(E,{placeholder:"按类别筛选",value:p,onChange:S,style:{width:150},allowClear:!0,options:m.map(n=>({label:n.name,value:n.id}))})]}),e.jsx(oe,{columns:z,dataSource:D,rowKey:"id",loading:h,pagination:{pageSize:10,showSizeChanger:!0,showTotal:n=>`共 ${n} 条`},size:"small",scroll:{y:400}})]})})]}),e.jsx(Ve,{visible:$,category:I,onSuccess:k,onCancel:()=>{u(!1),l(null)}}),e.jsx(He,{visible:A,equipmentName:b,categories:m,onSuccess:s,onCancel:()=>{f(!1),x(null)}})]})}const fe={autonomous:"自主运行",operator_dependent:"操作员依赖"},ge={thermal:"热学设备",mechanical:"机械设备",electrical:"电学设备",optical:"光学设备",analytical:"分析设备",environmental:"环境设备",measurement:"测量设备",other:"其他"},je={available:{text:"可用",color:"success"},in_use:{text:"使用中",color:"blue"},maintenance:{text:"维护中",color:"warning"},out_of_service:{text:"停用",color:"red"},reserved:{text:"已预约",color:"purple"}};function dt(){const[m,i]=a.useState([]),[D,T]=a.useState([]),[y,v]=a.useState([]),[h,w]=a.useState(!1),[$,u]=a.useState(!1),[I,l]=a.useState(null),[A,f]=a.useState("list"),[b,x]=a.useState({current:1,pageSize:10,total:0}),[p,S]=a.useState({search:""}),[R,N]=a.useState(""),{message:j}=X.useApp(),C=a.useRef(null),q=a.useCallback(async(t=1,o=10,H)=>{w(!0);try{const Q=await F.getEquipment({page:t,page_size:o,search:p.search||void 0,site_id:p.site_id,laboratory_id:p.laboratory_id,equipment_type:p.equipment_type,category:p.category,status:p.status,signal:H});i(Q.items),x({current:Q.page,pageSize:Q.page_size,total:Q.total})}catch(Q){te(Q)||j.error("获取设备列表失败")}finally{w(!1)}},[p,j]),V=a.useCallback(async()=>{try{const t=await Fe.getAllSites();T(t)}catch(t){te(t)||console.error("Failed to fetch sites")}},[]),P=a.useCallback(async()=>{try{const t=await _e.getLaboratories({page:1,page_size:100});v(t.items)}catch(t){te(t)||console.error("Failed to fetch laboratories")}},[]);a.useEffect(()=>{V(),P()},[V,P]),a.useEffect(()=>{C.current&&C.current.abort();const t=new AbortController;return C.current=t,q(b.current,b.pageSize,t.signal),()=>{t.abort()}},[p]),a.useEffect(()=>{const t=setTimeout(()=>{R!==p.search&&S(o=>({...o,search:R}))},300);return()=>clearTimeout(t)},[R,p.search]);const r=t=>{C.current&&C.current.abort();const o=new AbortController;C.current=o,q(t.current,t.pageSize,o.signal)},k=t=>{S(o=>({...o,site_id:t,laboratory_id:void 0}))},B=t=>{S(o=>({...o,laboratory_id:t}))},W=t=>{S(o=>({...o,equipment_type:t}))},J=t=>{S(o=>({...o,category:t}))},s=t=>{S(o=>({...o,status:t}))},c=()=>{l(null),u(!0)},z=t=>{l(t),u(!0)},n=async t=>{try{await F.deleteEquipment(t),j.success("删除成功"),q(b.current,b.pageSize)}catch(o){te(o)||j.error("删除失败")}},_=()=>{u(!1),l(null),q(b.current,b.pageSize)},G=()=>{u(!1),l(null)},Y=t=>{const o=y.find(H=>H.id===t);return o?o.name:"-"},ie=p.site_id?y.filter(t=>t.site_id===p.site_id):y,re=[{title:"设备名称",dataIndex:"name",key:"name",width:180},{title:"设备编号",dataIndex:"code",key:"code",width:120},{title:"类型",dataIndex:"equipment_type",key:"equipment_type",width:110,render:t=>fe[t]||t},{title:"类别",dataIndex:"category",key:"category",width:100,render:t=>t?ge[t]||t:"-"},{title:"实验室",dataIndex:"laboratory_id",key:"laboratory_id",width:100,render:t=>Y(t)},{title:"型号",dataIndex:"model",key:"model",width:120,render:t=>t||"-"},{title:"制造商",dataIndex:"manufacturer",key:"manufacturer",width:100,render:t=>t||"-"},{title:"状态",dataIndex:"status",key:"status",width:90,render:t=>{const o=t,H=je[o]||{text:o,color:"default"};return e.jsx(he,{color:H.color,children:H.text})}},{title:"启用",dataIndex:"is_active",key:"is_active",width:70,render:t=>e.jsx(de,{isActive:t})},{title:"操作",key:"action",width:150,render:(t,o)=>e.jsxs(Z,{children:[e.jsx(L,{type:"link",size:"small",icon:e.jsx(ce,{}),onClick:()=>z(o),children:"编辑"}),e.jsx(ue,{title:"确认删除",description:`确定要删除设备 "${o.name}" 吗？`,onConfirm:()=>n(o.id),okText:"确定",cancelText:"取消",okButtonProps:{danger:!0},children:e.jsx(L,{type:"link",size:"small",danger:!0,icon:e.jsx(pe,{}),children:"删除"})})]})}],ee=[{key:"list",label:e.jsxs("span",{children:[e.jsx(qe,{}),"设备列表"]}),children:e.jsxs("div",{children:[e.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between"},children:[e.jsxs(Z,{wrap:!0,children:[e.jsx(M,{placeholder:"搜索设备名称、编号或型号",prefix:e.jsx(be,{}),value:R,onChange:t=>N(t.target.value),style:{width:220},allowClear:!0,"data-testid":"equipment-search-input"}),e.jsx(E,{placeholder:"站点",value:p.site_id,onChange:k,style:{width:150},allowClear:!0,options:D.map(t=>({label:`${t.name} (${t.code})`,value:t.id}))}),e.jsx(E,{placeholder:"实验室",value:p.laboratory_id,onChange:B,style:{width:180},allowClear:!0,options:ie.map(t=>({label:`${t.name} (${t.code})`,value:t.id}))}),e.jsx(E,{placeholder:"设备类型",value:p.equipment_type,onChange:W,style:{width:130},allowClear:!0,options:Object.entries(fe).map(([t,o])=>({label:o,value:t}))}),e.jsx(E,{placeholder:"设备类别",value:p.category,onChange:J,style:{width:120},allowClear:!0,options:Object.entries(ge).map(([t,o])=>({label:o,value:t}))}),e.jsx(E,{placeholder:"状态",value:p.status,onChange:s,style:{width:100},allowClear:!0,options:Object.entries(je).map(([t,o])=>({label:o.text,value:t}))})]}),e.jsx(L,{type:"primary",icon:e.jsx(le,{}),onClick:c,"data-testid":"equipment-add-button",children:"新增设备"})]}),e.jsx(oe,{columns:re,dataSource:m,rowKey:"id",loading:h,pagination:{...b,showSizeChanger:!0,showQuickJumper:!0,showTotal:t=>`共 ${t} 条`},onChange:r,scroll:{x:1300},"data-testid":"equipment-table"}),e.jsx(De,{visible:$,equipment:I,sites:D,laboratories:y,onSuccess:_,onCancel:G})]})},{key:"schedule",label:e.jsxs("span",{children:[e.jsx(Te,{}),"排程甘特图"]}),children:e.jsx(Re,{})},{key:"type-management",label:e.jsxs("span",{children:[e.jsx(Ie,{}),"设备类型管理"]}),children:e.jsx(We,{})}];return e.jsx("div",{"data-testid":"equipment-page",children:e.jsx(Ee,{activeKey:A,onChange:f,items:ee,"data-testid":"equipment-tabs"})})}export{dt as default};
