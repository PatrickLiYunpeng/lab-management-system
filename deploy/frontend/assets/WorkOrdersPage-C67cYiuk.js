import{ai as Q,_ as Ye,c as re,g as ce,d as Ue,K as Re,f as be,a as gt,C as xt,B as Xe,e as yt,al as bt,am as _t,h as vt,D as jt,r,E as St,i as Qe,m as Je,l as J,an as Ct,j as Ze,k as wt,ao as $t,q as et,s as tt,ag as Te,x as Ae,ap as It,o as Ne,I as kt,M as Ce,a7 as he,a6 as A,N as ne,P as e,V as ue,W as Z,a8 as le,Q as V,aa as je,S as Se,a0 as ae,U as $e,af as qt,a4 as Mt,A as _e,Y as Tt,ac as Et,aq as zt,O as ye,a9 as Pt}from"./index-DVAH8G0d.js";import{w as ee}from"./workOrderService-Bmn1aSRi.js";import{l as Rt}from"./laboratoryService-B77Lyyfa.js";import{s as At}from"./siteService-Bv2y8QeO.js";import{m as Ee}from"./materialService-CigNgq2n.js";import{p as Nt,R as nt}from"./productService-BBlA6YPD.js";import{c as Be}from"./clientSlaService-DC81kYw3.js";import{M as Ie}from"./index-D5-92eMw.js";import{S as Y,F as ke,E as Bt,C as Dt,R as Lt}from"./Table-BH_IQYSB.js";import{A as pe}from"./index-DYC5NmKL.js";import{D as Ft}from"./index-Bd8ohf4A.js";import{T as me}from"./index-fw1Ls6Om.js";import{p as at}from"./personnelService-DtbQ-G5D.js";import{e as ve}from"./equipmentService-ABHB664f.js";import{m as De}from"./methodService-CwVcuzKD.js";import{R as Ot}from"./ExclamationCircleOutlined-CZLhAH0C.js";import{P as it}from"./progress-lvmwxBfu.js";import{R as Ht}from"./CheckCircleOutlined-CzFoyiHm.js";import{R as Wt}from"./CloseCircleOutlined-DFnUgcZ4.js";import{h as Vt}from"./handoverService-BCAbXo0r.js";import{R as Kt}from"./ReloadOutlined-Ci7PDsnU.js";import{R as st}from"./EditOutlined-BO1KRQYy.js";import{P as rt}from"./index-BDasguwL.js";import{R as lt}from"./DeleteOutlined-DADLfnzs.js";import{S as Gt}from"./index-C-m9zxKZ.js";import{R as Le}from"./DownloadOutlined-BrknFVMW.js";import"./CheckOutlined-CP9fMx1j.js";import"./ClockCircleOutlined-C4lKWGcp.js";var ot=Q.forwardRef(function(a,n){var s=a.prefixCls,l=a.forceRender,u=a.className,T=a.style,k=a.children,j=a.isActive,y=a.role,$=a.classNames,R=a.styles,b=Q.useState(j||l),P=Ye(b,2),f=P[0],E=P[1];return Q.useEffect(function(){(l||j)&&E(!0)},[l,j]),f?Q.createElement("div",{ref:n,className:re("".concat(s,"-content"),ce(ce({},"".concat(s,"-content-active"),j),"".concat(s,"-content-inactive"),!j),u),style:T,role:y},Q.createElement("div",{className:re("".concat(s,"-content-box"),$?.body),style:R?.body},k)):null});ot.displayName="PanelContent";var Yt=["showArrow","headerClass","isActive","onItemClick","forceRender","className","classNames","styles","prefixCls","collapsible","accordion","panelKey","extra","header","expandIcon","openMotion","destroyInactivePanel","children"],dt=Q.forwardRef(function(a,n){var s=a.showArrow,l=s===void 0?!0:s,u=a.headerClass,T=a.isActive,k=a.onItemClick,j=a.forceRender,y=a.className,$=a.classNames,R=$===void 0?{}:$,b=a.styles,P=b===void 0?{}:b,f=a.prefixCls,E=a.collapsible,S=a.accordion,m=a.panelKey,_=a.extra,o=a.header,w=a.expandIcon,v=a.openMotion,q=a.destroyInactivePanel,B=a.children,N=Ue(a,Yt),z=E==="disabled",c=_!=null&&typeof _!="boolean",d=ce(ce(ce({onClick:function(){k?.(m)},onKeyDown:function(W){(W.key==="Enter"||W.keyCode===Re.ENTER||W.which===Re.ENTER)&&k?.(m)},role:S?"tab":"button"},"aria-expanded",T),"aria-disabled",z),"tabIndex",z?-1:0),p=typeof w=="function"?w(a):Q.createElement("i",{className:"arrow"}),F=p&&Q.createElement("div",be({className:"".concat(f,"-expand-icon")},["header","icon"].includes(E)?d:{}),p),K=re("".concat(f,"-item"),ce(ce({},"".concat(f,"-item-active"),T),"".concat(f,"-item-disabled"),z),y),H=re(u,"".concat(f,"-header"),ce({},"".concat(f,"-collapsible-").concat(E),!!E),R.header),O=gt({className:H,style:P.header},["header","icon"].includes(E)?{}:d);return Q.createElement("div",be({},N,{ref:n,className:K}),Q.createElement("div",O,l&&F,Q.createElement("span",be({className:"".concat(f,"-header-text")},E==="header"?d:{}),o),c&&Q.createElement("div",{className:"".concat(f,"-extra")},_)),Q.createElement(xt,be({visible:T,leavedClassName:"".concat(f,"-content-hidden")},v,{forceRender:j,removeOnLeave:q}),function(L,W){var C=L.className,I=L.style;return Q.createElement(ot,{ref:W,prefixCls:f,className:C,classNames:R,style:I,styles:P,isActive:T,forceRender:j,role:S?"tabpanel":void 0},B)}))}),Ut=["children","label","key","collapsible","onItemClick","destroyInactivePanel"],Xt=function(n,s){var l=s.prefixCls,u=s.accordion,T=s.collapsible,k=s.destroyInactivePanel,j=s.onItemClick,y=s.activeKey,$=s.openMotion,R=s.expandIcon;return n.map(function(b,P){var f=b.children,E=b.label,S=b.key,m=b.collapsible,_=b.onItemClick,o=b.destroyInactivePanel,w=Ue(b,Ut),v=String(S??P),q=m??T,B=o??k,N=function(d){q!=="disabled"&&(j(d),_?.(d))},z=!1;return u?z=y[0]===v:z=y.indexOf(v)>-1,Q.createElement(dt,be({},w,{prefixCls:l,key:v,panelKey:v,isActive:z,accordion:u,openMotion:$,expandIcon:R,header:E,collapsible:q,onItemClick:N,destroyInactivePanel:B}),f)})},Qt=function(n,s,l){if(!n)return null;var u=l.prefixCls,T=l.accordion,k=l.collapsible,j=l.destroyInactivePanel,y=l.onItemClick,$=l.activeKey,R=l.openMotion,b=l.expandIcon,P=n.key||String(s),f=n.props,E=f.header,S=f.headerClass,m=f.destroyInactivePanel,_=f.collapsible,o=f.onItemClick,w=!1;T?w=$[0]===P:w=$.indexOf(P)>-1;var v=_??k,q=function(z){v!=="disabled"&&(y(z),o?.(z))},B={key:P,panelKey:P,header:E,headerClass:S,isActive:w,prefixCls:u,destroyInactivePanel:m??j,openMotion:R,accordion:T,children:n.props.children,onItemClick:q,expandIcon:b,collapsible:v};return typeof n.type=="string"?n:(Object.keys(B).forEach(function(N){typeof B[N]>"u"&&delete B[N]}),Q.cloneElement(n,B))};function Jt(a,n,s){return Array.isArray(a)?Xt(a,s):Xe(n).map(function(l,u){return Qt(l,u,s)})}function Zt(a){var n=a;if(!Array.isArray(n)){var s=vt(n);n=s==="number"||s==="string"?[n]:[]}return n.map(function(l){return String(l)})}var en=Q.forwardRef(function(a,n){var s=a.prefixCls,l=s===void 0?"rc-collapse":s,u=a.destroyInactivePanel,T=u===void 0?!1:u,k=a.style,j=a.accordion,y=a.className,$=a.children,R=a.collapsible,b=a.openMotion,P=a.expandIcon,f=a.activeKey,E=a.defaultActiveKey,S=a.onChange,m=a.items,_=re(l,y),o=yt([],{value:f,onChange:function(c){return S?.(c)},defaultValue:E,postState:Zt}),w=Ye(o,2),v=w[0],q=w[1],B=function(c){return q(function(){if(j)return v[0]===c?[]:[c];var d=v.indexOf(c),p=d>-1;return p?v.filter(function(F){return F!==c}):[].concat(jt(v),[c])})};bt(!$,"[rc-collapse] `children` will be removed in next major version. Please use `items` instead.");var N=Jt(m,$,{prefixCls:l,accordion:j,openMotion:b,expandIcon:P,collapsible:R,destroyInactivePanel:T,onItemClick:B,activeKey:v});return Q.createElement("div",be({ref:n,className:_,style:k,role:j?"tablist":void 0},_t(a,{aria:!0,data:!0})),N)});const ze=Object.assign(en,{Panel:dt});ze.Panel;const tn=r.forwardRef((a,n)=>{const{getPrefixCls:s}=r.useContext(St),{prefixCls:l,className:u,showArrow:T=!0}=a,k=s("collapse",l),j=re({[`${k}-no-arrow`]:!T},u);return r.createElement(ze.Panel,Object.assign({ref:n},a,{prefixCls:k,className:j}))}),nn=a=>{const{componentCls:n,contentBg:s,padding:l,headerBg:u,headerPadding:T,collapseHeaderPaddingSM:k,collapseHeaderPaddingLG:j,collapsePanelBorderRadius:y,lineWidth:$,lineType:R,colorBorder:b,colorText:P,colorTextHeading:f,colorTextDisabled:E,fontSizeLG:S,lineHeight:m,lineHeightLG:_,marginSM:o,paddingSM:w,paddingLG:v,paddingXS:q,motionDurationSlow:B,fontSizeIcon:N,contentPadding:z,fontHeight:c,fontHeightLG:d}=a,p=`${J($)} ${R} ${b}`;return{[n]:Object.assign(Object.assign({},Ze(a)),{backgroundColor:u,border:p,borderRadius:y,"&-rtl":{direction:"rtl"},[`& > ${n}-item`]:{borderBottom:p,"&:first-child":{[`
            &,
            & > ${n}-header`]:{borderRadius:`${J(y)} ${J(y)} 0 0`}},"&:last-child":{[`
            &,
            & > ${n}-header`]:{borderRadius:`0 0 ${J(y)} ${J(y)}`}},[`> ${n}-header`]:Object.assign(Object.assign({position:"relative",display:"flex",flexWrap:"nowrap",alignItems:"flex-start",padding:T,color:f,lineHeight:m,cursor:"pointer",transition:`all ${B}, visibility 0s`},wt(a)),{[`> ${n}-header-text`]:{flex:"auto"},[`${n}-expand-icon`]:{height:c,display:"flex",alignItems:"center",paddingInlineEnd:o},[`${n}-arrow`]:Object.assign(Object.assign({},$t()),{fontSize:N,transition:`transform ${B}`,svg:{transition:`transform ${B}`}}),[`${n}-header-text`]:{marginInlineEnd:"auto"}}),[`${n}-collapsible-header`]:{cursor:"default",[`${n}-header-text`]:{flex:"none",cursor:"pointer"},[`${n}-expand-icon`]:{cursor:"pointer"}},[`${n}-collapsible-icon`]:{cursor:"unset",[`${n}-expand-icon`]:{cursor:"pointer"}}},[`${n}-content`]:{color:P,backgroundColor:s,borderTop:p,[`& > ${n}-content-box`]:{padding:z},"&-hidden":{display:"none"}},"&-small":{[`> ${n}-item`]:{[`> ${n}-header`]:{padding:k,paddingInlineStart:q,[`> ${n}-expand-icon`]:{marginInlineStart:a.calc(w).sub(q).equal()}},[`> ${n}-content > ${n}-content-box`]:{padding:w}}},"&-large":{[`> ${n}-item`]:{fontSize:S,lineHeight:_,[`> ${n}-header`]:{padding:j,paddingInlineStart:l,[`> ${n}-expand-icon`]:{height:d,marginInlineStart:a.calc(v).sub(l).equal()}},[`> ${n}-content > ${n}-content-box`]:{padding:v}}},[`${n}-item:last-child`]:{borderBottom:0,[`> ${n}-content`]:{borderRadius:`0 0 ${J(y)} ${J(y)}`}},[`& ${n}-item-disabled > ${n}-header`]:{"\n          &,\n          & > .arrow\n        ":{color:E,cursor:"not-allowed"}},[`&${n}-icon-position-end`]:{[`& > ${n}-item`]:{[`> ${n}-header`]:{[`${n}-expand-icon`]:{order:1,paddingInlineEnd:0,paddingInlineStart:o}}}}})}},an=a=>{const{componentCls:n}=a,s=`> ${n}-item > ${n}-header ${n}-arrow`;return{[`${n}-rtl`]:{[s]:{transform:"rotate(180deg)"}}}},sn=a=>{const{componentCls:n,headerBg:s,borderlessContentPadding:l,borderlessContentBg:u,colorBorder:T}=a;return{[`${n}-borderless`]:{backgroundColor:s,border:0,[`> ${n}-item`]:{borderBottom:`1px solid ${T}`},[`
        > ${n}-item:last-child,
        > ${n}-item:last-child ${n}-header
      `]:{borderRadius:0},[`> ${n}-item:last-child`]:{borderBottom:0},[`> ${n}-item > ${n}-content`]:{backgroundColor:u,borderTop:0},[`> ${n}-item > ${n}-content > ${n}-content-box`]:{padding:l}}}},rn=a=>{const{componentCls:n,paddingSM:s}=a;return{[`${n}-ghost`]:{backgroundColor:"transparent",border:0,[`> ${n}-item`]:{borderBottom:0,[`> ${n}-content`]:{backgroundColor:"transparent",border:0,[`> ${n}-content-box`]:{paddingBlock:s}}}}}},ln=a=>({headerPadding:`${a.paddingSM}px ${a.padding}px`,headerBg:a.colorFillAlter,contentPadding:`${a.padding}px 16px`,contentBg:a.colorBgContainer,borderlessContentPadding:`${a.paddingXXS}px 16px ${a.padding}px`,borderlessContentBg:"transparent"}),on=Qe("Collapse",a=>{const n=Je(a,{collapseHeaderPaddingSM:`${J(a.paddingXS)} ${J(a.paddingSM)}`,collapseHeaderPaddingLG:`${J(a.padding)} ${J(a.paddingLG)}`,collapsePanelBorderRadius:a.borderRadiusLG});return[nn(n),sn(n),rn(n),an(n),Ct(n)]},ln),dn=r.forwardRef((a,n)=>{const{getPrefixCls:s,direction:l,expandIcon:u,className:T,style:k}=et("collapse"),{prefixCls:j,className:y,rootClassName:$,style:R,bordered:b=!0,ghost:P,size:f,expandIconPosition:E="start",children:S,destroyInactivePanel:m,destroyOnHidden:_,expandIcon:o}=a,w=tt(O=>{var L;return(L=f??O)!==null&&L!==void 0?L:"middle"}),v=s("collapse",j),q=s(),[B,N,z]=on(v),c=r.useMemo(()=>E==="left"?"start":E==="right"?"end":E,[E]),d=o??u,p=r.useCallback((O={})=>{const L=typeof d=="function"?d(O):r.createElement(Te,{rotate:O.isActive?l==="rtl"?-90:90:void 0,"aria-label":O.isActive?"expanded":"collapsed"});return Ae(L,()=>{var W;return{className:re((W=L.props)===null||W===void 0?void 0:W.className,`${v}-arrow`)}})},[d,v,l]),F=re(`${v}-icon-position-${c}`,{[`${v}-borderless`]:!b,[`${v}-rtl`]:l==="rtl",[`${v}-ghost`]:!!P,[`${v}-${w}`]:w!=="middle"},T,y,$,N,z),K=r.useMemo(()=>Object.assign(Object.assign({},It(q)),{motionAppear:!1,leavedClassName:`${v}-content-hidden`}),[q,v]),H=r.useMemo(()=>S?Xe(S).map((O,L)=>{var W,C;const I=O.props;if(I?.disabled){const G=(W=O.key)!==null&&W!==void 0?W:String(L),te=Object.assign(Object.assign({},Ne(O.props,["disabled"])),{key:G,collapsible:(C=I.collapsible)!==null&&C!==void 0?C:"disabled"});return Ae(O,te)}return O}):null,[S]);return B(r.createElement(ze,Object.assign({ref:n,openMotion:K},Ne(a,["rootClassName"]),{expandIcon:p,prefixCls:v,className:F,style:Object.assign(Object.assign({},k),R),destroyInactivePanel:_??m}),H))}),cn=Object.assign(dn,{Panel:tn}),un=a=>{const{componentCls:n}=a;return{[n]:{"&-horizontal":{[`&${n}`]:{"&-sm":{marginBlock:a.marginXS},"&-md":{marginBlock:a.margin}}}}}},mn=a=>{const{componentCls:n,sizePaddingEdgeHorizontal:s,colorSplit:l,lineWidth:u,textPaddingInline:T,orientationMargin:k,verticalMarginInline:j}=a;return{[n]:Object.assign(Object.assign({},Ze(a)),{borderBlockStart:`${J(u)} solid ${l}`,"&-vertical":{position:"relative",top:"-0.06em",display:"inline-block",height:"0.9em",marginInline:j,marginBlock:0,verticalAlign:"middle",borderTop:0,borderInlineStart:`${J(u)} solid ${l}`},"&-horizontal":{display:"flex",clear:"both",width:"100%",minWidth:"100%",margin:`${J(a.marginLG)} 0`},[`&-horizontal${n}-with-text`]:{display:"flex",alignItems:"center",margin:`${J(a.dividerHorizontalWithTextGutterMargin)} 0`,color:a.colorTextHeading,fontWeight:500,fontSize:a.fontSizeLG,whiteSpace:"nowrap",textAlign:"center",borderBlockStart:`0 ${l}`,"&::before, &::after":{position:"relative",width:"50%",borderBlockStart:`${J(u)} solid transparent`,borderBlockStartColor:"inherit",borderBlockEnd:0,transform:"translateY(50%)",content:"''"}},[`&-horizontal${n}-with-text-start`]:{"&::before":{width:`calc(${k} * 100%)`},"&::after":{width:`calc(100% - ${k} * 100%)`}},[`&-horizontal${n}-with-text-end`]:{"&::before":{width:`calc(100% - ${k} * 100%)`},"&::after":{width:`calc(${k} * 100%)`}},[`${n}-inner-text`]:{display:"inline-block",paddingBlock:0,paddingInline:T},"&-dashed":{background:"none",borderColor:l,borderStyle:"dashed",borderWidth:`${J(u)} 0 0`},[`&-horizontal${n}-with-text${n}-dashed`]:{"&::before, &::after":{borderStyle:"dashed none none"}},[`&-vertical${n}-dashed`]:{borderInlineStartWidth:u,borderInlineEnd:0,borderBlockStart:0,borderBlockEnd:0},"&-dotted":{background:"none",borderColor:l,borderStyle:"dotted",borderWidth:`${J(u)} 0 0`},[`&-horizontal${n}-with-text${n}-dotted`]:{"&::before, &::after":{borderStyle:"dotted none none"}},[`&-vertical${n}-dotted`]:{borderInlineStartWidth:u,borderInlineEnd:0,borderBlockStart:0,borderBlockEnd:0},[`&-plain${n}-with-text`]:{color:a.colorText,fontWeight:"normal",fontSize:a.fontSize},[`&-horizontal${n}-with-text-start${n}-no-default-orientation-margin-start`]:{"&::before":{width:0},"&::after":{width:"100%"},[`${n}-inner-text`]:{paddingInlineStart:s}},[`&-horizontal${n}-with-text-end${n}-no-default-orientation-margin-end`]:{"&::before":{width:"100%"},"&::after":{width:0},[`${n}-inner-text`]:{paddingInlineEnd:s}}})}},pn=a=>({textPaddingInline:"1em",orientationMargin:.05,verticalMarginInline:a.marginXS}),hn=Qe("Divider",a=>{const n=Je(a,{dividerHorizontalWithTextGutterMargin:a.margin,sizePaddingEdgeHorizontal:0});return[mn(n),un(n)]},pn,{unitless:{orientationMargin:!0}});var fn=function(a,n){var s={};for(var l in a)Object.prototype.hasOwnProperty.call(a,l)&&n.indexOf(l)<0&&(s[l]=a[l]);if(a!=null&&typeof Object.getOwnPropertySymbols=="function")for(var u=0,l=Object.getOwnPropertySymbols(a);u<l.length;u++)n.indexOf(l[u])<0&&Object.prototype.propertyIsEnumerable.call(a,l[u])&&(s[l[u]]=a[l[u]]);return s};const gn={small:"sm",middle:"md"},ct=a=>{const{getPrefixCls:n,direction:s,className:l,style:u}=et("divider"),{prefixCls:T,type:k="horizontal",orientation:j="center",orientationMargin:y,className:$,rootClassName:R,children:b,dashed:P,variant:f="solid",plain:E,style:S,size:m}=a,_=fn(a,["prefixCls","type","orientation","orientationMargin","className","rootClassName","children","dashed","variant","plain","style","size"]),o=n("divider",T),[w,v,q]=hn(o),B=tt(m),N=gn[B],z=!!b,c=r.useMemo(()=>j==="left"?s==="rtl"?"end":"start":j==="right"?s==="rtl"?"start":"end":j,[s,j]),d=c==="start"&&y!=null,p=c==="end"&&y!=null,F=re(o,l,v,q,`${o}-${k}`,{[`${o}-with-text`]:z,[`${o}-with-text-${c}`]:z,[`${o}-dashed`]:!!P,[`${o}-${f}`]:f!=="solid",[`${o}-plain`]:!!E,[`${o}-rtl`]:s==="rtl",[`${o}-no-default-orientation-margin-start`]:d,[`${o}-no-default-orientation-margin-end`]:p,[`${o}-${N}`]:!!N},$,R),K=r.useMemo(()=>typeof y=="number"?y:/^\d+$/.test(y)?Number(y):y,[y]),H={marginInlineStart:d?K:void 0,marginInlineEnd:p?K:void 0};return w(r.createElement("div",Object.assign({className:F,style:Object.assign(Object.assign({},u),S)},_,{role:"separator"}),b&&k!=="vertical"&&r.createElement("span",{className:`${o}-inner-text`,style:H},b)))};var xn={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M678.3 642.4c24.2-13 51.9-20.4 81.4-20.4h.1c3 0 4.4-3.6 2.2-5.6a371.67 371.67 0 00-103.7-65.8c-.4-.2-.8-.3-1.2-.5C719.2 505 759.6 431.7 759.6 349c0-137-110.8-248-247.5-248S264.7 212 264.7 349c0 82.7 40.4 156 102.6 201.1-.4.2-.8.3-1.2.5-44.7 18.9-84.8 46-119.3 80.6a373.42 373.42 0 00-80.4 119.5A373.6 373.6 0 00137 888.8a8 8 0 008 8.2h59.9c4.3 0 7.9-3.5 8-7.8 2-77.2 32.9-149.5 87.6-204.3C357 628.2 432.2 597 512.2 597c56.7 0 111.1 15.7 158 45.1a8.1 8.1 0 008.1.3zM512.2 521c-45.8 0-88.9-17.9-121.4-50.4A171.2 171.2 0 01340.5 349c0-45.9 17.9-89.1 50.3-121.6S466.3 177 512.2 177s88.9 17.9 121.4 50.4A171.2 171.2 0 01683.9 349c0 45.9-17.9 89.1-50.3 121.6C601.1 503.1 558 521 512.2 521zM880 759h-84v-84c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v84h-84c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h84v84c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-84h84c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8z"}}]},name:"user-add",theme:"outlined"},yn=function(n,s){return r.createElement(kt,be({},n,{ref:s,icon:xn}))},bn=r.forwardRef(yn);const we=(a,n)=>{const s=window.URL.createObjectURL(a),l=document.createElement("a");l.href=s,l.download=n,document.body.appendChild(l),l.click(),document.body.removeChild(l),window.URL.revokeObjectURL(s)},Fe={async exportWorkOrdersPdf(a={}){const n=await Ce.get("/reports/work-orders/pdf",{params:a,responseType:"blob"}),s=n.headers["content-disposition"];let l=`work_orders_report_${new Date().toISOString().split("T")[0]}.pdf`;if(s){const u=s.match(/filename=(.+)/);u&&(l=u[1])}we(n.data,l)},async exportWorkOrderDetailPdf(a){const n=await Ce.get(`/reports/work-orders/${a}/pdf`,{responseType:"blob"}),s=n.headers["content-disposition"];let l=`work_order_${a}.pdf`;if(s){const u=s.match(/filename=(.+)/);u&&(l=u[1])}we(n.data,l)},async exportPersonnelPdf(a={}){const n=await Ce.get("/reports/personnel/pdf",{params:a,responseType:"blob"}),s=n.headers["content-disposition"];let l=`personnel_report_${new Date().toISOString().split("T")[0]}.pdf`;if(s){const u=s.match(/filename=(.+)/);u&&(l=u[1])}we(n.data,l)},async exportEquipmentPdf(a={}){const n=await Ce.get("/reports/equipment/pdf",{params:a,responseType:"blob"}),s=n.headers["content-disposition"];let l=`equipment_report_${new Date().toISOString().split("T")[0]}.pdf`;if(s){const u=s.match(/filename=(.+)/);u&&(l=u[1])}we(n.data,l)}},{TextArea:_n}=le,vn=[{label:"失效分析",value:"failure_analysis"},{label:"可靠性测试",value:"reliability_test"}],jn=[{label:"草稿",value:"draft"},{label:"待处理",value:"pending"},{label:"已分配",value:"assigned"},{label:"进行中",value:"in_progress"},{label:"暂停",value:"on_hold"},{label:"待审核",value:"review"},{label:"已完成",value:"completed"},{label:"已取消",value:"cancelled"}],Sn=[{label:"最高 (1)",value:1},{label:"高 (2)",value:2},{label:"中 (3)",value:3},{label:"低 (4)",value:4},{label:"最低 (5)",value:5}];function Cn({visible:a,workOrder:n,sites:s,laboratories:l,clients:u,onSuccess:T,onCancel:k}){const{message:j}=he.useApp(),[y]=A.useForm(),[$,R]=r.useState(!1),[b,P]=r.useState(),[f,E]=r.useState(),[S,m]=r.useState(),[_,o]=r.useState([]),[w,v]=r.useState(!1),[q,B]=r.useState([]),[N,z]=r.useState(!1),[c,d]=r.useState([]),[p,F]=r.useState(!1),[K,H]=r.useState(),[O,L]=r.useState(null),[W,C]=r.useState(!1),I=b?l.filter(x=>x.site_id===b):l;r.useEffect(()=>{F(!0),Be.getAllSourceCategories().then(x=>{d(x||[])}).catch(()=>{d([]),j.error("加载来源类别失败")}).finally(()=>{F(!1)})},[]),r.useEffect(()=>{if(f&&K&&c.length>0){const x=c.find(U=>U.code===K);x?(C(!0),Be.getClientSLAs({client_id:f,source_category_id:x.id,is_active:!0,page_size:1}).then(U=>{U.items&&U.items.length>0?L(U.items[0]):L(null)}).catch(()=>{L(null),j.error("查询SLA配置失败")}).finally(()=>{C(!1)})):L(null)}else L(null)},[f,K,c]),r.useEffect(()=>{f?(v(!0),Nt.getProducts({client_id:f,is_active:!0,page_size:100}).then(x=>{o(x.items||[])}).catch(()=>{o([]),j.error("加载产品列表失败")}).finally(()=>{v(!1)})):o([])},[f]),r.useEffect(()=>{a&&b&&f&&S?(z(!0),ee.getAvailableMaterials({page_size:100,site_id:b,client_id:f,product_id:S}).then(x=>{B(x.items||[])}).catch(()=>{B([]),j.error("加载可用样品失败")}).finally(()=>{z(!1)})):a&&B([])},[a,b,f,S]),r.useEffect(()=>{a&&(n?(P(n.site_id),E(n.client_id??void 0),m(n.product_id??void 0),H(n.testing_source??void 0),y.setFieldsValue({...n,material_ids:n.material_ids||[],sla_deadline:n.sla_deadline?ne(n.sla_deadline):void 0})):(y.resetFields(),y.setFieldsValue({work_order_type:"failure_analysis",priority:3,material_ids:[]}),P(void 0),E(void 0),m(void 0),H(void 0),L(null),o([])))},[a,n,y]);const G=x=>{P(x);const U=y.getFieldValue("laboratory_id");if(U&&x){const X=l.find(h=>h.id===U);X&&X.site_id!==x&&y.setFieldValue("laboratory_id",void 0)}},te=x=>{E(x),m(void 0),y.setFieldValue("product_id",void 0),y.setFieldValue("material_ids",[])},se=x=>{m(x),y.setFieldValue("material_ids",[])},fe=x=>{H(x)},oe=x=>x>=20?"error":x>=10?"warning":x>=5?"info":"success",de=x=>{let X=`SLA建议: ${x.priority_weight>=20?"紧急":x.priority_weight>=10?"优先":x.priority_weight>=5?"标准":"常规"}处理`;return X+=` | 承诺时间: ${x.commitment_hours}小时`,x.max_hours&&(X+=` | 最长时间: ${x.max_hours}小时`),x.description&&(X+=` | ${x.description}`),X},ge=async()=>{try{const x=await y.validateFields();R(!0);const U=x.sla_deadline,X={...x,sla_deadline:U&&ne.isDayjs(U)?U.toISOString():void 0};n?(await ee.updateWorkOrder(n.id,X),j.success("更新成功")):(await ee.createWorkOrder(X),j.success("创建成功")),T()}catch{j.error(n?"更新失败":"创建失败")}finally{R(!1)}};return e.jsx(Ie,{title:n?"编辑工单":"新增工单",open:a,onCancel:k,width:800,footer:e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:8},children:[e.jsx(V,{onClick:k,children:"取消"}),e.jsx(V,{type:"primary",onClick:ge,loading:$,children:"确定"})]}),children:e.jsxs(A,{form:y,layout:"vertical",children:[e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"基本信息"})}),e.jsxs(ue,{gutter:16,children:[e.jsx(Z,{span:16,children:e.jsx(A.Item,{name:"title",label:"工单标题",rules:[{required:!0,message:"请输入工单标题"}],children:e.jsx(le,{placeholder:"请输入工单标题"})})}),e.jsx(Z,{span:8,children:e.jsx(A.Item,{name:"work_order_type",label:"工单类型",rules:[{required:!0,message:"请选择工单类型"}],children:e.jsx(Y,{placeholder:"请选择工单类型",options:vn,disabled:!!n})})})]}),e.jsx(A.Item,{name:"description",label:"描述",children:e.jsx(_n,{rows:3,placeholder:"请输入工单描述"})}),e.jsxs(ue,{gutter:16,children:[e.jsx(Z,{span:12,children:e.jsx(A.Item,{name:"site_id",label:"所属站点",rules:[{required:!0,message:"请选择所属站点"}],children:e.jsx(Y,{placeholder:"请选择所属站点",onChange:G,disabled:!!n,options:s.map(x=>({label:`${x.name} (${x.code})`,value:x.id}))})})}),e.jsx(Z,{span:12,children:e.jsx(A.Item,{name:"laboratory_id",label:"所属实验室",rules:[{required:!0,message:"请选择所属实验室"}],children:e.jsx(Y,{placeholder:"请先选择所属站点",disabled:!b||!!n,options:I.map(x=>({label:`${x.name} (${x.code})`,value:x.id}))})})})]}),e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16,marginTop:24},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"客户与优先级"})}),e.jsxs(ue,{gutter:16,children:[e.jsx(Z,{span:8,children:e.jsx(A.Item,{name:"client_id",label:"客户",children:e.jsx(Y,{placeholder:"请选择客户",allowClear:!0,onChange:te,options:u.map(x=>({label:`${x.name} (${x.code})`,value:x.id}))})})}),e.jsx(Z,{span:8,children:e.jsx(A.Item,{name:"product_id",label:"产品名称",children:e.jsx(Y,{placeholder:f?"请选择产品":"请先选择客户",allowClear:!0,disabled:!f,loading:w,onChange:se,options:_.map(x=>({label:`${x.name} (${x.code})`,value:x.id}))})})}),e.jsx(Z,{span:8,children:e.jsx(A.Item,{name:"testing_source",label:"任务来源",children:e.jsx(Y,{placeholder:"请选择任务来源",loading:p,onChange:fe,options:c.map(x=>({label:x.name,value:x.code}))})})})]}),e.jsx(ue,{gutter:16,children:e.jsx(Z,{span:8,children:e.jsx(A.Item,{name:"priority_level",label:"优先级",children:e.jsx(Y,{placeholder:"请选择优先级",options:Sn})})})}),e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16,marginTop:24},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"样品选择"})}),e.jsx(ue,{gutter:16,children:e.jsx(Z,{span:24,children:e.jsx(A.Item,{name:"material_ids",label:"选择样品",tooltip:"请先选择客户和产品，样品列表会自动过滤为同客户、同产品的样品",children:e.jsx(Y,{mode:"multiple",placeholder:f?S?"请选择样品（可多选）":"请先选择产品":"请先选择客户",allowClear:!0,disabled:!f||!S,loading:N,optionFilterProp:"label",showSearch:!0,options:q.map(x=>({label:`${x.name} (${x.material_code}) - ${x.storage_location||"未知位置"}`,value:x.id}))})})})}),e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16,marginTop:24},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"时间要求"})}),W&&e.jsx(pe,{message:"正在查询SLA配置...",type:"info",showIcon:!0,style:{marginBottom:16}}),!W&&O&&e.jsx(pe,{message:de(O),type:oe(O.priority_weight),showIcon:!0,style:{marginBottom:16}}),!W&&f&&K&&!O&&e.jsx(pe,{message:"未找到匹配的SLA配置，请根据实际情况设置时间要求",type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsxs(ue,{gutter:16,children:[e.jsx(Z,{span:8,children:e.jsx(A.Item,{name:"sla_deadline",label:"截止日",children:e.jsx(Ft,{placeholder:"截止日",style:{width:"100%"}})})}),e.jsx(Z,{span:8,children:e.jsx(A.Item,{name:"standard_cycle_hours",label:"预计周期(小时)",children:e.jsx(me,{min:.1,step:.5,placeholder:"预计周期",style:{width:"100%"}})})}),n&&e.jsx(Z,{span:8,children:e.jsx(A.Item,{name:"status",label:"状态",children:e.jsx(Y,{placeholder:"请选择状态",options:jn})})})]})]})})}const{TextArea:wn}=le,$n={registered:{text:"已登记",color:"blue"},voided:{text:"已作废",color:"default"}};function In({workOrderId:a,taskId:n,taskNumber:s}){const{message:l,modal:u}=he.useApp(),[T,k]=r.useState([]),[j,y]=r.useState(!1),[$,R]=r.useState([]),[b,P]=r.useState(!1),[f,E]=r.useState([]),[S,m]=r.useState(!1),_=r.useCallback(async()=>{y(!0);try{const c=await ee.getConsumptions(a,n,{page_size:100});k(c.items)}catch(c){console.error("Failed to load consumptions:",c),l.error("加载消耗记录失败")}finally{y(!1)}},[a,n,l]),o=r.useCallback(async()=>{P(!0);try{const c=await Ee.getMaterials({page_size:100});console.log("Materials API response:",c);const d=c.items.filter(p=>p.material_type!=="sample");console.log("Filtered materials (non-sample):",d.length),R(d.map(p=>({id:p.id,material_code:p.material_code,name:p.name,quantity:p.quantity,unit:p.unit})))}catch(c){console.error("Failed to load materials:",c),l.error("加载材料列表失败")}finally{P(!1)}},[l]);r.useEffect(()=>{_(),o()},[_,o]);const w=()=>{E([...f,{key:`new-${Date.now()}`,material_id:void 0,quantity_consumed:void 0,unit_price:void 0,notes:void 0}])},v=c=>{E(f.filter(d=>d.key!==c))},q=(c,d,p)=>{E(f.map(F=>F.key===c?{...F,[d]:p}:F))},B=async()=>{const c=f.filter(d=>d.material_id&&d.quantity_consumed&&d.quantity_consumed>0);if(c.length===0){l.warning("请填写至少一条有效的消耗记录");return}for(const d of c){const p=$.find(F=>F.id===d.material_id);if(p&&d.quantity_consumed>p.quantity){l.error(`材料 "${p.name}" 库存不足 (当前: ${p.quantity})`);return}}m(!0);try{const d=c.map(p=>({material_id:p.material_id,quantity_consumed:p.quantity_consumed,unit_price:p.unit_price,notes:p.notes}));await ee.createConsumptions(a,n,{consumptions:d}),l.success(`成功登记 ${d.length} 条消耗记录`),E([]),_(),o()}catch(d){const p=d&&typeof d=="object"&&"response"in d?d.response?.data?.detail:"保存失败";l.error(p||"保存失败")}finally{m(!1)}},N=c=>{let d="";u.confirm({title:"作废消耗记录",icon:e.jsx(Ot,{}),content:e.jsxs("div",{children:[e.jsxs("p",{children:["确定要作废消耗记录 ",e.jsxs("strong",{children:["CON-",c.id]})," 吗？"]}),e.jsxs("p",{children:["材料: ",c.material?.name," | 数量: ",c.quantity_consumed," ",c.material?.unit]}),e.jsx("p",{style:{color:"#666",fontSize:12},children:"作废后将自动补充库存，此操作不可撤销。"}),e.jsx(wn,{placeholder:"请输入作废原因（必填）",rows:2,onChange:p=>{d=p.target.value},style:{marginTop:8}})]}),okText:"确认作废",okType:"danger",cancelText:"取消",onOk:async()=>{if(!d.trim())throw l.error("请输入作废原因"),new Error("Void reason required");try{await ee.voidConsumption(c.id,{void_reason:d.trim()}),l.success("消耗记录已作废，库存已恢复"),_(),o()}catch(p){throw l.error("作废失败"),p}}})},z=[{title:"材料",dataIndex:["material","name"],key:"material",render:(c,d)=>d.material?e.jsxs("span",{children:[d.material.name,e.jsxs("span",{style:{color:"#999",fontSize:12,marginLeft:4},children:["(",d.material.material_code,")"]})]}):"-"},{title:"数量",dataIndex:"quantity_consumed",key:"quantity",width:100,render:(c,d)=>`${c} ${d.material?.unit||""}`},{title:"单价",dataIndex:"unit_price",key:"unit_price",width:100,render:c=>c!==void 0?`¥${c}`:"-"},{title:"总成本",dataIndex:"total_cost",key:"total_cost",width:100,render:c=>c!==void 0?`¥${c}`:"-"},{title:"状态",dataIndex:"status",key:"status",width:80,render:c=>{const d=$n[c]||{text:c,color:"default"};return e.jsx(ae,{color:d.color,children:d.text})}},{title:"登记时间",dataIndex:"consumed_at",key:"consumed_at",width:150,render:c=>new Date(c).toLocaleString("zh-CN")},{title:"操作",key:"action",width:80,render:(c,d)=>d.status==="registered"?e.jsx(V,{type:"link",danger:!0,size:"small",onClick:()=>N(d),children:"作废"}):e.jsx("span",{style:{color:"#999",fontSize:12},children:d.void_reason&&`原因: ${d.void_reason}`})}];return e.jsxs("div",{style:{marginTop:16},children:[e.jsxs(ct,{orientation:"left",children:["材料消耗 (",s,")"]}),e.jsx(ke,{columns:z,dataSource:T,rowKey:"id",size:"small",loading:j,pagination:!1,locale:{emptyText:e.jsx(Bt,{description:"暂无消耗记录"})},style:{marginBottom:16},rowClassName:c=>c.status==="voided"?"consumption-voided":""}),e.jsxs("div",{style:{background:"#fafafa",padding:16,borderRadius:4,border:"1px dashed #d9d9d9"},children:[e.jsx("div",{style:{marginBottom:12,fontWeight:500},children:"新增消耗"}),f.length===0?e.jsx(V,{type:"dashed",icon:e.jsx(je,{}),onClick:w,children:"添加材料消耗"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{marginBottom:8,fontSize:12,color:"#999"},children:["材料加载状态: ",b?"加载中...":`已加载 ${$.length} 种材料`]}),f.map(c=>{const d=$.find(p=>p.id===c.material_id);return e.jsxs("div",{style:{display:"flex",gap:8,marginBottom:8,alignItems:"flex-start"},children:[e.jsx(A.Item,{style:{flex:3,marginBottom:0},children:e.jsx(Y,{placeholder:"选择材料",value:c.material_id,onChange:p=>q(c.key,"material_id",p),loading:b,showSearch:!0,optionFilterProp:"label",options:$.map(p=>({label:`${p.name} (${p.material_code}) - 库存: ${p.quantity} ${p.unit}`,value:p.id}))})}),e.jsx(A.Item,{style:{flex:1,marginBottom:0},children:e.jsx(me,{placeholder:"数量",min:1,max:d?.quantity,value:c.quantity_consumed,onChange:p=>q(c.key,"quantity_consumed",p),style:{width:"100%"}})}),e.jsx(A.Item,{style:{flex:1,marginBottom:0},children:e.jsx(me,{placeholder:"单价(可选)",min:0,precision:2,value:c.unit_price,onChange:p=>q(c.key,"unit_price",p),style:{width:"100%"}})}),e.jsx(A.Item,{style:{flex:2,marginBottom:0},children:e.jsx(le,{placeholder:"备注(可选)",value:c.notes,onChange:p=>q(c.key,"notes",p.target.value)})}),e.jsx(V,{type:"text",icon:e.jsx(nt,{}),danger:!0,onClick:()=>v(c.key)})]},c.key)}),e.jsxs(Se,{style:{marginTop:8},children:[e.jsx(V,{type:"dashed",icon:e.jsx(je,{}),onClick:w,children:"添加更多"}),e.jsx(V,{type:"primary",onClick:B,loading:S,children:"保存消耗记录"})]})]})]}),e.jsx("style",{children:`
        .consumption-voided {
          background-color: #f5f5f5 !important;
          opacity: 0.6;
        }
        .consumption-voided td {
          text-decoration: line-through;
        }
      `})]})}const qe={1:"#ef4444",2:"#f97316",3:"#3b82f6",4:"#22c55e",5:"#6b7280"},Oe={1:"紧急",2:"高",3:"正常",4:"低",5:"常规"},kn={scheduled:"已排程",in_progress:"进行中",completed:"已完成",cancelled:"已取消"};function He({equipmentNameId:a,siteId:n,onTimeSelected:s,initialSelection:l}){const{message:u}=he.useApp(),[T,k]=r.useState(!0),[j,y]=r.useState([]),[$,R]=r.useState(""),[b,P]=r.useState([]),[f,E]=r.useState(""),[S,m]=r.useState(ne().startOf("day")),[_,o]=r.useState(!1),[w,v]=r.useState(null),[q,B]=r.useState(null),[N,z]=r.useState(null),[c,d]=r.useState(null),p=r.useRef(null),F=r.useMemo(()=>S.add(6,"day").endOf("day"),[S]),K=7,H=K*24,O=r.useMemo(()=>{const t=[];let i=S.startOf("day");for(let g=0;g<K;g++)t.push({date:i,label:i.format("MM/DD")}),i=i.add(1,"day");return t},[S]),L=r.useMemo(()=>{const t=[];for(let i=0;i<K;i++)for(let g=0;g<24;g+=6)t.push({hour:i*24+g,label:`${g}:00`});return t},[]),W=r.useCallback(async()=>{k(!0);try{const t=await ve.getEquipmentByName(a,n);if(y(t.items),R(t.equipment_name),t.items.length>0){const i=l&&t.items.find(D=>D.id===l.equipmentId)||t.items[0];E(String(i.id));const g=t.items.map(D=>D.id),M=await ve.getGanttData({start_date:S.format("YYYY-MM-DD"),end_date:F.format("YYYY-MM-DD"),equipment_ids:g});P(M.equipment),l&&z({equipmentId:l.equipmentId,equipmentCode:i.code,startTime:ne(l.startTime),endTime:ne(l.endTime)})}}catch(t){u.error("获取设备数据失败"),console.error(t)}finally{k(!1)}},[a,n,S,F,u,l]);r.useEffect(()=>{W()},[W]);const C=r.useMemo(()=>{const t=Number(f);return b.find(g=>g.id===t)?.schedules||[]},[f,b]),I=r.useCallback((t,i)=>{const g=S.add(t,"hour"),M=S.add(i,"hour");for(const D of C){const xe=ne(D.start_time),ie=ne(D.end_time);if(g.isBefore(ie)&&M.isAfter(xe))return!0}return!1},[C,S]),G=t=>{o(!0),v({hour:t}),B({hour:t}),d(null)},te=t=>{!_||!w||B({hour:t})},se=()=>{if(!_||!w||!q){o(!1);return}const t=Math.min(w.hour,q.hour),i=Math.max(w.hour,q.hour)+1;if(I(t,i)){d("所选时间段与已有排程冲突，请选择其他时间"),o(!1),v(null),B(null);return}const g=j.find(D=>D.id===Number(f));if(!g){o(!1);return}const M={equipmentId:g.id,equipmentCode:g.code,startTime:S.add(t,"hour"),endTime:S.add(i,"hour")};z(M),o(!1),v(null),B(null),d(null),s?.(M)},fe=()=>{_&&(o(!1),v(null),B(null))},oe=()=>{z(null),s?.(null)},de=t=>{const i=ne(t.start_time),g=ne(t.end_time),M=S.startOf("day"),D=F.endOf("day"),xe=i.isBefore(M)?M:i,ie=g.isAfter(D)?D:g,ut=xe.diff(M,"hour",!0),mt=ie.diff(xe,"hour",!0),Pe=ut/H*100,pt=mt/H*100,ht=t.priority_level||3,ft=qe[ht]||qe[3];return{left:`${Math.max(0,Pe)}%`,width:`${Math.min(100-Pe,Math.max(.5,pt))}%`,backgroundColor:ft}},ge=()=>{if(!w||!q)return null;const t=Math.min(w.hour,q.hour),i=Math.max(w.hour,q.hour)+1,g=t/H*100,M=(i-t)/H*100,D=I(t,i);return{left:`${g}%`,width:`${M}%`,backgroundColor:D?"rgba(239, 68, 68, 0.3)":"rgba(59, 130, 246, 0.3)",border:D?"2px dashed #ef4444":"2px dashed #3b82f6"}},x=()=>{if(!N||Number(f)!==N.equipmentId)return null;const t=N.startTime.diff(S,"hour",!0),i=N.endTime.diff(N.startTime,"hour",!0),g=t/H*100,M=i/H*100;return{left:`${Math.max(0,g)}%`,width:`${Math.min(100,M)}%`,backgroundColor:"rgba(34, 197, 94, 0.4)",border:"2px solid #22c55e"}},U=()=>m(S.subtract(7,"day")),X=()=>m(S.add(7,"day")),h=()=>m(ne().startOf("day"));return T?e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:"48px 0"},children:e.jsx($e,{size:"large"})}):j.length===0?e.jsx(pe,{type:"warning",message:"该站点下没有可用的同名设备",description:"请联系管理员添加设备或选择其他设备名"}):e.jsxs("div",{style:{background:"#fff",borderRadius:8,border:"1px solid #e5e5e5"},children:[e.jsxs("div",{style:{padding:"12px 16px",borderBottom:"1px solid #e5e5e5",background:"#fafafa",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsxs("span",{style:{fontWeight:500,color:"#171717"},children:["关键设备调度 - ",$]}),e.jsxs("span",{style:{marginLeft:8,fontSize:12,color:"#737373"},children:["(",j.length," 台设备)"]})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("button",{onClick:U,style:{border:"1px solid #d4d4d4",borderRadius:4,padding:"4px 8px",background:"#fff",cursor:"pointer"},children:e.jsx(qt,{})}),e.jsx("button",{onClick:h,style:{border:"1px solid #d4d4d4",borderRadius:4,padding:"4px 8px",background:"#fff",cursor:"pointer",fontSize:12},children:"本周"}),e.jsx("button",{onClick:X,style:{border:"1px solid #d4d4d4",borderRadius:4,padding:"4px 8px",background:"#fff",cursor:"pointer"},children:e.jsx(Te,{})}),e.jsxs("span",{style:{marginLeft:8,fontSize:12,color:"#737373"},children:[S.format("YYYY/MM/DD")," - ",F.format("MM/DD")]})]})]}),e.jsx(Mt,{activeKey:f,onChange:E,style:{padding:"0 16px"},items:j.map(t=>({key:String(t.id),label:e.jsxs("span",{children:[t.code,N?.equipmentId===t.id&&e.jsx("span",{style:{marginLeft:4,color:"#22c55e"},children:"*"})]})}))}),c&&e.jsx(pe,{type:"error",message:c,showIcon:!0,closable:!0,onClose:()=>d(null),style:{margin:"0 16px 16px"}}),N&&e.jsx(pe,{type:"success",message:e.jsxs("span",{children:["已选择时间: ",N.startTime.format("MM/DD HH:mm")," - ",N.endTime.format("MM/DD HH:mm"),"(设备 ",N.equipmentCode,")",e.jsx("a",{onClick:oe,style:{marginLeft:16,color:"#ef4444"},children:"清除选择"})]}),showIcon:!0,style:{margin:"0 16px 16px"}}),e.jsx("div",{ref:p,style:{padding:"0 16px 16px",overflowX:"auto"},onMouseLeave:fe,children:e.jsxs("div",{style:{minWidth:1200},children:[e.jsxs("div",{style:{display:"flex",borderBottom:"1px solid #e5e5e5"},children:[e.jsx("div",{style:{width:60,minWidth:60,padding:"8px 4px",background:"#fafafa",borderRight:"1px solid #e5e5e5",textAlign:"center",fontSize:11,color:"#737373"},children:"时间"}),e.jsx("div",{style:{flex:1,display:"flex"},children:O.map((t,i)=>e.jsxs("div",{style:{flex:1,textAlign:"center",padding:"4px",fontSize:12,borderRight:"1px solid #f5f5f5",background:t.date.isSame(ne(),"day")?"#f0f5ff":"#fafafa"},children:[e.jsx("div",{style:{fontWeight:500},children:t.label}),e.jsx("div",{style:{fontSize:10,color:"#a3a3a3"},children:t.date.format("ddd")})]},i))})]}),e.jsxs("div",{style:{display:"flex",borderBottom:"1px solid #e5e5e5"},children:[e.jsx("div",{style:{width:60,minWidth:60,background:"#fafafa",borderRight:"1px solid #e5e5e5"}}),e.jsx("div",{style:{flex:1,display:"flex",position:"relative",height:20},children:L.map((t,i)=>e.jsx("div",{style:{position:"absolute",left:`${t.hour/H*100}%`,fontSize:9,color:"#a3a3a3",transform:"translateX(-50%)",whiteSpace:"nowrap"},children:t.label},i))})]}),e.jsxs("div",{style:{display:"flex",minHeight:80,userSelect:"none"},children:[e.jsx("div",{style:{width:60,minWidth:60,background:"#fafafa",borderRight:"1px solid #e5e5e5",display:"flex",alignItems:"center",justifyContent:"center",fontSize:11,color:"#737373"},children:"排程"}),e.jsxs("div",{style:{flex:1,position:"relative",background:"#fff",cursor:"crosshair"},onMouseUp:se,children:[e.jsx("div",{style:{position:"absolute",inset:0,display:"flex",pointerEvents:"none"},children:O.map((t,i)=>e.jsx("div",{style:{flex:1,borderRight:"1px solid #f5f5f5",background:t.date.isSame(ne(),"day")?"rgba(240,245,255,0.3)":void 0}},i))}),e.jsx("div",{style:{position:"absolute",inset:0,display:"flex"},children:Array.from({length:H}).map((t,i)=>e.jsx("div",{style:{flex:1,borderRight:i%24===23?"1px solid #e5e5e5":"1px solid #fafafa"},onMouseDown:()=>G(i),onMouseMove:()=>te(i)},i))}),C.map(t=>e.jsx(_e,{title:e.jsxs("div",{children:[e.jsx("div",{children:t.title||"排程"}),e.jsxs("div",{children:["开始: ",ne(t.start_time).format("MM/DD HH:mm")]}),e.jsxs("div",{children:["结束: ",ne(t.end_time).format("MM/DD HH:mm")]}),e.jsxs("div",{children:["优先级: ",Oe[t.priority_level||3]]}),e.jsxs("div",{children:["状态: ",kn[t.status]]}),t.operator_name&&e.jsxs("div",{children:["操作员: ",t.operator_name]})]}),children:e.jsx("div",{style:{position:"absolute",top:12,height:"calc(100% - 24px)",minHeight:32,borderRadius:4,display:"flex",alignItems:"center",padding:"0 8px",color:"#fff",fontSize:11,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",boxShadow:"0 1px 2px rgba(0,0,0,0.1)",zIndex:10,pointerEvents:"none",...de(t)},children:t.title||`#${t.task_id||t.id}`})},t.id)),_&&w&&q&&e.jsx("div",{style:{position:"absolute",top:8,height:"calc(100% - 16px)",borderRadius:4,zIndex:20,pointerEvents:"none",...ge()}}),x()&&e.jsx("div",{style:{position:"absolute",top:8,height:"calc(100% - 16px)",borderRadius:4,zIndex:15,pointerEvents:"none",display:"flex",alignItems:"center",justifyContent:"center",color:"#166534",fontSize:11,fontWeight:500,...x()},children:"已选择"}),C.length===0&&!N&&!_&&e.jsx("div",{style:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",color:"#d4d4d4",fontSize:12,pointerEvents:"none"},children:"拖动选择时间段"})]})]})]})}),e.jsxs("div",{style:{padding:"8px 16px 16px",display:"flex",alignItems:"center",justifyContent:"space-between",fontSize:11,color:"#737373"},children:[e.jsx("div",{style:{display:"flex",alignItems:"center",gap:12},children:e.jsx("span",{children:"操作提示: 拖动鼠标选择时间段"})}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("span",{children:"图例:"}),Object.entries(Oe).map(([t,i])=>e.jsx("span",{style:{display:"inline-block",padding:"2px 6px",borderRadius:3,backgroundColor:qe[Number(t)],color:"#fff",fontSize:10},children:i},t)),e.jsx("span",{style:{display:"inline-block",padding:"2px 6px",borderRadius:3,backgroundColor:"rgba(34, 197, 94, 0.4)",border:"1px solid #22c55e",color:"#166534",fontSize:10},children:"已选择"})]})]})]})}const qn={analytical:["analytical"],chemical:["mechanical","analytical"],physical:["mechanical","measurement"],electrical:["electrical","measurement"],environmental:["environmental","thermal"],reliability:["environmental","thermal","mechanical"],thermal:["thermal","environmental"],mechanical:["mechanical"],optical:["optical","analytical"]};function Mn(a){return a?qn[a.toLowerCase()]||["other"]:["other"]}const{TextArea:We}=le,Tn=[{label:"待处理",value:"pending"},{label:"已分配",value:"assigned"},{label:"进行中",value:"in_progress"},{label:"已完成",value:"completed"},{label:"阻塞",value:"blocked"},{label:"已取消",value:"cancelled"}];function En({visible:a,workOrderId:n,task:s,laboratoryId:l,siteId:u,workOrderType:T,onSuccess:k,onCancel:j}){const{message:y}=he.useApp(),[$]=A.useForm(),[R,b]=r.useState(!1),[P,f]=r.useState([]),[E,S]=r.useState([]),[m,_]=r.useState(!1),[o,w]=r.useState(null),[v,q]=r.useState(null),[B,N]=r.useState(!1),[z,c]=r.useState(!1),[d,p]=r.useState(null),[F,K]=r.useState(!1),[H,O]=r.useState(null),[L,W]=r.useState([]),[C,I]=r.useState(!1),[G,te]=r.useState([]);r.useEffect(()=>{console.log("TaskModal: materials state updated:",L.length,"items"),L.length>0&&console.log("TaskModal: First 3 materials in state:",L.slice(0,3))},[L]);const se=r.useCallback(async h=>{if(!u){const t={page_size:100};l&&(t.laboratory_id=l);const i=await ve.getEquipment(t);f(i.items.filter(g=>g.is_active));return}_(!0);try{const t=h?.category?Mn(h.category):void 0,i={site_id:u,page_size:100};t&&t.length>0&&t[0]!=="other"&&(i.category=t);const g=await ve.getEquipment(i);f(g.items.filter(M=>M.is_active))}catch(t){console.error("Failed to load equipment:",t),f([])}finally{_(!1)}},[u,l]);r.useEffect(()=>{if(a){const h=T==="failure_analysis"?"analysis":T==="reliability_test"?"reliability":void 0,t={page_size:100,is_active:!0};h&&(t.method_type=h),u&&(t.site_id=u),De.getMethods(t).then(i=>{S(i.items)}),I(!0),console.log("TaskModal: Starting materials API call..."),Ee.getMaterials({page_size:100}).then(i=>{if(console.log("TaskModal: Materials API raw response:",i),console.log("TaskModal: Response type:",typeof i),console.log("TaskModal: Has items?",!!i?.items),console.log("TaskModal: Items length:",i?.items?.length),!i||!i.items){console.error("TaskModal: Invalid response structure - missing items array");return}const g=i.items.filter(D=>D.material_type!=="sample");console.log("TaskModal: Filtered materials (non-sample):",g.length),console.log("TaskModal: First few materials:",g.slice(0,3).map(D=>({id:D.id,name:D.name,type:D.material_type})));const M=g.map(D=>({id:D.id,material_code:D.material_code,name:D.name,quantity:D.quantity,unit:D.unit}));console.log("TaskModal: Setting materials state with",M.length,"items"),W(M)}).catch(i=>{console.error("TaskModal: Failed to load materials:",i),console.error("TaskModal: Error details:",i?.response?.status,i?.response?.data)}).finally(()=>{console.log("TaskModal: Materials loading finished"),I(!1)}),se(null),s?($.setFieldsValue({title:s.title,description:s.description,sequence:s.sequence,method_id:s.method_id,required_equipment_id:s.required_equipment_id,required_capacity:s.required_capacity,standard_cycle_hours:s.standard_cycle_hours,status:s.status,notes:s.notes}),s.method_id&&De.getMethods({page_size:100,is_active:!0}).then(i=>{const g=i.items.find(M=>M.id===s.method_id);g&&w(g)}),s.required_equipment_id&&ve.getEquipment({page_size:100}).then(i=>{const g=i.items.find(M=>M.id===s.required_equipment_id);g?.equipment_name?.is_critical&&(c(!0),O(g.equipment_name_id||null))}),K(!1),p(null)):($.resetFields(),q(null),w(null),c(!1),p(null),te([]),K(!1),O(null))}},[a,s,u,T,$,se]);const fe=async h=>{if($.setFieldValue("required_equipment_id",void 0),q(null),h){const t=E.find(i=>i.id===h);w(t||null),t&&(await se(t),t.standard_cycle_hours&&$.setFieldValue("standard_cycle_hours",t.standard_cycle_hours),t.default_equipment?.id&&setTimeout(()=>{P.some(D=>D.id===t.default_equipment?.id)&&($.setFieldValue("required_equipment_id",t.default_equipment.id),oe(t.default_equipment.id))},100),$.getFieldValue("title")||$.setFieldValue("title",t.name))}else w(null),await se(null)},oe=async h=>{if(!h){q(null),c(!1),p(null);return}const i=P.find(g=>g.id===h)?.equipment_name?.is_critical===!0;c(i),d&&d.equipmentId!==h&&p(null),N(!0);try{const g=await ve.getEquipmentCapacity(h);g.has_capacity_limit?q({total:g.total_capacity||0,available:g.available_capacity||0,hasLimit:!0}):q({total:0,available:0,hasLimit:!1})}catch(g){console.error("Failed to load capacity info:",g),q(null)}finally{N(!1)}},de=()=>{te([...G,{key:`pending-${Date.now()}`,material_id:void 0,quantity_consumed:void 0,unit_price:void 0,notes:void 0}])},ge=h=>{te(G.filter(t=>t.key!==h))},x=(h,t,i)=>{te(G.map(g=>g.key===h?{...g,[t]:i}:g))},U=async()=>{try{const h=await $.validateFields();if(z&&!d)if(s){if(F){y.warning("请选择新的调度时间");return}}else{y.warning("请为关键设备选择调度时间");return}if(b(!0),s){const t={title:h.title||"",description:h.description||void 0,sequence:h.sequence,method_id:h.method_id||void 0,status:h.status,notes:h.notes||void 0};F&&d&&(t.update_schedule=!0,t.schedule_start_time=d.startTime.toISOString(),t.schedule_end_time=d.endTime.toISOString()),await ee.updateTask(n,s.id,t),y.success(F&&d?"任务更新成功，设备预约已调整":"任务更新成功")}else{const t={title:h.title||"",description:h.description||void 0,sequence:h.sequence,method_id:h.method_id||void 0,required_equipment_id:h.required_equipment_id||void 0,required_capacity:h.required_capacity||void 0,standard_cycle_hours:h.standard_cycle_hours||void 0,schedule_start_time:d?.startTime.toISOString(),schedule_end_time:d?.endTime.toISOString()},i=await ee.createTask(n,t),g=G.filter(M=>M.material_id&&M.quantity_consumed&&M.quantity_consumed>0);if(g.length>0&&i.id)try{const M=g.map(D=>({material_id:D.material_id,quantity_consumed:D.quantity_consumed,unit_price:D.unit_price,notes:D.notes}));await ee.createConsumptions(n,i.id,{consumptions:M}),y.success(`任务创建成功，已登记 ${M.length} 条材料消耗`)}catch(M){console.error("Failed to create consumptions:",M),y.warning("任务已创建，但材料消耗登记失败，请稍后在编辑页面添加")}else y.success("任务创建成功")}k()}catch(h){if(h&&typeof h=="object"&&"errorFields"in h)return;let t=s?"更新失败":"创建失败";if(h&&typeof h=="object"){const i=h;i.response?.data?.detail?t=i.response.data.detail:i.response?.status===409&&(t="设备调度时间冲突，请选择其他时间段")}y.error(t)}finally{b(!1)}},X=A.useWatch("required_equipment_id",$);return e.jsxs(Ie,{title:s?"编辑任务":"新增任务",open:a,onCancel:j,width:z?1200:700,footer:e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:8},children:[e.jsx(V,{onClick:j,children:"取消"}),e.jsx(V,{type:"primary",onClick:U,loading:R,children:"确定"})]}),children:[e.jsxs(A,{form:$,layout:"vertical",children:[!s&&e.jsxs(e.Fragment,{children:[e.jsx(A.Item,{name:"method_id",label:"分析/测试方法",children:e.jsx(Y,{placeholder:"选择标准方法（可选）",allowClear:!0,onChange:fe,optionFilterProp:"label",options:E.map(h=>({label:`${h.name} (${h.code}) - ${h.standard_cycle_hours||"?"}h`,value:h.id}))})}),e.jsx("p",{style:{fontSize:12,color:"#999",marginTop:-8,marginBottom:12},children:"选择标准方法可自动填充周期时间和设备"}),e.jsx("hr",{style:{border:"none",borderTop:"1px solid #e5e5e5",margin:"16px 0"}})]}),e.jsx(A.Item,{name:"title",label:"任务名称",rules:[{required:!0,message:"请输入任务名称"}],children:e.jsx(le,{placeholder:"请输入任务名称"})}),e.jsx(A.Item,{name:"description",label:"任务描述",children:e.jsx(We,{rows:3,placeholder:"请输入任务描述"})}),e.jsxs(ue,{gutter:16,children:[e.jsx(Z,{span:12,children:e.jsx(A.Item,{name:"sequence",label:"执行顺序",children:e.jsx(me,{min:1,placeholder:"执行顺序",style:{width:"100%"}})})}),e.jsx(Z,{span:12,children:e.jsx(A.Item,{name:"standard_cycle_hours",label:"预计周期(小时)",children:e.jsx(me,{min:.1,step:.5,placeholder:"预计周期",disabled:!!s,style:{width:"100%"}})})})]}),e.jsx(A.Item,{name:"required_equipment_id",label:"所需设备",children:e.jsx(Y,{placeholder:m?"加载设备中...":o?`选择适用于 ${o.name} 的设备`:"请选择所需设备",allowClear:!0,disabled:!!s||m,loading:m,onChange:oe,optionFilterProp:"label",notFoundContent:m?e.jsx($e,{size:"small"}):o?"没有匹配的设备":"暂无设备",options:P.map(h=>({label:`${h.name} (${h.code})`,value:h.id}))})}),o&&!m&&P.length===0&&e.jsx(pe,{type:"warning",message:`当前站点没有适用于 "${o.name}" 方法的设备`,style:{marginTop:-8,marginBottom:16}}),!s&&v?.hasLimit&&e.jsx(pe,{type:v.available>0?"info":"warning",message:B?"加载中...":e.jsxs("span",{children:["可用容量: ",e.jsxs("strong",{children:[v.available,"/",v.total]})," 槽位",v.available===0&&e.jsx("span",{style:{color:"#ef4444",marginLeft:8},children:"(当前无可用容量)"})]}),style:{marginBottom:16}}),!s&&z&&u&&X&&e.jsx(cn,{defaultActiveKey:["scheduler"],style:{marginBottom:16},items:[{key:"scheduler",label:e.jsx("span",{style:{color:"#ef4444",fontWeight:500},children:"关键设备 - 必须选择调度时间"}),children:e.jsx(He,{equipmentNameId:P.find(h=>h.id===X)?.equipment_name_id||0,siteId:u,onTimeSelected:h=>p(h),initialSelection:d?{equipmentId:d.equipmentId,startTime:d.startTime.toISOString(),endTime:d.endTime.toISOString()}:void 0})}]}),!s&&e.jsx(A.Item,{name:"required_capacity",label:"所需容量(样品槽位)",children:e.jsx(me,{min:1,placeholder:"输入所需槽位数",disabled:!X,style:{width:"100%"}})}),s&&z&&u&&H&&e.jsxs("div",{style:{marginBottom:16},children:[e.jsx(Dt,{checked:F,onChange:h=>{K(h.target.checked),h.target.checked||p(null)},children:e.jsx("span",{style:{color:"#ef4444",fontWeight:500},children:"调整设备预约时间"})}),F&&e.jsx("div",{style:{marginTop:12},children:e.jsx(He,{equipmentNameId:H,siteId:u,onTimeSelected:h=>p(h),initialSelection:d?{equipmentId:d.equipmentId,startTime:d.startTime.toISOString(),endTime:d.endTime.toISOString()}:void 0})})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx(ue,{gutter:16,children:e.jsx(Z,{span:12,children:e.jsx(A.Item,{name:"status",label:"状态",children:e.jsx(Y,{placeholder:"请选择状态",options:Tn})})})}),e.jsx(A.Item,{name:"notes",label:"备注",children:e.jsx(We,{rows:2,placeholder:"请输入备注"})})]}),!s&&e.jsxs("div",{style:{marginTop:16},children:[e.jsx(ct,{orientation:"left",style:{marginTop:0},children:"材料消耗（可选）"}),e.jsx("div",{style:{marginBottom:8,fontSize:12,color:"#666"},children:C?"材料加载中...":`已加载 ${L.length} 种可消耗材料`}),e.jsx("div",{style:{background:"#fafafa",padding:16,borderRadius:4,border:"1px dashed #d9d9d9"},children:G.length===0?e.jsx(V,{type:"dashed",icon:e.jsx(je,{}),onClick:de,children:"添加材料消耗"}):e.jsxs(e.Fragment,{children:[G.map(h=>{const t=L.find(i=>i.id===h.material_id);return e.jsxs("div",{style:{display:"flex",gap:8,marginBottom:8,alignItems:"flex-start"},children:[e.jsx(A.Item,{style:{flex:3,marginBottom:0},children:e.jsx(Y,{placeholder:C?"加载材料中...":L.length===0?"暂无可用材料":"选择材料",value:h.material_id,onChange:i=>x(h.key,"material_id",i),loading:C,showSearch:!0,optionFilterProp:"label",notFoundContent:C?e.jsx($e,{size:"small"}):"暂无可用材料",options:L.map(i=>({label:`${i.name} (${i.material_code}) - 库存: ${i.quantity} ${i.unit}`,value:i.id}))})}),e.jsx(A.Item,{style:{flex:1,marginBottom:0},children:e.jsx(me,{placeholder:"数量",min:1,max:t?.quantity,value:h.quantity_consumed,onChange:i=>x(h.key,"quantity_consumed",i),style:{width:"100%"}})}),e.jsx(A.Item,{style:{flex:1,marginBottom:0},children:e.jsx(me,{placeholder:"单价(可选)",min:0,precision:2,value:h.unit_price,onChange:i=>x(h.key,"unit_price",i),style:{width:"100%"}})}),e.jsx(A.Item,{style:{flex:2,marginBottom:0},children:e.jsx(le,{placeholder:"备注(可选)",value:h.notes,onChange:i=>x(h.key,"notes",i.target.value)})}),e.jsx(V,{type:"text",icon:e.jsx(nt,{}),danger:!0,onClick:()=>ge(h.key)})]},h.key)}),e.jsx(V,{type:"dashed",icon:e.jsx(je,{}),onClick:de,style:{marginTop:8},children:"添加更多"})]})})]})]}),s&&e.jsx(In,{workOrderId:n,taskId:s.id,taskNumber:s.task_number})]})}const zn={beginner:"default",intermediate:"blue",advanced:"success",expert:"warning"},Ve={beginner:"初级",intermediate:"中级",advanced:"高级",expert:"专家"};function Pn({visible:a,workOrderId:n,task:s,onSuccess:l,onCancel:u}){const{message:T}=he.useApp(),[k,j]=r.useState(!1),[y,$]=r.useState(!1),[R,b]=r.useState(null),P=r.useCallback(async()=>{if(s){j(!0);try{const m=await ee.getEligibleTechnicians(n,s.id);b(m)}catch{T.error("获取合格技术员列表失败")}finally{j(!1)}}},[n,s,T]);r.useEffect(()=>{a&&s&&P()},[a,s,P]);const f=async m=>{if(s){$(!0);try{await ee.assignTask(n,s.id,{technician_id:m,equipment_id:s.required_equipment_id}),T.success("任务分配成功"),l()}catch{T.error("任务分配失败")}finally{$(!1)}}},E=[{title:"技术员",dataIndex:"name",key:"name",render:(m,_)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(Tt,{style:{color:"#999"}}),e.jsxs("span",{children:[m,e.jsxs("span",{style:{color:"#999",marginLeft:8},children:["(",_.employee_id,")"]})]})]})},{title:"职位",dataIndex:"job_title",key:"job_title",render:m=>m||"-"},{title:"匹配度",dataIndex:"match_score",key:"match_score",sorter:(m,_)=>m.match_score-_.match_score,render:m=>e.jsx(it,{percent:Math.round(m),size:"small",status:m>=80?"success":m>=50?"active":"exception",style:{width:96}})},{title:"当前任务数",dataIndex:"current_workload",key:"current_workload",sorter:(m,_)=>m.current_workload-_.current_workload,render:m=>e.jsx(ae,{color:m>=5?"error":m>=3?"warning":"success",children:m})},{title:"技能详情",key:"skill_details",width:280,render:(m,_)=>e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:4},children:_.skill_details.map(o=>e.jsx(_e,{title:`等级: ${Ve[o.proficiency_level]||o.proficiency_level}
认证: ${o.is_certified?"已认证":"未认证"}`,children:e.jsx(ae,{color:o.meets_requirement?zn[o.proficiency_level]:"default",children:e.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[o.meets_requirement?e.jsx(Ht,{style:{fontSize:12}}):e.jsx(Wt,{style:{fontSize:12}}),o.skill_name]})})},o.skill_id))})},{title:"操作",key:"action",fixed:"right",width:100,render:(m,_)=>e.jsx(V,{type:"primary",size:"small",onClick:()=>f(_.personnel_id),loading:y,disabled:_.status!=="available",children:"分配"})}],S=m=>!m||m.length===0?e.jsx(ae,{children:"无技能要求"}):e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:4},children:m.map(_=>e.jsx(_e,{title:`最低等级: ${_.min_proficiency?Ve[_.min_proficiency]:"无要求"}
需要认证: ${_.certification_required?"是":"否"}`,children:e.jsxs(ae,{color:"blue",children:[_.skill_name,_.certification_required&&" *"]})},_.skill_id))});return e.jsx(Ie,{title:`分配技术员 - ${s?.title||""}`,open:a,onCancel:u,footer:null,width:900,children:k?e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:"48px 0"},children:e.jsx($e,{size:"large"})}):e.jsxs(e.Fragment,{children:[R&&e.jsxs("div",{style:{marginBottom:16},children:[e.jsxs("div",{style:{marginBottom:8},children:[e.jsx("strong",{style:{fontSize:14},children:"所需设备: "}),R.required_equipment_name?e.jsx(ae,{color:"processing",children:R.required_equipment_name}):e.jsx("span",{style:{color:"#999"},children:"无"})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("strong",{style:{fontSize:14},children:"技能要求: "}),S(R.required_skills)]})]}),R?.eligible_technicians.length===0?e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"48px 0",color:"#999"},children:[e.jsx("svg",{style:{width:48,height:48,marginBottom:8},fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1,d:"M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"})}),e.jsx("span",{children:R?.required_equipment_id?"暂无符合条件的技术员":"该任务未设置所需设备，无法进行技能匹配"})]}):e.jsx(ke,{columns:E,dataSource:R?.eligible_technicians||[],rowKey:"personnel_id",size:"small",scroll:{x:850}})]})})}const{TextArea:Me}=le,Rn=[{label:"普通",value:"normal"},{label:"紧急",value:"urgent"},{label:"关键",value:"critical"}];function An({visible:a,task:n,onSuccess:s,onCancel:l}){const[u]=A.useForm(),[T,k]=r.useState(!1),[j,y]=r.useState([]),{message:$}=he.useApp();r.useEffect(()=>{a&&(u.resetFields(),u.setFieldValue("priority","normal"),at.getPersonnel({status:"available",page_size:100}).then(b=>{y(b.items)}))},[a,u]);const R=async()=>{if(n)try{const b=await u.validateFields();k(!0),await Vt.createHandover({task_id:n.id,to_technician_id:b.to_technician_id||void 0,priority:b.priority,progress_summary:b.progress_summary||void 0,pending_items:b.pending_items||void 0,special_instructions:b.special_instructions||void 0}),$.success("交接创建成功"),s()}catch(b){if(b&&typeof b=="object"&&"errorFields"in b)return;$.error("创建交接失败")}finally{k(!1)}};return e.jsx(Ie,{title:`创建任务交接 - ${n?.title||""}`,open:a,onOk:R,onCancel:l,confirmLoading:T,width:600,okText:"创建交接",cancelText:"取消",destroyOnHidden:!0,children:e.jsxs(A,{form:u,layout:"vertical",children:[e.jsx(A.Item,{name:"to_technician_id",label:"接收技术员",children:e.jsx(Y,{placeholder:"选择接收技术员（可留空由他人认领）",allowClear:!0,showSearch:!0,optionFilterProp:"label",options:j.map(b=>({label:`${b.user?.full_name||b.employee_id} (${b.employee_id})`,value:b.id}))})}),e.jsx(A.Item,{name:"priority",label:"优先级",rules:[{required:!0,message:"请选择优先级"}],children:e.jsx(Y,{placeholder:"选择优先级",options:Rn})}),e.jsx(A.Item,{name:"progress_summary",label:"已完成工作",children:e.jsx(Me,{rows:3,placeholder:"描述已经完成的工作内容..."})}),e.jsx(A.Item,{name:"pending_items",label:"待完成事项",children:e.jsx(Me,{rows:3,placeholder:"描述还需要完成的工作..."})}),e.jsx(A.Item,{name:"special_instructions",label:"特别说明",children:e.jsx(Me,{rows:2,placeholder:"任何重要的注意事项或说明..."})})]})})}const Nn={pending:{label:"待处理",color:"default"},assigned:{label:"已分配",color:"blue"},in_progress:{label:"进行中",color:"processing"},completed:{label:"已完成",color:"success"},blocked:{label:"阻塞",color:"error"},cancelled:{label:"已取消",color:"default"}};function Bn({workOrder:a,onTasksChange:n}){const{message:s}=he.useApp(),[l,u]=r.useState([]),[T,k]=r.useState([]),[j,y]=r.useState([]),[$,R]=r.useState(!1),[b,P]=r.useState(!1),[f,E]=r.useState(!1),[S,m]=r.useState(!1),[_,o]=r.useState(null),w=r.useRef(!1),v=r.useRef(!0),q=r.useCallback(async()=>{R(!0);try{const C=await ee.getTasks(a.id);v.current&&(u(C),w.current=!1)}catch{v.current&&!w.current&&(w.current=!0,s.error("获取任务列表失败"))}finally{v.current&&R(!1)}},[a.id,s]),B=r.useCallback(async()=>{try{const[C,I]=await Promise.all([at.getPersonnel({page:1,page_size:100}),ve.getEquipment({page:1,page_size:100})]);v.current&&(k(C.items),y(I.items))}catch{console.error("Failed to fetch reference data")}},[]);r.useEffect(()=>(v.current=!0,q(),B(),()=>{v.current=!1}),[q,B]);const N=C=>{if(!C.assigned_technician_id)return e.jsx("span",{style:{color:"#999"},children:"未分配"});if(C.assigned_technician){const{name:G,employee_id:te}=C.assigned_technician;return e.jsxs(ae,{color:"success",children:[G," (",te,")"]})}const I=T.find(G=>G.id===C.assigned_technician_id);if(I){const G=I.user?.full_name||I.user?.username||"";return e.jsxs(ae,{color:"success",children:[G," (",I.employee_id,")"]})}return e.jsxs(ae,{color:"success",children:["ID: ",C.assigned_technician_id]})},z=C=>{if(!C.required_equipment_id)return"-";if(C.required_equipment)return e.jsx(ae,{color:"processing",children:C.required_equipment.code});const I=j.find(G=>G.id===C.required_equipment_id);return I?e.jsx(ae,{color:"processing",children:I.code}):e.jsxs(ae,{color:"processing",children:["ID: ",C.required_equipment_id]})},c=()=>{o(null),P(!0)},d=C=>{o(C),P(!0)},p=async C=>{try{await ee.deleteTask(a.id,C),s.success("任务删除成功"),q(),n?.()}catch{s.error("任务删除失败")}},F=C=>{o(C),E(!0)},K=()=>{P(!1),o(null),q(),n?.()},H=()=>{E(!1),o(null),q(),n?.()},O=C=>{o(C),m(!0)},L=()=>{m(!1),o(null),q(),n?.()},W=[{title:"序号",dataIndex:"sequence",key:"sequence",width:60,sorter:(C,I)=>C.sequence-I.sequence},{title:"任务编号",dataIndex:"task_number",key:"task_number",width:120},{title:"任务名称",dataIndex:"title",key:"title"},{title:"状态",dataIndex:"status",key:"status",width:100,render:C=>{const I=Nn[C]||{label:C,color:"default"};return e.jsx(ae,{color:I.color,children:I.label})}},{title:"所需设备",dataIndex:"required_equipment_id",key:"required_equipment_id",width:120,render:(C,I)=>z(I)},{title:"所需容量",dataIndex:"required_capacity",key:"required_capacity",width:100,render:C=>C?`${C} 槽位`:"-"},{title:"分配技术员",dataIndex:"assigned_technician_id",key:"assigned_technician_id",width:150,render:(C,I)=>N(I)},{title:"周期(小时)",key:"cycle_hours",width:100,render:(C,I)=>e.jsx("span",{children:I.actual_cycle_hours!==void 0&&I.actual_cycle_hours!==null?I.actual_cycle_hours:I.standard_cycle_hours||"-"})},{title:"操作",key:"action",width:180,fixed:"right",render:(C,I)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:4},children:[e.jsx(_e,{title:"编辑",children:e.jsx(V,{type:"text",size:"small",icon:e.jsx(st,{}),onClick:()=>d(I)})}),e.jsx(_e,{title:"分配技术员",children:e.jsx(V,{type:"text",size:"small",icon:e.jsx(bn,{}),onClick:()=>F(I),disabled:I.status==="completed"||I.status==="cancelled"})}),e.jsx(_e,{title:"交接任务",children:e.jsx(V,{type:"text",size:"small",icon:e.jsx(Et,{}),onClick:()=>O(I),disabled:!I.assigned_technician_id||I.status==="completed"||I.status==="cancelled"})}),e.jsx(rt,{title:"确定删除此任务吗？",onConfirm:()=>p(I.id),okText:"确定",cancelText:"取消",children:e.jsx(_e,{title:"删除",children:e.jsx(V,{type:"text",size:"small",icon:e.jsx(lt,{style:{color:"#ef4444"}}),disabled:I.status!=="pending"})})})]})}];return e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{background:"#fff",borderRadius:8,border:"1px solid #e5e5e5",boxShadow:"0 1px 2px rgba(0,0,0,0.05)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px 16px",borderBottom:"1px solid #e5e5e5",background:"#fafafa"},children:[e.jsx("span",{style:{fontWeight:500,color:"#111"},children:"任务列表"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(V,{size:"small",icon:e.jsx(Kt,{}),onClick:q,children:"刷新"}),e.jsx(V,{type:"primary",size:"small",icon:e.jsx(je,{}),onClick:c,children:"新增任务"})]})]}),e.jsx("div",{style:{padding:16},children:e.jsx(ke,{columns:W,dataSource:l,rowKey:"id",loading:$,size:"small",scroll:{x:900}})})]}),e.jsx(En,{visible:b,workOrderId:a.id,task:_,laboratoryId:a.laboratory_id,siteId:a.site_id,workOrderType:a.work_order_type,onSuccess:K,onCancel:()=>{P(!1),o(null)}}),e.jsx(Pn,{visible:f,workOrderId:a.id,task:_,onSuccess:H,onCancel:()=>{E(!1),o(null)}}),e.jsx(An,{visible:S,task:_,onSuccess:L,onCancel:()=>{m(!1),o(null)}})]})}const Ke={failure_analysis:"失效分析",reliability_test:"可靠性测试"},Ge={draft:{text:"草稿",color:"default"},pending:{text:"待处理",color:"orange"},assigned:{text:"已分配",color:"blue"},in_progress:{text:"进行中",color:"blue"},on_hold:{text:"暂停",color:"warning"},review:{text:"待审核",color:"purple"},completed:{text:"已完成",color:"success"},cancelled:{text:"已取消",color:"default"}};function pa(){const[a,n]=zt(),[s,l]=r.useState([]),[u,T]=r.useState([]),[k,j]=r.useState([]),[y,$]=r.useState([]),[R,b]=r.useState(!1),[P,f]=r.useState(!1),[E,S]=r.useState(null),[m,_]=r.useState({current:1,pageSize:10,total:0}),[o,w]=r.useState({search:"",overdue_only:!1}),[v,q]=r.useState(""),[B,N]=r.useState([]),{message:z}=he.useApp(),c=r.useRef(null),d=r.useRef(!1);r.useEffect(()=>{const t=a.get("expand");if(t&&!d.current){const i=parseInt(t,10);isNaN(i)||(d.current=!0,w(g=>({...g,work_order_id:i})),N([i]),a.delete("expand"),n(a,{replace:!0}))}},[a,n]);const p=r.useCallback(async(t=1,i=10,g)=>{b(!0);try{const M=await ee.getWorkOrders({page:t,page_size:i,search:o.search||void 0,work_order_id:o.work_order_id,laboratory_id:o.laboratory_id,client_id:o.client_id,work_order_type:o.work_order_type,status:o.status,priority_level:o.priority_level,overdue_only:o.overdue_only,sort_by:o.sort_by,sort_order:o.sort_order,signal:g});l(M.items),_({current:M.page,pageSize:M.page_size,total:M.total})}catch(M){ye(M)||z.error("获取工单列表失败")}finally{b(!1)}},[o,z]),F=r.useCallback(async()=>{try{const t=await At.getAllSites();T(t)}catch(t){ye(t)||console.error("Failed to fetch sites")}},[]),K=r.useCallback(async()=>{try{const t=await Rt.getLaboratories({page:1,page_size:100});j(t.items)}catch(t){ye(t)||console.error("Failed to fetch laboratories")}},[]),H=r.useCallback(async()=>{try{const t=await Ee.getAllClients();$(t)}catch(t){ye(t)||console.error("Failed to fetch clients")}},[]);r.useEffect(()=>{F(),K(),H()},[F,K,H]),r.useEffect(()=>{c.current&&c.current.abort();const t=new AbortController;return c.current=t,p(1,m.pageSize,t.signal),()=>{t.abort()}},[p,m.pageSize]),r.useEffect(()=>{const t=setTimeout(()=>{v!==o.search&&w(i=>({...i,search:v}))},300);return()=>clearTimeout(t)},[v,o.search]);const O=(t,i,g)=>{o.work_order_id&&w(ie=>({...ie,work_order_id:void 0}));const M=Array.isArray(g)?g[0]:g;let D,xe;if(M?.field&&M?.order){const ie=M.field;ie==="priority_score"||ie==="priority"?D="priority_score":ie==="sla_deadline"&&(D="sla_deadline"),xe=M.order==="ascend"?"asc":"desc"}w(ie=>({...ie,sort_by:D,sort_order:xe})),p(t.current,t.pageSize)},L=t=>{w(i=>({...i,laboratory_id:t}))},W=t=>{w(i=>({...i,client_id:t}))},C=t=>{w(i=>({...i,work_order_type:t}))},I=t=>{w(i=>({...i,status:t}))},G=t=>{w(i=>({...i,overdue_only:t}))},te=()=>{S(null),f(!0)},se=t=>{S(t),f(!0)},fe=async t=>{try{await ee.deleteWorkOrder(t),z.success("删除成功"),p(m.current,m.pageSize)}catch(i){ye(i)||z.error("删除失败,只能删除草稿或已取消的工单")}},oe=()=>{f(!1),S(null),p(m.current,m.pageSize)},de=()=>{f(!1),S(null)},ge=async()=>{try{z.info("正在生成PDF报告..."),await Fe.exportWorkOrdersPdf({laboratory_id:o.laboratory_id,work_order_type:o.work_order_type,status:o.status,client_id:o.client_id}),z.success("PDF报告已下载")}catch(t){ye(t)||z.error("导出PDF失败")}},x=async t=>{try{z.info("正在生成PDF报告..."),await Fe.exportWorkOrderDetailPdf(t),z.success("PDF报告已下载")}catch(i){ye(i)||z.error("导出PDF失败")}},U=t=>{const i=k.find(g=>g.id===t);return i?i.name:"-"},X=t=>{if(!t)return"-";const i=y.find(g=>g.id===t);return i?i.name:"-"},h=[{title:"工单号",dataIndex:"order_number",key:"order_number",width:160},{title:"标题",dataIndex:"title",key:"title",width:200},{title:"类型",dataIndex:"work_order_type",key:"work_order_type",width:100,render:t=>Ke[t]||t},{title:"实验室",dataIndex:"laboratory_id",key:"laboratory_id",width:80,render:t=>U(t)},{title:"客户",dataIndex:"client_id",key:"client_id",width:100,render:t=>X(t)},{title:"优先级",key:"priority",dataIndex:"priority_score",width:100,sorter:!0,render:(t,i)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(it,{percent:i.priority_score,size:"small",status:i.priority_score>70?"exception":i.priority_score>50?"active":"success",style:{width:60}}),e.jsxs("span",{style:{fontSize:12,color:"#666"},children:["P",i.priority_level]})]})},{title:"状态",dataIndex:"status",key:"status",width:90,render:t=>{const i=t,g=Ge[i]||{text:i,color:"default"};return e.jsx(ae,{color:g.color,children:g.text})}},{title:"截止日",dataIndex:"sla_deadline",key:"sla_deadline",width:110,sorter:!0,render:t=>t?new Date(t).toLocaleDateString("zh-CN"):"-"},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:110,render:t=>new Date(t).toLocaleDateString("zh-CN")},{title:"操作",key:"action",width:180,render:(t,i)=>e.jsxs(Se,{size:4,children:[e.jsx(V,{type:"link",size:"small",icon:e.jsx(st,{}),onClick:()=>se(i),children:"编辑"}),e.jsx(V,{type:"link",size:"small",icon:e.jsx(Le,{}),onClick:()=>x(i.id),children:"PDF"}),(i.status==="draft"||i.status==="cancelled")&&e.jsx(rt,{title:"确认删除",description:`确定要删除工单 "${i.order_number}" 吗？`,onConfirm:()=>fe(i.id),okText:"确定",cancelText:"取消",okButtonProps:{danger:!0},children:e.jsx(V,{type:"link",size:"small",danger:!0,icon:e.jsx(lt,{}),children:"删除"})})]})}];return e.jsxs("div",{"data-testid":"work-orders-page",children:[e.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between"},children:[e.jsxs(Se,{wrap:!0,children:[e.jsx(le,{placeholder:"搜索工单号或标题",prefix:e.jsx(Pt,{}),value:v,onChange:t=>q(t.target.value),style:{width:200},allowClear:!0,"data-testid":"work-orders-search-input"}),e.jsx(Y,{placeholder:"实验室",value:o.laboratory_id,onChange:L,style:{width:160},allowClear:!0,options:k.map(t=>({label:`${t.name} (${t.code})`,value:t.id})),"data-testid":"work-orders-lab-filter"}),e.jsx(Y,{placeholder:"客户",value:o.client_id,onChange:W,style:{width:140},allowClear:!0,options:y.map(t=>({label:t.name,value:t.id})),"data-testid":"work-orders-client-filter"}),e.jsx(Y,{placeholder:"类型",value:o.work_order_type,onChange:C,style:{width:110},allowClear:!0,options:Object.entries(Ke).map(([t,i])=>({label:i,value:t})),"data-testid":"work-orders-type-filter"}),e.jsx(Y,{placeholder:"状态",value:o.status,onChange:I,style:{width:100},allowClear:!0,options:Object.entries(Ge).map(([t,i])=>({label:i.text,value:t})),"data-testid":"work-orders-status-filter"}),e.jsx(Y,{placeholder:"优先级",value:o.priority_level,onChange:t=>w(i=>({...i,priority_level:t||void 0})),style:{width:100},allowClear:!0,options:[{value:1,label:"P1"},{value:2,label:"P2"},{value:3,label:"P3"},{value:4,label:"P4"},{value:5,label:"P5"}],"data-testid":"work-orders-priority-filter"}),e.jsxs(Se,{children:[e.jsx("span",{style:{fontSize:14,color:"#666"},children:"仅逾期:"}),e.jsx(Gt,{checked:o.overdue_only,onChange:G,size:"small","data-testid":"work-orders-overdue-switch"})]})]}),e.jsxs(Se,{children:[e.jsx(V,{icon:e.jsx(Le,{}),onClick:ge,"data-testid":"work-orders-export-button",children:"导出PDF"}),e.jsx(V,{type:"primary",icon:e.jsx(je,{}),onClick:te,"data-testid":"work-orders-add-button",children:"新增工单"})]})]}),e.jsx(ke,{columns:h,dataSource:s,rowKey:"id",loading:R,pagination:{...m,showSizeChanger:!0,showQuickJumper:!0,showTotal:t=>`共 ${t} 条`},onChange:O,scroll:{x:1300},expandable:{expandedRowKeys:B,onExpandedRowsChange:t=>N([...t]),expandedRowRender:t=>e.jsx("div",{style:{padding:8,backgroundColor:"#fafafa"},children:e.jsx(Bn,{workOrder:t,onTasksChange:()=>p(m.current,m.pageSize)})}),expandIcon:({expanded:t,onExpand:i,record:g})=>e.jsx(V,{type:"text",size:"small",onClick:M=>i(g,M),icon:t?e.jsx(Lt,{}):e.jsx(Te,{}),style:{color:"#666"}})},"data-testid":"work-orders-table"}),e.jsx(Cn,{visible:P,workOrder:E,sites:u,laboratories:k,clients:y,onSuccess:oe,onCancel:de})]})}export{pa as default};
