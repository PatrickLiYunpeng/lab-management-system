import{M as x,r as o,a7 as Q,O as A,P as t,X as K,a8 as W,a9 as X,Q as L,N as R,a0 as _,Y as G,$ as U,A as Z,bb as ee}from"./index-DVAH8G0d.js";import{l as te}from"./laboratoryService-B77Lyyfa.js";import{S,F as ae}from"./Table-BH_IQYSB.js";import{D as M}from"./index-Bd8ohf4A.js";import{R as se}from"./ReloadOutlined-Ci7PDsnU.js";import{M as re}from"./index-D5-92eMw.js";import"./CheckOutlined-CP9fMx1j.js";import"./ClockCircleOutlined-C4lKWGcp.js";const v={async getAuditLogs(l={}){const{signal:c,...d}=l;return(await x.get("/audit-logs",{params:d,signal:c})).data},async getAuditLogById(l){return(await x.get(`/audit-logs/${l}`)).data},async getEntityAuditLogs(l,c,d){const y=d?{limit:d}:{};return(await x.get(`/audit-logs/entity/${l}/${c}`,{params:y})).data},async getAuditActions(){return(await x.get("/audit-logs/actions")).data},async getEntityTypes(){return(await x.get("/audit-logs/entity-types")).data}},b={create:{text:"创建",color:"success"},update:{text:"更新",color:"processing"},delete:{text:"删除",color:"error"},login:{text:"登录",color:"processing"},logout:{text:"登出",color:"default"},view:{text:"查看",color:"default"},export:{text:"导出",color:"processing"},approve:{text:"批准",color:"success"},reject:{text:"拒绝",color:"warning"},assign:{text:"分配",color:"processing"},complete:{text:"完成",color:"success"},cancel:{text:"取消",color:"default"}},C={work_order:"工单",user:"用户",personnel:"人员",equipment:"设备",material:"材料",laboratory:"实验室",site:"站点",skill:"技能",method:"方法",handover:"交接",client:"客户"};function ye(){const[l,c]=o.useState([]),[d,y]=o.useState(!1),[j,T]=o.useState([]),[E,$]=o.useState([]),[F,P]=o.useState([]),[r,H]=o.useState(null),[V,D]=o.useState(!1),[h,B]=o.useState({current:1,pageSize:20,total:0}),[s,k]=o.useState({search:""}),[f,N]=o.useState(""),u=o.useRef(null),{message:I}=Q.useApp(),w=o.useCallback(async(e=1,a=20,p)=>{y(!0);try{const i={page:e,page_size:a,signal:p};s.search&&(i.search=s.search),s.action&&(i.action=s.action),s.entity_type&&(i.entity_type=s.entity_type),s.laboratory_id&&(i.laboratory_id=s.laboratory_id),s.startDate&&(i.start_date=s.startDate.format("YYYY-MM-DD")),s.endDate&&(i.end_date=s.endDate.format("YYYY-MM-DD"));const m=await v.getAuditLogs(i);c(m.items),B({current:m.page,pageSize:m.page_size,total:m.total})}catch(i){A(i)||I.error("获取审计日志失败")}finally{y(!1)}},[s,I]),z=o.useCallback(async()=>{try{const[e,a,p]=await Promise.all([te.getLaboratories({page_size:100}),v.getAuditActions(),v.getEntityTypes()]);T(e.items),$(a),P(p)}catch(e){A(e)||console.error("Failed to fetch reference data")}},[]);o.useEffect(()=>{z()},[z]),o.useEffect(()=>{u.current&&u.current.abort();const e=new AbortController;return u.current=e,w(h.current,h.pageSize,e.signal),()=>{e.abort()}},[s]),o.useEffect(()=>{const e=setTimeout(()=>{f!==s.search&&k(a=>({...a,search:f}))},300);return()=>clearTimeout(e)},[f,s.search]);const q=e=>{u.current&&u.current.abort();const a=new AbortController;u.current=a,w(e.current||1,e.pageSize||20,a.signal)},J=e=>{H(e),D(!0)},g=(e,a)=>{k(p=>({...p,[e]:a||void 0}))},Y=e=>{if(!e)return"-";const a=j.find(p=>p.id===e);return a?a.name:"-"},O=[{title:"时间",dataIndex:"created_at",key:"created_at",width:160,render:e=>R(e).format("YYYY-MM-DD HH:mm:ss")},{title:"用户",dataIndex:"username",key:"username",width:120,render:(e,a)=>t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[t.jsx(G,{style:{color:"#999"}}),t.jsx("span",{children:e||"-"}),a.user_role&&t.jsx(_,{style:{fontSize:11},children:a.user_role})]})},{title:"操作",dataIndex:"action",key:"action",width:80,render:e=>{const a=b[e]||{text:e,color:"default"};return t.jsx(_,{color:a.color,children:a.text})}},{title:"实体类型",dataIndex:"entity_type",key:"entity_type",width:100,render:e=>t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[t.jsx(U,{style:{color:"#999"}}),t.jsx("span",{children:C[e]||e})]})},{title:"实体名称",dataIndex:"entity_name",key:"entity_name",width:180,render:(e,a)=>t.jsx(Z,{title:`ID: ${a.entity_id||"-"}`,children:t.jsx("span",{style:{cursor:"help"},children:e||"-"})})},{title:"描述",dataIndex:"description",key:"description",render:e=>e||"-"},{title:"实验室",dataIndex:"laboratory_id",key:"laboratory_id",width:140,render:e=>Y(e)},{title:"操作",key:"actions",width:80,render:(e,a)=>t.jsx(L,{type:"link",size:"small",icon:t.jsx(ee,{}),onClick:()=>J(a),children:"详情"})}];return t.jsxs("div",{children:[t.jsxs(K,{title:"审计日志",extra:t.jsx(L,{icon:t.jsx(se,{}),onClick:()=>w(),children:"刷新"}),children:[t.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:12,marginBottom:16},children:[t.jsx(W,{placeholder:"搜索用户名、实体名称或描述",prefix:t.jsx(X,{style:{color:"#999"}}),value:f,onChange:e=>N(e.target.value),style:{width:256},allowClear:!0}),t.jsx(S,{placeholder:"操作类型",value:s.action,onChange:e=>g("action",e),style:{width:128},allowClear:!0,options:E.map(e=>({label:b[e]?.text||e,value:e}))}),t.jsx(S,{placeholder:"实体类型",value:s.entity_type,onChange:e=>g("entity_type",e),style:{width:128},allowClear:!0,options:F.map(e=>({label:C[e]||e,value:e}))}),t.jsx(S,{placeholder:"实验室",value:s.laboratory_id,onChange:e=>g("laboratory_id",e),style:{width:176},allowClear:!0,options:j.map(e=>({label:e.name,value:e.id}))}),t.jsx(M,{placeholder:"开始日期",value:s.startDate,onChange:e=>g("startDate",e),style:{width:144}}),t.jsx(M,{placeholder:"结束日期",value:s.endDate,onChange:e=>g("endDate",e),style:{width:144}})]}),t.jsx(ae,{columns:O,dataSource:l,rowKey:"id",loading:d,pagination:{current:h.current,pageSize:h.pageSize,total:h.total,showSizeChanger:!0,showQuickJumper:!0,showTotal:e=>`共 ${e} 条记录`},onChange:q,scroll:{x:1200},size:"small"})]}),t.jsx(re,{title:"审计日志详情",open:V,onCancel:()=>D(!1),footer:null,width:700,children:r&&t.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:1,backgroundColor:"#e5e5e5",border:"1px solid #e5e5e5",borderRadius:6,overflow:"hidden"},children:[t.jsx(n,{label:"ID",children:r.id}),t.jsx(n,{label:"时间",children:R(r.created_at).format("YYYY-MM-DD HH:mm:ss")}),t.jsx(n,{label:"用户",children:r.username||"-"}),t.jsx(n,{label:"角色",children:r.user_role||"-"}),t.jsx(n,{label:"操作",children:t.jsx(_,{color:b[r.action]?.color||"default",children:b[r.action]?.text||r.action})}),t.jsx(n,{label:"实体类型",children:C[r.entity_type]||r.entity_type}),t.jsx(n,{label:"实体ID",children:r.entity_id||"-"}),t.jsx(n,{label:"实体名称",children:r.entity_name||"-"}),t.jsx(n,{label:"实验室",span:2,children:Y(r.laboratory_id)}),t.jsx(n,{label:"描述",span:2,children:r.description||"-"}),t.jsx(n,{label:"IP地址",children:r.ip_address||"-"}),t.jsx(n,{label:"请求路径",children:r.request_path||"-"}),r.old_values&&t.jsx(n,{label:"旧值",span:2,children:t.jsx("pre",{style:{fontSize:12,fontFamily:"monospace",whiteSpace:"pre-wrap",backgroundColor:"#f5f5f5",padding:8,borderRadius:4,maxHeight:160,overflow:"auto"},children:JSON.stringify(r.old_values,null,2)})}),r.new_values&&t.jsx(n,{label:"新值",span:2,children:t.jsx("pre",{style:{fontSize:12,fontFamily:"monospace",whiteSpace:"pre-wrap",backgroundColor:"#f5f5f5",padding:8,borderRadius:4,maxHeight:160,overflow:"auto"},children:JSON.stringify(r.new_values,null,2)})})]})})]})}function n({label:l,children:c,span:d=1}){return t.jsxs("div",{style:{backgroundColor:"#fff",padding:12,gridColumn:d===2?"span 2":void 0},children:[t.jsx("div",{style:{fontSize:12,color:"#999",marginBottom:4},children:l}),t.jsx("div",{style:{fontSize:14,color:"#333"},children:c})]})}export{ye as default};
