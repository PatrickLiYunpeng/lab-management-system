import{a6 as l,r as i,a7 as H,P as e,V as K,W as C,a8 as I,S as O,Q as F,aa as J,a0 as $,O as W,a9 as U,A as ne,a4 as X,ae as re,a3 as le}from"./index-DVAH8G0d.js";import{p as m,R as oe}from"./productService-BBlA6YPD.js";import{c as Y,R as ce}from"./clientService-Cmh9Rzea.js";import{M as Z}from"./index-D5-92eMw.js";import{S as D,F as ee}from"./Table-BH_IQYSB.js";import{S as q}from"./index-C-m9zxKZ.js";import{R as te}from"./EditOutlined-BO1KRQYy.js";import{P as ae}from"./index-BDasguwL.js";import{R as se}from"./DeleteOutlined-DADLfnzs.js";import{T as de}from"./index-fw1Ls6Om.js";import"./CheckOutlined-CP9fMx1j.js";function ue({visible:c,product:r,onSuccess:z,onCancel:R}){const[b]=l.useForm(),[S,B]=i.useState(!1),[g,p]=i.useState(null),[A,f]=i.useState([]),[T,y]=i.useState(!1),{message:w}=H.useApp(),j=i.useCallback(async()=>{y(!0);try{const[s,d]=await Promise.all([m.getProductConfig(),Y.getAllClients()]);p(s),f(d)}catch{w.error("加载配置失败")}finally{y(!1)}},[w]);i.useEffect(()=>{c&&(j(),r?b.setFieldsValue({name:r.name,code:r.code,client_id:r.client_id,package_form_id:r.package_form_id,package_type_id:r.package_type_id,scenario_ids:r.scenarios?.map(s=>s.id)||[],custom_info:r.custom_info||[],is_active:r.is_active}):(b.resetFields(),b.setFieldsValue({is_active:!0,custom_info:[],scenario_ids:[]})))},[c,r,b,j]);const E=async()=>{try{const s=await b.validateFields();B(!0);const d=(s.custom_info||[]).filter(o=>o&&o.trim()!=="");if(r){const o={name:s.name,code:s.code||void 0,client_id:s.client_id,package_form_id:s.package_form_id,package_type_id:s.package_type_id,scenario_ids:s.scenario_ids||[],custom_info:d.length>0?d:void 0,is_active:s.is_active};await m.updateProduct(r.id,o),w.success("产品更新成功")}else{const o={name:s.name,code:s.code||void 0,client_id:s.client_id,package_form_id:s.package_form_id,package_type_id:s.package_type_id,scenario_ids:s.scenario_ids||[],custom_info:d.length>0?d:void 0};await m.createProduct(o),w.success("产品创建成功")}z()}catch{w.error(r?"更新失败":"创建失败")}finally{B(!1)}},k=s=>{const{label:d,value:o,closable:h,onClose:x}=s,V=g?.application_scenarios.find(M=>M.id===o)?.color||"blue";return e.jsx($,{color:V,closable:h,onClose:x,style:{marginRight:3},children:d})};return e.jsx(Z,{title:r?"编辑产品":"新增产品",open:c,onOk:E,onCancel:R,confirmLoading:S,width:700,okText:"确定",cancelText:"取消",destroyOnHidden:!0,children:e.jsxs(l,{form:b,layout:"vertical",children:[e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"基本信息"})}),e.jsxs(K,{gutter:16,children:[e.jsx(C,{span:12,children:e.jsx(l.Item,{name:"name",label:"产品名称",rules:[{required:!0,message:"请输入产品名称"}],children:e.jsx(I,{placeholder:"请输入产品名称"})})}),e.jsx(C,{span:12,children:e.jsx(l.Item,{name:"code",label:"产品编码",children:e.jsx(I,{placeholder:"请输入产品编码（可选）"})})})]}),e.jsx(K,{gutter:16,children:e.jsx(C,{span:24,children:e.jsx(l.Item,{name:"client_id",label:"所属客户",rules:[{required:!0,message:"请选择客户"}],children:e.jsx(D,{placeholder:"请选择客户",loading:T,showSearch:!0,optionFilterProp:"label",options:A.map(s=>({label:`${s.name} (${s.code})`,value:s.id}))})})})}),e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16,marginTop:24},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"封装配置"})}),e.jsxs(K,{gutter:16,children:[e.jsx(C,{span:12,children:e.jsx(l.Item,{name:"package_form_id",label:"封装形式",children:e.jsx(D,{placeholder:"请选择封装形式",loading:T,allowClear:!0,options:g?.package_forms.map(s=>({label:s.name,value:s.id}))||[]})})}),e.jsx(C,{span:12,children:e.jsx(l.Item,{name:"package_type_id",label:"封装产品类型",children:e.jsx(D,{placeholder:"请选择封装产品类型",loading:T,allowClear:!0,options:g?.package_types.map(s=>({label:s.name,value:s.id}))||[]})})})]}),e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16,marginTop:24},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"应用场景"})}),e.jsx(l.Item,{name:"scenario_ids",label:"产品应用场景",children:e.jsx(D,{mode:"multiple",placeholder:"请选择应用场景（可多选）",loading:T,tagRender:k,options:g?.application_scenarios.map(s=>({label:s.name,value:s.id}))||[]})}),e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16,marginTop:24},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"自定义产品信息（最多5条，每条不超过200字）"})}),e.jsx(l.List,{name:"custom_info",children:(s,{add:d,remove:o})=>e.jsxs(e.Fragment,{children:[s.map(({key:h,name:x,...v})=>e.jsxs(O,{style:{display:"flex",marginBottom:8},align:"baseline",children:[e.jsx(l.Item,{...v,name:x,rules:[{max:200,message:"不能超过200字"}],style:{marginBottom:0,width:550},children:e.jsx(I,{placeholder:`自定义信息 ${x+1}`,maxLength:200,showCount:!0})}),e.jsx(oe,{onClick:()=>o(x),style:{color:"#ff4d4f"}})]},h)),s.length<5&&e.jsx(l.Item,{children:e.jsx(F,{type:"dashed",onClick:()=>d(),block:!0,icon:e.jsx(J,{}),children:"添加自定义信息"})})]})}),r&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{borderBottom:"1px solid #e5e5e5",paddingBottom:8,marginBottom:16,marginTop:24},children:e.jsx("span",{style:{fontSize:14,color:"#999"},children:"状态"})}),e.jsx(l.Item,{name:"is_active",label:"状态",valuePropName:"checked",children:e.jsx(q,{checkedChildren:"启用",unCheckedChildren:"停用"})})]})]})})}function pe(){const[c,r]=i.useState([]),[z,R]=i.useState(!1),[b,S]=i.useState(!1),[B,g]=i.useState(null),[p,A]=i.useState({current:1,pageSize:10,total:0}),[f,T]=i.useState(""),[y,w]=i.useState(""),[j,E]=i.useState(void 0),[k,s]=i.useState(void 0),[d,o]=i.useState([]),{message:h}=H.useApp(),x=i.useRef(null);i.useEffect(()=>{(async()=>{try{const n=await Y.getAllClients();o(n)}catch{}})()},[]);const v=i.useCallback(async(a=1,n=10,P)=>{R(!0);try{const _=await m.getProducts({page:a,page_size:n,search:y||void 0,is_active:j,client_id:k,signal:P});r(_.items),A({current:_.page,pageSize:_.page_size,total:_.total})}catch(_){W(_)||h.error("获取产品列表失败")}finally{R(!1)}},[y,j,k,h]);i.useEffect(()=>{x.current&&x.current.abort();const a=new AbortController;return x.current=a,v(p.current,p.pageSize,a.signal),()=>{a.abort()}},[y,j,k]),i.useEffect(()=>{const a=setTimeout(()=>{f!==y&&w(f)},300);return()=>clearTimeout(a)},[f,y]);const V=a=>{x.current&&x.current.abort();const n=new AbortController;x.current=n,v(a.current,a.pageSize,n.signal)},M=()=>{g(null),S(!0)},N=a=>{g(a),S(!0)},L=async a=>{try{await m.deleteProduct(a),h.success("删除成功"),v(p.current,p.pageSize)}catch{h.error("删除失败")}},Q=()=>{S(!1),g(null),v(p.current,p.pageSize)},G=()=>{S(!1),g(null)},t=a=>{E(a?!0:void 0)},u=[{title:"产品名称",dataIndex:"name",key:"name",width:180},{title:"产品编码",dataIndex:"code",key:"code",width:120,render:a=>a||"-"},{title:"所属客户",key:"client",width:150,render:(a,n)=>n.client?.name||"-"},{title:"封装形式",key:"package_form",width:120,render:(a,n)=>n.package_form?.name||"-"},{title:"封装类型",key:"package_type",width:140,render:(a,n)=>n.package_type?.name||"-"},{title:"应用场景",key:"scenarios",width:200,render:(a,n)=>{const P=n.scenarios||[];return P.length===0?"-":e.jsx(O,{wrap:!0,size:[4,4],children:P.map(_=>e.jsx($,{color:_.color||"blue",children:_.name},_.id))})}},{title:"自定义信息",key:"custom_info",width:150,render:(a,n)=>{const P=n.custom_info||[];return P.length===0?"-":e.jsx(ne,{title:e.jsx("div",{children:P.map((_,ie)=>e.jsx("div",{children:_},ie))}),children:e.jsxs($,{color:"cyan",children:[P.length," 条信息"]})})}},{title:"状态",dataIndex:"is_active",key:"is_active",width:80,render:a=>e.jsx($,{color:a?"success":"default",children:a?"启用":"停用"})},{title:"操作",key:"action",width:120,fixed:"right",render:(a,n)=>e.jsxs(O,{size:"small",children:[e.jsx(F,{type:"link",size:"small",icon:e.jsx(te,{}),onClick:()=>N(n),children:"编辑"}),e.jsx(ae,{title:"确定删除此产品?",onConfirm:()=>L(n.id),okText:"确定",cancelText:"取消",children:e.jsx(F,{type:"link",size:"small",danger:!0,icon:e.jsx(se,{}),children:"删除"})})]})}];return e.jsxs("div",{children:[e.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between"},children:[e.jsxs(O,{wrap:!0,children:[e.jsx(I,{placeholder:"搜索产品名称或编码",prefix:e.jsx(U,{}),value:f,onChange:a=>T(a.target.value),style:{width:200},allowClear:!0}),e.jsx(D,{placeholder:"按客户筛选",style:{width:180},allowClear:!0,showSearch:!0,optionFilterProp:"label",value:k,onChange:s,options:d.map(a=>({label:a.name,value:a.id}))}),e.jsxs(O,{children:[e.jsx("span",{style:{fontSize:14,color:"#666"},children:"仅启用:"}),e.jsx(q,{checked:j===!0,onChange:t,size:"small"})]})]}),e.jsx(F,{type:"primary",icon:e.jsx(J,{}),onClick:M,children:"新增产品"})]}),e.jsx(ee,{columns:u,dataSource:c,rowKey:"id",loading:z,pagination:{...p,showSizeChanger:!0,showQuickJumper:!0,showTotal:a=>`共 ${a} 条`},onChange:V,scroll:{x:1400}}),e.jsx(ue,{visible:b,product:B,onSuccess:Q,onCancel:G})]})}const{TextArea:me}=I;function he(){const[c,r]=i.useState("package-forms"),[z,R]=i.useState([]),[b,S]=i.useState(!1),[B,g]=i.useState(!1),[p,A]=i.useState(null),[f,T]=i.useState({current:1,pageSize:50,total:0}),[y,w]=i.useState(""),[j,E]=i.useState(""),[k]=l.useForm(),s=i.useRef(!1),d=i.useRef(!0),{message:o}=H.useApp(),h=i.useCallback(async(t=1,u=50)=>{S(!0);try{let a;const n={page:t,page_size:u,search:j||void 0};switch(c){case"package-forms":a=await m.getPackageForms(n);break;case"package-types":a=await m.getPackageTypes(n);break;case"scenarios":a=await m.getScenarios(n);break;default:return}d.current&&(R(a.items),T({current:a.page,pageSize:a.page_size,total:a.total}),s.current=!1)}catch(a){W(a)||d.current&&!s.current&&(s.current=!0,o.error("获取配置列表失败"))}finally{d.current&&S(!1)}},[c,j,o]);i.useEffect(()=>(d.current=!0,()=>{d.current=!1}),[]),i.useEffect(()=>{w(""),E(""),h()},[c,h]),i.useEffect(()=>{h()},[j,h]),i.useEffect(()=>{const t=setTimeout(()=>{y!==j&&E(y)},300);return()=>clearTimeout(t)},[y,j]);const x=t=>{h(t.current||1,t.pageSize||50)},v=()=>{A(null),k.resetFields(),k.setFieldsValue({display_order:0,is_active:!0,is_default:!1,color:c==="scenarios"?"#1890ff":void 0}),g(!0)},V=t=>{A(t),k.setFieldsValue({name:t.name,code:t.code,display_order:t.display_order,description:t.description||"",color:"color"in t?t.color||"#1890ff":void 0,is_active:t.is_active,is_default:t.is_default}),g(!0)},M=async t=>{try{switch(c){case"package-forms":await m.deletePackageForm(t);break;case"package-types":await m.deletePackageType(t);break;case"scenarios":await m.deleteScenario(t);break}o.success("删除成功"),h(f.current,f.pageSize)}catch(u){const a=u&&typeof u=="object"&&"response"in u?u.response?.data?.detail:"删除失败";o.error(a||"删除失败")}},N=async()=>{try{const t=await k.validateFields();if(p){switch(c){case"package-forms":await m.updatePackageForm(p.id,t);break;case"package-types":await m.updatePackageType(p.id,t);break;case"scenarios":await m.updateScenario(p.id,t);break}o.success("更新成功")}else{switch(c){case"package-forms":await m.createPackageForm(t);break;case"package-types":await m.createPackageType(t);break;case"scenarios":await m.createScenario(t);break}o.success("创建成功")}g(!1),h(f.current,f.pageSize)}catch(t){if(t&&typeof t=="object"&&"errorFields"in t)return;o.error(p?"更新失败":"创建失败")}},L=()=>{switch(c){case"package-forms":return"封装形式";case"package-types":return"封装产品类型";case"scenarios":return"应用场景";default:return"配置项"}},Q=[{title:"名称",dataIndex:"name",key:"name",width:180,render:(t,u)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:["color"in u&&u.color&&e.jsx("span",{style:{display:"inline-block",width:12,height:12,borderRadius:2,backgroundColor:u.color}}),e.jsx("span",{children:t}),u.is_default&&e.jsx(ce,{style:{color:"#faad14"}})]})},{title:"代码",dataIndex:"code",key:"code",width:120},{title:"显示顺序",dataIndex:"display_order",key:"display_order",width:100},{title:"描述",dataIndex:"description",key:"description",render:t=>t||"-"},{title:"状态",dataIndex:"is_active",key:"is_active",width:80,render:t=>e.jsx($,{color:t?"success":"default",children:t?"启用":"停用"})},{title:"默认",dataIndex:"is_default",key:"is_default",width:80,render:t=>t?e.jsx($,{color:"warning",children:"默认"}):"-"},{title:"操作",key:"action",width:150,render:(t,u)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(F,{type:"link",size:"small",icon:e.jsx(te,{}),onClick:()=>V(u),children:"编辑"}),e.jsx(ae,{title:"确认删除",description:u.is_default?"默认配置无法删除":"确定要删除此配置项吗？",onConfirm:()=>M(u.id),okText:"确定",cancelText:"取消",children:e.jsx(F,{type:"link",size:"small",danger:!0,icon:e.jsx(se,{}),disabled:u.is_default,children:"删除"})})]})}],G=[{key:"package-forms",label:"封装形式"},{key:"package-types",label:"封装产品类型"},{key:"scenarios",label:"应用场景"}];return e.jsxs("div",{children:[e.jsx(X,{activeKey:c,onChange:r,items:G,style:{marginBottom:16}}),e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16},children:[e.jsx(I,{placeholder:"搜索名称或代码",prefix:e.jsx(U,{style:{color:"#999"}}),value:y,onChange:t=>w(t.target.value),style:{width:224},allowClear:!0}),e.jsxs(F,{type:"primary",icon:e.jsx(J,{}),onClick:v,children:["新增",L()]})]}),e.jsx(ee,{columns:Q,dataSource:z,rowKey:"id",loading:b,pagination:{current:f.current,pageSize:f.pageSize,total:f.total,showSizeChanger:!0,showQuickJumper:!0,showTotal:t=>`共 ${t} 条`},onChange:x,scroll:{x:800}}),e.jsx(Z,{title:p?`编辑${L()}`:`新增${L()}`,open:B,onOk:N,onCancel:()=>g(!1),width:500,destroyOnHidden:!0,children:e.jsxs(l,{form:k,layout:"vertical",children:[e.jsx(l.Item,{name:"name",label:"名称",rules:[{required:!0,message:"请输入名称"}],children:e.jsx(I,{placeholder:"配置项名称"})}),e.jsx(l.Item,{name:"code",label:"代码",rules:[{required:!0,message:"请输入代码"}],children:e.jsx(I,{placeholder:"唯一代码，如: FC-BGA",disabled:!!p})}),e.jsxs(K,{gutter:16,children:[e.jsx(C,{span:12,children:e.jsx(l.Item,{name:"display_order",label:"显示顺序",children:e.jsx(de,{min:0,style:{width:"100%"}})})}),c==="scenarios"&&e.jsx(C,{span:12,children:e.jsx(l.Item,{name:"color",label:"颜色",children:e.jsx(I,{type:"color",style:{width:80,height:32,padding:0,border:"none"}})})})]}),e.jsx(l.Item,{name:"description",label:"描述",children:e.jsx(me,{rows:2,placeholder:"配置项说明"})}),e.jsxs(K,{gutter:16,children:[e.jsx(C,{span:12,children:e.jsx(l.Item,{name:"is_active",label:"状态",valuePropName:"checked",children:e.jsx(q,{checkedChildren:"启用",unCheckedChildren:"停用"})})}),e.jsx(C,{span:12,children:e.jsx(l.Item,{name:"is_default",label:"设为默认",valuePropName:"checked",children:e.jsx(q,{})})})]})]})})]})}function Ce(){const[c,r]=i.useState("products"),z=[{key:"products",label:e.jsxs("span",{children:[e.jsx(re,{}),"产品清单管理"]}),children:e.jsx(pe,{})},{key:"config",label:e.jsxs("span",{children:[e.jsx(le,{}),"产品属性配置"]}),children:e.jsx(he,{})}];return e.jsx(X,{activeKey:c,onChange:r,items:z,size:"large",style:{marginTop:-16}})}export{Ce as default};
